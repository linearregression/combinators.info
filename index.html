<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="Kestrels, Quirky Birds, and Hopeless Egocentricity" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/leanpub.css">
    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Kestrels, Quirky Birds, and Hopeless Egocentricity</title>
  </head>

  <body>

    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/combinators-info">View on GitHub</a>

          <h1 id="project_title">combinators.info</h1>
          <h2 id="project_tagline"></h2>

        </header>
    </div>

    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>Kestrels, Quirky Birds,<br/>and Hopeless Egocentricity</h1>

<iframe style="float:right;margin-left:20px;margin-bottom:20px;" width="160" height="400" src="https://leanpub.com/combinators/embed" frameborder="0" allowtransparency="true"></iframe>

<p>The road to this web site began when I first applied ideas from Combinatory Logic to my daily programming. Combinatory Logic is a fascinating subject in its own right, and stands beside the Lambda Calculus as one of the foundations of Computer Science.</p>

<p>In addition to being a powerful theoretical basis for reasoning about computers, it's chock full of ideas that are surprisingly practical for day-to-day programming.</p>

<h3>my book</h3>

<p>I've blogged about some of the applications of Combinatory Logic to my Ruby programming, and many of them were featured on /r/programming and/or Hacker News. More than a few people suggested I write a book about combinators in Ruby, so I adapted the blog posts into a convenient and portable <a href="https://leanpub.com/combinators" title="PDF, ibook, and mobi formats">ebook</a>.</p>

<p><a href="#book"><b>Read the entire text online</b></a>. It's covered by <a href="http://www.opensource.org/licenses/mit-license.php">The MIT License</a>, so feel free to deep link, copy, and share.</p>

<h3>more about combinatory logic</h3>

<ul>
  <li><a href="http://www.amazon.com/gp/product/B00A1P096Y/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=B00A1P096Y&linkCode=as2&tag=raganwald001-20">To Mock a Mockingbird</a> by Raymond Smullyan, the best book ever written about Combinatory Logic.</li>
  <li><a href="http://plato.stanford.edu/entries/logic-combinatory/">Combinatory Logic</a> in the Stanford Encyclopedia of Philosophy.</li>
  <li><a href="https://en.wikipedia.org/wiki/Combinatory_logic">Combinatory Logic</a> in Wikipedia.</li>
  <li>Bruno Marchal's <a href="https://github.com/raganwald/homoiconic/blob/master/2008-11-12/combinator_chemistry.md">Combinator Chemistry</a>.</li>
  <li>Chris Rathman's <a href="http://www.angelfire.com/tx4/cus/combinator/birds.html">Taxonomy of Combinator Birds</a>.</li>
  <li><a href="http://users.bigpond.net.au/d.keenan/Lambda/index.htm">To Dissect a Mockingbird</a>.</li>
  <li><a href="http://users.bigpond.net.au/d.keenan/Lambda/index.htm">Lambda the Ultimate discussion on learning Combinatory Logic.</a></li>
</ul>

<p>And three more technical papers (links and notes courtesy of <a href="http://news.ycombinator.com/user?id=bediger4000">bediger4000</a>):</p>

<ul>
  <li>John Tromp's paper <a href="http://homepages.cwi.nl/~tromp/cl/LC.pdf">Binary Lambda Calculus and Combinatory Logic</a> is a genuine classic.</li>
  <li>Henk Barendregdt's <a href="http://repository.ubn.ru.nl/handle/2066/17290">Juggling With Combinators</a> shows you a lot of interesting things you can do with Combinatory Logic.</li>
  <li>Barendregdt's <a href="ftp://ftp.cs.kun.nl/pub/CompMath.Found/biologen.pdf">Reflection and its use</a> has a small, but interesting section on Combinatory Logic. The exercises include finding a CL term that Barendregdt calls an "Ogre", same as Smullyan's Hopelessly Egocentric bird.</li>
</ul>

<h3>and the blog posts</h3>

<p>Here are the blog posts that started it all: <a href="http://github.com/raganwald/homoiconic/tree/master/2008-10-29/kestrel.markdown#readme">Kestrels</a>, <a href="http://github.com/raganwald/homoiconic/tree/master/2008-10-30/thrush.markdown#readme">The Thrush</a>, <a href="http://github.com/raganwald/homoiconic/tree/master/2008-10-31/songs_of_the_cardinal.markdown#readme">Songs of the Cardinal</a>, <a href="http://github.com/raganwald/homoiconic/tree/master/2008-11-04/quirky_birds_and_meta_syntactic_programming.markdown#readme">Quirky Birds and Meta-Syntactic Programming</a>, <a href="http://github.com/raganwald/homoiconic/tree/master/2008-11-07/from_birds_that_compose_to_method_advice.markdown#readme">Aspect-Oriented Programming in Ruby using Combinator Birds</a>, <a href="http://github.com/raganwald/homoiconic/tree/master/2008-11-12/the_obdurate_kestrel.md#readme">The Enchaining and Obdurate Kestrels</a>, <a href="http://github.com/raganwald/homoiconic/tree/master/2008-11-16/joy.md#readme">Finding Joy in Combinators</a>, <a href="http://github.com/raganwald/homoiconic/tree/master/2008-11-23/recursive_combinators.md#readme">Refactoring Methods with Recursive Combinators</a>, <a href="http://github.com/raganwald/homoiconic/tree/master/2008-11-26/practical_recursive_combinators.md#readme">Practical Recursive Combinators</a>, <a href="http://github.com/raganwald/homoiconic/tree/master/2009-02-02/hopeless_egocentricity.md#readme">The Hopelessly Egocentric Blog Post</a>, and <a href="http://github.com/raganwald/homoiconic/tree/master/2009-06-29/wrapping_combinators.md#readme">Wrapping Combinators</a>.</p>

<p>If you're looking for a place to start, the very first post, <a href="http://github.com/raganwald/homoiconic/tree/master/2008-10-29/kestrel.markdown#readme">Kestrels</a>, presumes no previous knowledge of combinators or advanced Ruby-fu. <a href="http://github.com/raganwald/homoiconic/tree/master/2008-11-16/joy.md#readme">Finding Joy in Combinators</a> was actually written in the middle, but it can be read at any time, it points towards <a href="http://en.wikipedia.org/wiki/Concatenative_programming_language">concatenative programming languages</a>, an interesting study area.</p>

<h2 id="book">Kestrels, Quirky Birds, and Hopeless Egocentricity</h2>

<p style="text-align:center;"><a href="http://leanpub.com/combinators" border="0"><img src="images/title_page_500.jpg"/></a></p>

<div id="leanpub-toc">
<h2>Table of Contents</h2>
<ol class="toc">
<li class="chapter"><a href="#introduction">Introduction</a></li>
<li class="chapter"><a href="#kestrels">Kestrels</a></li>
<li class="section"><a href="#object-initializer-blocks">Object initializer blocks</a></li>
<li class="section"><a href="#inside-an-idiomatic-ruby-kestrel">Inside, an idiomatic Ruby Kestrel</a></li>
<li class="section"><a href="#the-enchaining-kestrel">The Enchaining Kestrel</a></li>
<li class="section"><a href="#the-obdurate-kestrel">The Obdurate Kestrel</a></li>
<li class="section"><a href="#kestrels-on-rails">Kestrels on Rails</a></li>
<li class="section"><a href="#rewriting-returning-in-rails">Rewriting &#x201C;Returning&#x201D; in Rails</a></li>
<li class="chapter"><a href="#the-thrush">The Thrush</a></li>
<li class="section"><a href="#let">Let</a></li>
<li class="chapter"><a href="#songs-of-the-cardinal">Songs of the Cardinal</a></li>
<li class="section"><a href="#building-a-cardinal-in-ruby">Building a Cardinal in Ruby</a></li>
<li class="chapter"><a href="#quirky-birds-and-meta-syntactic-programming">Quirky Birds and Meta-Syntactic Programming</a></li>
<li class="section"><a href="#a-limited-interpretation-of-the-quirky-bird-in-ruby">A limited interpretation of the Quirky Bird in Ruby</a></li>
<li class="section"><a href="#embracing-the-quirky-bird">Embracing the Quirky Bird</a></li>
<li class="section"><a href="#andand-even-more">Andand even more</a></li>
<li class="chapter"><a href="#aspect-oriented-programming-in-ruby-using-combinator-birds">Aspect-Oriented Programming in Ruby using Combinator Birds</a></li>
<li class="section"><a href="#giving-methods-advice">Giving methods advice</a></li>
<li class="section"><a href="#the-super-keyword-perhaps-youve-heard-of-it">The super keyword, perhaps you&#x2019;ve heard of it?</a></li>
<li class="section"><a href="#the-queer-bird">The Queer Bird</a></li>
<li class="chapter"><a href="#mockingbirds">Mockingbirds</a></li>
<li class="section"><a href="#duplicative-combinators">Duplicative Combinators</a></li>
<li class="section"><a href="#recursive-lambdas-in-ruby">Recursive Lambdas in Ruby</a></li>
<li class="section"><a href="#recursive-combinatorics">Recursive Combinatorics</a></li>
<li class="section"><a href="#recursive-combinators-in-idiomatic-ruby">Recursive Combinators in Idiomatic Ruby</a></li>
<li class="section"><a href="#the-mockingbird">The Mockingbird</a></li>
<li class="chapter"><a href="#refactoring-methods-with-recursive-combinators">Refactoring Methods with Recursive Combinators</a></li>
<li class="section"><a href="#divide-and-conquer">Divide and Conquer</a></li>
<li class="section"><a href="#the-merge-sort">The Merge Sort</a></li>
<li class="section"><a href="#separating-declaration-from-implementation">Separating Declaration from Implementation</a></li>
<li class="section"><a href="#practical-recursive-combinators">Practical Recursive Combinators</a></li>
<li class="section"><a href="#spicing-things-up">Spicing things up</a></li>
<li class="section"><a href="#building-on-a-legacy">Building on a legacy</a></li>
<li class="section"><a href="#seriously">Seriously</a></li>
<li class="section"><a href="#separating-implementation-from-declaration">Separating Implementation from Declaration</a></li>
<li class="section"><a href="#a-really-simple-recursive-combinator">A Really Simple Recursive Combinator</a></li>
<li class="chapter"><a href="#you-cant-be-serious">You can&#x2019;t be serious!?</a></li>
<li class="section"><a href="#string-to-proc">String to Proc</a></li>
<li class="section"><a href="#the-message">The Message</a></li>
<li class="chapter"><a href="#the-hopelessly-egocentric-book-chapter">The Hopelessly Egocentric Book Chapter</a></li>
<li class="section"><a href="#object-oriented-egocentricity">Object-oriented egocentricity</a></li>
<li class="chapter"><a href="#bonus-chapter-separating-concerns-in-coffeescript-using-aspect-oriented-programming">Bonus Chapter: Separating Concerns in Coffeescript using Aspect-Oriented Programming</a></li>
<li class="chapter"><a href="#appendix-finding-joy-in-combinators">Appendix: Finding Joy in Combinators</a></li>
<li class="section"><a href="#languages-for-combinatorial-logic">Languages for combinatorial logic</a></li>
<li class="section"><a href="#concatenative-languages">Concatenative languages</a></li>
<li class="chapter"><a href="#appendix-source-code">Appendix: Source Code</a></li>
<li class="section"><a href="#kestrels-1">kestrels</a></li>
<li class="section"><a href="#thrushes">thrushes</a></li>
<li class="section"><a href="#the-cardinal">the cardinal</a></li>
<li class="section"><a href="#quirky-birds">quirky birds</a></li>
<li class="section"><a href="#bluebirds">bluebirds</a></li>
</ol>
</div>

<!-- begin mainmatter -->

<h2 section-num="1" id="introduction">Introduction</h2>

<p>Like the Lambda Calculus, <a href="http://en.wikipedia.org/wiki/Combinatory_logic">Combinatory Logic</a> is a mathematical notation that is powerful enough to handle set theory and issues in computability.</p>

<blockquote>
  <p>Combinatory logic is a notation introduced by <a href="http://en.wikipedia.org/wiki/Moses_Schönfinkel">Moses Sch&ouml;nfinkel</a> and <a href="http://en.wikipedia.org/wiki/Haskell_Curry">Haskell Curry</a> to eliminate the need for variables in mathematical logic. It has more recently been used in computer science as a theoretical model of computation and also as a basis for the design of functional programming languages. It is based on combinators. A combinator is a higher-order function that uses only function application and earlier defined combinators to define a result from its arguments.</p>
</blockquote>

<p>In this book, we&rsquo;re going to meet some of the standard combinators, and for each one we&rsquo;ll explore some of its ramifications when writing programs using the Ruby programming language. In Combinatory logic, combinators combine and alter each other, and our Ruby examples will focus on combining and altering Ruby code. From simple examples like the K Combinator and Ruby&rsquo;s <code>.tap</code> method, we&rsquo;ll work our way up to meta-programming with aspects and recursive combinators.</p>

<p><strong>about the bird names</strong></p>

<p>When Combinatory Logic was first invented by Haskell Curry, the standard combinators were given upper-case letters. For example, the two combinators needed to express everything in the Lambda Calculus and in Set Theory are the <code>S</code> and <code>K</code> combinators. In 1985, Raymond Smullyan published <a href="http://en.wikipedia.org/wiki/To_Mock_a_Mockingbird">To Mock a Mockingbird</a>, an exploration of combinatory logic for the recreational layman. Smullyan used a forest full of songbirds as a metaphor, with each of the combinators given the name of a songbird rather than a single letter. For example, the <code>S</code> and <code>K</code> combinators became the Starling and Kestrel, the <code>I</code> combinator became the Idiot bird, and so forth.</p>

<p>These ornithological nicknames have become part of the standard lexicon for combinatory logic.</p>

<p><strong>thanks</strong></p>

<p>There are too many people to name,but amongst the crowd, Alan Smith stands out.</p>

<h2 section-num="2" id="kestrels">Kestrels</h2>

<p>In Combinatory Logic, a Kestrel (or &ldquo;K Combinator&rdquo;) is a function that returns a constant function, normally written <code>Kxy = x</code>. In Ruby, it might look like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c"># for *any* x,</code>
<code class="n">kestrel</code><code class="p">.</code><code class="n">call</code><code class="p">(:</code><code class="n">foo</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">:</code><code class="n">foo</code>
</pre></div>

</div>

<p>Kestrels are to be found in Ruby. You may be familiar with their Ruby 1.9 name, <code>#tap</code>. Let&rsquo;s say you have a line like <code>address = Person.find(...).address</code> and you wish to log the person instance. With <code>tap</code>, you can inject some logging into the expression without messy temporary variables:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">address</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="nb">find</code><code class="p">(...).</code><code class="n">tap</code> <code class="p">{</code> <code class="o">|</code><code class="n">p</code><code class="o">|</code> <code class="n">logger</code><code class="p">.</code><code class="nb">log</code> &quot;<code class="n">person</code> #<code class="p">{</code><code class="n">p</code><code class="p">}</code> <code class="n">found</code>&quot; <code class="p">}.</code><code class="n">addre</code><code class="o">\</code>
<code class="n">ss</code>
</pre></div>

</div>

<p><code>tap</code> is a method in all objects that passes <code>self</code> to a block and returns self, ignoring whatever the last item of the block happens to be. Ruby on Rails programmers will recognize the Kestrel in slightly different form:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">address</code> <code class="p">=</code> <code class="n">returning</code> <code class="n">Person</code><code class="p">.</code><code class="nb">find</code><code class="p">(...)</code> <code class="n">do</code> <code class="o">|</code><code class="n">p</code><code class="o">|</code>
  <code class="n">logger</code><code class="p">.</code><code class="nb">log</code> &quot;<code class="n">person</code> #<code class="p">{</code><code class="n">p</code><code class="p">}</code> <code class="n">found</code>&quot;
<code class="k">end</code><code class="p">.</code><code class="n">address</code>
</pre></div>

</div>

<p>Again, the result of the block is discarded, it is only there for side effects. This behaviour is the same as a Kestrel. Remember <code>kestrel.call(:foo).call(x)</code>? If I rewrite it like this, you can see the similarity:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Kestrel</code><code class="p">.</code><code class="n">call</code><code class="p">(:</code><code class="n">foo</code><code class="p">)</code> <code class="n">do</code>
  <code class="n">x</code>
<code class="k">end</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">:</code><code class="n">foo</code>
</pre></div>

</div>

<p>Both <code>returning</code> and <code>tap</code> are handy for grouping side effects together. Methods that look like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">person</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code>
  <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
  <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
  <code class="n">person</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Can be rewritten using <code>returning</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">returning</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code> <code class="n">do</code> <code class="o">|</code><code class="n">person</code><code class="o">|</code>
    <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
    <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>It is obvious from the first line what will be returned and it eliminates an annoying error when the programmer neglects to make <code>person</code> the last line of the method.</p>

<h3 section-num="2.1" id="object-initializer-blocks">Object initializer blocks</h3>

<p>The Kestrel has also been sighted in the form of <em>object initializer blocks</em>. Consider this example using <a href="http://blog.grayproductions.net/articles/all_about_struct" title="All about Struct">Struct</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Contact</code> <code class="p">=</code> <code class="n">Struct</code><code class="p">.</code><code class="n">new</code><code class="p">(:</code><code class="n">first</code><code class="p">,</code> <code class="p">:</code><code class="n">last</code><code class="p">,</code> <code class="p">:</code><code class="n">email</code><code class="p">)</code> <code class="n">do</code>
  <code class="n">def</code> <code class="n">to_hash</code>
    <code class="n">Hash</code><code class="p">[</code><code class="o">*</code><code class="n">members</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">values</code><code class="p">).</code><code class="n">flatten</code><code class="p">]</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>The method <code>Struct#new</code> creates a new class. It also accepts an optional block, evaluating the block for side effects only. It returns the new class regardless of what happens to be in the block (it happens to evaluate the block in class scope, a small refinement).</p>

<p>You can use this technique when writing your own classes:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Bird</code> <code class="o">&lt;</code> <code class="n">Creature</code>
  <code class="n">def</code> <code class="n">initialize</code><code class="p">(</code><code class="o">*</code><code class="n">params</code><code class="p">)</code>
    # <code class="n">do</code> <code class="n">something</code> <code class="n">with</code> <code class="n">the</code> <code class="n">params</code>
    <code class="n">yield</code> <code class="n">self</code> <code class="k">if</code> <code class="n">block_given</code>?
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">Forest</code><code class="p">.</code><code class="n">add</code><code class="p">(</code>
  <code class="n">Bird</code><code class="p">.</code><code class="n">new</code><code class="p">(:</code><code class="n">name</code> <code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;</code><code class="err">Kestrel) { |k| combinators &lt;&lt; k }</code>
<code class="p">)</code>
</pre></div>

</div>

<p>The pattern of wanting a Kestrel/returning/tap when you create a new object is so common that building it into object initialization is useful. And in fact, it&rsquo;s built into <code>ActiveRecord</code>. Methods like <code>new</code> and <code>create</code> take optional blocks, so you can write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Person</code> <code class="o">&lt;</code> <code class="n">ActiveRecord</code><code class="p">::</code><code class="n">Base</code>
  # <code class="p">...</code>
<code class="k">end</code>

<code class="n">def</code> <code class="n">registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code> <code class="n">do</code> <code class="o">|</code><code class="n">person</code><code class="o">|</code>
    <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
    <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>In Rails, <code>returning</code> is not necessary when creating instances of your model classes, thanks to ActiveRecord&rsquo;s built-in object initializer blocks.</p>

<h3 section-num="2.2" id="inside-an-idiomatic-ruby-kestrel">Inside, an idiomatic Ruby Kestrel</h3>

<p>When we discussed <code>Struct</code> above, we noted that its initializer block has a slightly different behaviour than <code>tap</code> or <code>returning</code>. It takes an initializer block, but it doesn&rsquo;t pass the new class to the block as a parameter, it evaluates the block in the context of the new class.</p>

<p>Putting this into implementation terms, it evaluates the block with <code>self</code> set to the new class. This is not the same as <code>returning</code> or <code>tap</code>, both of which leave <code>self</code> untouched. We can write our own version of <code>returning</code> with the same semantics. We will call it <code>inside</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">module</code> <code class="n">Kernel</code>

  <code class="n">def</code> <code class="n">inside</code><code class="p">(</code><code class="n">value</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">block</code><code class="p">)</code>
    <code class="n">value</code><code class="p">.</code><code class="n">instance_eval</code><code class="p">(</code><code class="o">&amp;</code><code class="n">block</code><code class="p">)</code>
    <code class="n">value</code>
  <code class="k">end</code>

<code class="k">end</code>
</pre></div>

</div>

<p>You can use this variation on a Kestrel just like <code>returning</code>, only you do not need to specify a parameter:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">inside</code> <code class="p">[</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">]</code> <code class="n">do</code>
  <code class="n">uniq</code>!
<code class="k">end</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">]</code>
</pre></div>

</div>

<p>This isn&rsquo;t particularly noteworthy. Of more interest is your access to private methods and instance variables:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">sna</code> <code class="p">=</code> <code class="n">Struct</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="s">&#39;Fubar&#39;</code><code class="p">)</code> <code class="n">do</code>
  <code class="n">attr_reader</code> <code class="p">:</code><code class="n">fu</code>
<code class="k">end</code><code class="p">.</code><code class="n">new</code>

<code class="n">inside</code><code class="p">(</code><code class="n">sna</code><code class="p">)</code> <code class="n">do</code>
  <code class="p">@</code><code class="n">fu</code> <code class="p">=</code> <code class="s">&#39;bar&#39;</code>
<code class="k">end</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="o">&lt;</code><code class="n">struct</code> <code class="n">Struct</code><code class="p">::</code><code class="n">Fubar</code> <code class="o">&gt;</code>

<code class="n">sna</code><code class="p">.</code><code class="n">fu</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;bar&#39;</code>
</pre></div>

</div>

<p><code>inside</code> is a Kestrel just like <code>returning</code>. No matter what value its block generates, it returns its primary argument. The only difference between the two is the evaluation environment of the block.</p>

<h3 section-num="2.3" id="the-enchaining-kestrel">The Enchaining Kestrel</h3>

<p>In <strong>Kestrels</strong>, we looked at <code>#tap</code> from Ruby 1.9 and <code>returning</code> from Ruby on Rails. No we&rsquo;ll going to look at another use for <code>tap</code>. As already explained, Ruby 1.9 includes the new method <code>Object#tap</code>. It passes the receiver to a block, then returns the receiver no matter what the block contains. The canonical example inserts some logging in the middle of a chain of method invocations:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">address</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="nb">find</code><code class="p">(...).</code><code class="n">tap</code> <code class="p">{</code> <code class="o">|</code><code class="n">p</code><code class="o">|</code> <code class="n">logger</code><code class="p">.</code><code class="nb">log</code> &quot;<code class="n">person</code> #<code class="p">{</code><code class="n">p</code><code class="p">}</code> <code class="n">found</code>&quot; <code class="p">}.</code><code class="n">addre</code><code class="o">\</code>
<code class="n">ss</code>
</pre></div>

</div>

<p><code>Object#tap</code> is also useful when you want to execute several method on the same object without having to create a lot of temporary variables, a practice Martin Fowler calls [Method Chaining](http://martinfowler.com/dslwip/MethodChaining.html &ldquo;&rdquo;). Typically, you design such an object so that it returns itself in response to every modifier message. This allows you to write things like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">HardDrive</code><code class="p">.</code><code class="n">new</code><code class="p">.</code><code class="n">capacity</code><code class="p">(</code>150<code class="p">).</code><code class="n">external</code><code class="p">.</code><code class="n">speed</code><code class="p">(</code>7200<code class="p">)</code>
</pre></div>

</div>

<p>Instead of:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">hd</code> <code class="p">=</code> <code class="n">HardDrive</code><code class="p">.</code><code class="n">new</code>
<code class="n">hd</code><code class="p">.</code><code class="n">capacity</code> <code class="p">=</code> 150
<code class="n">hd</code><code class="p">.</code><code class="n">external</code> <code class="p">=</code> <code class="n">true</code>
<code class="n">hd</code><code class="p">.</code><code class="n">speed</code> <code class="p">=</code> 7200
</pre></div>

</div>

<p>And if you are a real fan of the Kestrel, you would design your class with an object initializer block so you could write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">hd</code> <code class="p">=</code> <code class="n">HardDrive</code><code class="p">.</code><code class="n">new</code> <code class="n">do</code>
  <code class="p">@</code><code class="n">capacity</code> <code class="p">=</code> 150
  <code class="p">@</code><code class="n">external</code> <code class="p">=</code> <code class="n">true</code>
  <code class="p">@</code><code class="n">speed</code> <code class="p">=</code> 7200
<code class="k">end</code>
</pre></div>

</div>

<p>But what do you do when handed a class that was not designed with method chaining in mind? For example, <code>Array#pop</code> returns the object being popped, not the array. Before you validate every criticism levelled against Ruby for allowing programmers to rewrite methods in core classes, consider using <code>#tap</code> with <code>Symbol#to_proc</code> or <code>String#to_proc</code> to chain methods without rewriting them.</p>

<p>So instead of</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">fizz</code><code class="p">(</code><code class="n">arr</code><code class="p">)</code>
  <code class="n">arr</code><code class="p">.</code><code class="n">pop</code>
  <code class="n">arr</code><code class="p">.</code><code class="n">map</code>! <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">*</code> 2 <code class="p">}</code>
<code class="k">end</code>
</pre></div>

</div>

<p>We can write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">fizz</code><code class="p">(</code><code class="n">arr</code><code class="p">)</code>
  <code class="n">arr</code><code class="p">.</code><code class="n">tap</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="n">pop</code><code class="p">).</code><code class="n">map</code>! <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">*</code> 2 <code class="p">}</code>
<code class="k">end</code>
</pre></div>

</div>

<p>I often use <code>#tap</code> to enchain methods for those pesky array methods that sometimes do what you expect and sometimes don&rsquo;t. My most hated example is <a href="http://ruby-doc.org/core/classes/Array.html#M002238" title="Class: Array"><code>Array#uniq!</code></a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">arr</code> <code class="p">=</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">]</code>
<code class="n">arr</code><code class="p">.</code><code class="n">uniq</code><code class="p">,</code> <code class="n">arr</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">],</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">]</code>
<code class="n">arr</code> <code class="p">=</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">]</code>
<code class="n">arr</code><code class="p">.</code><code class="n">uniq</code>!<code class="p">,</code> <code class="n">arr</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">],</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">]</code>
<code class="n">arr</code> <code class="p">=</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">]</code>
<code class="n">arr</code><code class="p">.</code><code class="n">uniq</code><code class="p">,</code> <code class="n">arr</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">],</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">]</code>
<code class="n">arr</code> <code class="p">=</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">]</code>
<code class="n">arr</code><code class="p">.</code><code class="n">uniq</code>!<code class="p">,</code> <code class="n">arr</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code><code class="p">,</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">]</code>
</pre></div>

</div>

<p>Let&rsquo;s replay that last one in slow motion:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code>  1<code class="p">,</code>  2<code class="p">,</code>  3<code class="p">,</code>  4<code class="p">,</code>  5  <code class="p">].</code><code class="n">uniq</code>!
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>That might be a problem. For example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">].</code><code class="n">uniq</code>!<code class="p">.</code><code class="n">sort</code>!
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">NoMethodError</code><code class="p">:</code> <code class="n">undefined</code> <code class="n">method</code> `<code class="n">sort</code>!<code class="s">&#39;</code><code class="err"> for nil:NilClass</code>
</pre></div>

</div>

<p><code>Object#tap</code> to the rescue: When using a method like <code>#uniq!</code> that modifies the array in place and sometimes returns the modified array but sometimes helpfully returns <code>nil</code>, I can use <code>#tap</code> to make sure I always get the array, which allows me to enchain methods:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">].</code><code class="n">tap</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="n">uniq</code>!<code class="p">).</code><code class="n">sort</code>!
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">,</code>5<code class="p">]</code>
</pre></div>

</div>

<p>So there&rsquo;s another use for <code>#tap</code> (along with <code>Symbol#to_proc</code> for simple cases): We can use it when we want to enchain methods, but the methods do not return the receiver.</p>

<blockquote>
  <p>In Ruby 1.9, <code>#tap</code> works exactly as described above. Ruby 1.8 does not have <code>#tap</code>, but you can obtain it by installing the andand gem. This version of <code>#tap</code> also works like a Quirky Bird, so you can write things like <code>HardDrive.new.tap.capacity(150)</code> for enchaining methods that take parameters and/or blocks. To get andand, <code>sudo gem install andand</code>. Rails users can also drop <code>andand.rb</code> in <code>config/initializers</code>.</p>
</blockquote>

<h3 section-num="2.4" id="the-obdurate-kestrel">The Obdurate Kestrel</h3>

<p>The <a href="http://github.com/raganwald/andand/tree" title="raganwald's andand">andand gem</a> includes <code>Object#tap</code> for Ruby 1.8. It also includes another kestrel called <code>#dont</code>. Which does what it says, or rather <em>doesn&rsquo;t</em> do what it says.</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">:</code><code class="n">foo</code><code class="p">.</code><code class="n">tap</code> <code class="p">{</code> <code class="n">p</code> <code class="s">&#39;bar&#39;</code> <code class="p">}</code>
<code class="n">bar</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">:</code><code class="n">foo</code> # <code class="n">printed</code> <code class="s">&#39;bar&#39;</code> <code class="n">before</code> <code class="n">returning</code> <code class="n">a</code> <code class="n">value</code>!

<code class="p">:</code><code class="n">foo</code><code class="p">.</code><code class="n">dont</code> <code class="p">{</code> <code class="n">p</code> <code class="s">&#39;bar&#39;</code> <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">:</code><code class="n">foo</code> # <code class="n">without</code> <code class="n">printing</code> <code class="s">&#39;bar&#39;</code>!
</pre></div>

</div>

<p><code>Object#dont</code> simply ignores the block passed to it. So what is it good for? Well, remember our logging example for <code>#tap</code>?</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">address</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="nb">find</code><code class="p">(...).</code><code class="n">tap</code> <code class="p">{</code> <code class="o">|</code><code class="n">p</code><code class="o">|</code> <code class="n">logger</code><code class="p">.</code><code class="nb">log</code> &quot;<code class="n">person</code> #<code class="p">{</code><code class="n">p</code><code class="p">}</code> <code class="n">found</code>&quot; <code class="p">}.</code><code class="n">addre</code><code class="o">\</code>
<code class="n">ss</code>
</pre></div>

</div>

<p>Let&rsquo;s turn the logging off for a moment:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">address</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="nb">find</code><code class="p">(...).</code><code class="n">dont</code> <code class="p">{</code> <code class="o">|</code><code class="n">p</code><code class="o">|</code> <code class="n">logger</code><code class="p">.</code><code class="nb">log</code> &quot;<code class="n">person</code> #<code class="p">{</code><code class="n">p</code><code class="p">}</code> <code class="n">found</code>&quot; <code class="p">}.</code><code class="n">addr</code><code class="o">\</code>
<code class="n">ess</code>
</pre></div>

</div>

<p>And back on:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">address</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="nb">find</code><code class="p">(...).</code><code class="n">tap</code> <code class="p">{</code> <code class="o">|</code><code class="n">p</code><code class="o">|</code> <code class="n">logger</code><code class="p">.</code><code class="nb">log</code> &quot;<code class="n">person</code> #<code class="p">{</code><code class="n">p</code><code class="p">}</code> <code class="n">found</code>&quot; <code class="p">}.</code><code class="n">addre</code><code class="o">\</code>
<code class="n">ss</code>
</pre></div>

</div>

<p>I typically use it when doing certain kinds of primitive debugging. And it has another trick up its sleeve:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">arr</code><code class="p">.</code><code class="n">dont</code><code class="p">.</code><code class="n">sort</code>!
</pre></div>

</div>

<p>Look at that, it works with method calls like a quirky bird! So you can use it to <code>NOOP</code> methods. Now, you could have done that with <code>Symbol#to_proc</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">arr</code><code class="p">.</code><code class="n">dont</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="n">sort</code>!<code class="p">)</code>
</pre></div>

</div>

<p>But what about methods that take parameters and blocks?</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">JoinBetweenTwoModels</code><code class="p">.</code><code class="n">dont</code><code class="p">.</code><code class="n">create</code>!<code class="p">(...)</code> <code class="n">do</code> <code class="o">|</code><code class="n">new_join</code><code class="o">|</code>
  # <code class="p">...</code>
<code class="k">end</code>
</pre></div>

</div>

<p><code>Object#dont</code> is the Ruby-semantic equivalent of commenting out a method call, only it can be inserted inside of an existing expression. That&rsquo;s why it&rsquo;s called the <em>obdurate kestrel</em>. It refuses to do anything!</p>

<p>If you want to try <code>Object#dont</code>, or want to use <code>Object#tap</code> with Ruby 1.8, <code>sudo gem install andand</code>. Rails users can also drop <code>andand.rb</code> in <code>config/initializers</code> as mentioned above. Enjoy!</p>

<h3 section-num="2.5" id="kestrels-on-rails">Kestrels on Rails</h3>

<p>As mentioned, Ruby on Rails provides #returning, a method with K Combinator semantics:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">returning</code><code class="p">(</code><code class="n">expression</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">name</code><code class="o">|</code>
  # <code class="n">name</code> <code class="n">is</code> <code class="n">bound</code> <code class="n">to</code> <code class="n">the</code> <code class="n">result</code> <code class="n">of</code> <code class="n">evaluating</code> <code class="n">expression</code>
  # <code class="n">this</code> <code class="n">block</code> <code class="n">is</code> <code class="n">evaluated</code> <code class="n">and</code> <code class="n">the</code> <code class="n">result</code> <code class="n">is</code> <code class="n">discarded</code>
<code class="k">end</code>
  <code class="p">=</code><code class="o">&gt;</code> # <code class="n">the</code> <code class="n">result</code> <code class="n">of</code> <code class="n">evaluating</code> <code class="n">the</code> <code class="n">expression</code> <code class="n">is</code> <code class="n">now</code> <code class="n">returned</code>
</pre></div>

</div>

<p>Rails also provides <em>object initializer blocks</em> for ActiveRecord models. Here&rsquo;s an example from one of my unit tests:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">@</code><code class="n">board</code> <code class="p">=</code> <code class="n">Board</code><code class="p">.</code><code class="n">create</code><code class="p">(:</code><code class="n">dimension</code> <code class="p">=</code><code class="o">&gt;</code> 9<code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">b</code><code class="o">|</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;aa&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;black&#39;</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;bb&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;black&#39;</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;cb&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;black&#39;</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;da&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;black&#39;</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;ba&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;white&#39;</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;ca&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;white&#39;</code>
<code class="k">end</code>
</pre></div>

</div>

<p>So, it looks like in Rails you can choose between an object initializer block and #returning:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">@</code><code class="n">board</code> <code class="p">=</code> <code class="n">returning</code><code class="p">(</code><code class="n">Board</code><code class="p">.</code><code class="n">create</code><code class="p">(:</code><code class="n">dimension</code> <code class="p">=</code><code class="o">&gt;</code> 9<code class="p">))</code> <code class="n">do</code> <code class="o">|</code><code class="n">b</code><code class="o">|</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;aa&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;black&#39;</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;bb&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;black&#39;</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;cb&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;black&#39;</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;da&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;black&#39;</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;ba&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;white&#39;</code>
  <code class="n">b</code><code class="p">[</code><code class="s">&#39;ca&#39;</code><code class="p">]</code> <code class="p">=</code> <code class="s">&#39;white&#39;</code>
<code class="k">end</code>
</pre></div>

</div>

<p>In both cases the created object is returned regardless of what the block would otherwise return. But beyond that, the two Kestrels have very different semantics. &ldquo;Returning&rdquo; fully evaluates the expression, in this case creating the model instance in its entirety, including all of its callbacks. The object initializer block, on the other hand, is called as part of initializing the object <em>before</em> starting the lifecycle of the object including its callbacks.</p>

<p>&ldquo;Returning&rdquo; is what you want when you want to do stuff involving the fully created object and you are trying to logically group the other statements with the creation. In my case, that&rsquo;s what I want, I am trying to say that @board is a board with black stones on certain intersections and white stones on other intersections.</p>

<p>Object initialization is what you want when you want to initialize certain fields by hand and perform some calculations or logic before kicking off the object creation lifecycle. That wasn&rsquo;t what I wanted in this case because my <code>[]=</code> method depended on the object being initialized. So my code had a bug that was fixed when I changed from object initializers to #returning.</p>

<p>Summary: In Rails, object initializers are evaluated before the object&rsquo;s life cycle is started, #returning&rsquo;s block is evaluated afterwards. And that is today&rsquo;s <em>lingua obscura</em>.</p>

<h3 section-num="2.6" id="rewriting-returning-in-rails">Rewriting &ldquo;Returning&rdquo; in Rails</h3>

<p>One of the most useful tools provided by Ruby on Rails is the #returning method, a simple but very useful implementation of the K Combinator or Kestrel. For example, this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">person</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code>
  <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
  <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
  <code class="n">person</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Can and should be expressed using #returning as this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">returning</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code> <code class="n">do</code> <code class="o">|</code><code class="n">person</code><code class="o">|</code>
    <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
    <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Why? Firstly, you avoid the common bug of forgetting to return the object you are creating:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">broken_registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">person</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code>
  <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
  <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
<code class="k">end</code>
</pre></div>

</div>

<p>This creates the person object and does the initialization you want, but doesn&rsquo;t actually return it from the method, it returns whatever #send_email_notification happens to return. If you&rsquo;ve worked hard to create fluent interfaces you might be correct by accident, but #send_email_notification could just as easily return the email it creates. Who knows?</p>

<p>Second, in methods like this as you read from top to bottom you are declaring what the method returns right up front:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">returning</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code> <code class="n">do</code> # <code class="p">...</code>
    # <code class="p">...</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>It takes some optional params and returns a new person. Very clear. And the third reason I like #returning is that it logically clusters the related statements together:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">returning</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code> <code class="n">do</code> <code class="o">|</code><code class="n">person</code><code class="o">|</code>
  <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
  <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
<code class="k">end</code>
</pre></div>

</div>

<p>It is very clear that these statements are all part of one logical block. As a bonus, my IDE respects that and it&rsquo;s easy to fold them or drag them around as a single unit. All in all, I think #returning is a big win and I even look for opportunities to refactor existing code to use it whenever I&rsquo;m making changes.</p>

<p><strong>DWIM</strong></p>

<p>All that being said, I have observed a certain bug or misapplication of #returning from time to time. It&rsquo;s usually pretty subtle in production code, but I&rsquo;ll make it obvious with a trivial example. What does this snippet evaluate to?</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">returning</code> <code class="p">[</code>1<code class="p">]</code> <code class="n">do</code> <code class="o">|</code><code class="n">numbers</code><code class="o">|</code>
  <code class="n">numbers</code> <code class="o">&lt;&lt;</code> 2
  <code class="n">numbers</code> <code class="o">+</code><code class="p">=</code> <code class="p">[</code>3<code class="p">]</code>
<code class="k">end</code>
</pre></div>

</div>

<p>This is the kind of thing that sadistic interviewers use in coding quizzes. The answer is <strong>[1, 2]</strong>, not [1, 2, 3]. The <code>&lt;&lt;</code> operator mutates the value assigned to the numbers variable, but the <code>+=</code> statement overwrites the reference assigned to the numbers variable without changing the original value. #returning remembers the <em>value</em> originally assigned to numbers and returns it. If you have some side-effects on that value, those count. But assignment does nothing to the value.</p>

<p>This may seem obvious, but in my experience it is a subtle point that causes difficulty. Languages with referential transparency escape the confusion entirely, but OO languages like Ruby have this weird thing where we have to keep track of references and labels on references in our head.</p>

<p>Here&rsquo;s something contrived to look a lot more like production code. First, without #returning:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">working_registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">person</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code>
  <code class="k">if</code> <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
    <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
  <code class="k">else</code>
    <code class="n">person</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(:</code><code class="n">default</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">)</code>
  <code class="k">end</code>
  <code class="n">person</code>
<code class="k">end</code>
</pre></div>

</div>

<p>And here we&rsquo;ve refactored it to use #returning:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">broken_registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">returning</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code> <code class="n">do</code> <code class="o">|</code><code class="n">person</code><code class="o">|</code>
    <code class="k">if</code> <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
      <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
    <code class="k">else</code>
      <code class="n">person</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(:</code><code class="n">default</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">)</code>
    <code class="k">end</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Oops! This no longer works as we intended. Overwriting the <code>person</code> variable is irrelevant, #returning returns the unregistered new person no matter what. So what&rsquo;s going on here?</p>

<p>One answer is to &ldquo;blame the victim.&rdquo; Ruby has a certain well-documented behaviour around variables and references. #returning has a certain well-documented behaviour. Any programmer who makes the above mistake is&ndash;well&ndash;mistaken. Fix the code and set the bug ticket status to Problem Between Keyboard And Chair (&ldquo;PBKAC&rdquo;).</p>

<p>Another answer is to suggest that the implementation of #returning is at fault. If you write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">returning</code> <code class="p">...</code> <code class="n">do</code> <code class="o">|</code><code class="n">var</code><code class="o">|</code>
  # <code class="p">...</code>
  <code class="n">var</code> <code class="p">=</code> <code class="n">something_else</code>
  # <code class="p">...</code>
<code class="k">end</code>
</pre></div>

</div>

<p>You intended to change what you are returning from #returning. So #returning should be changed to do what you meant. I&rsquo;m on the fence about this. When folks argue that designs should cater to programmers who do not understand the ramifactions of the programming language or of the framework, I usually retort that you cannot have progress and innovation while clinging to familiarity, <a href="http://weblog.raganwald.com/2008/01/programming-language-cannot-be-better.html" title="A programming language cannot be better without being unintuitive">an argument I first heard from Jef Raskin</a>. The real meaning of &ldquo;The Principle of Least Surprise&rdquo; is that a design should be <em>internally consistent</em>, which is not the same thing as <em>familiar</em>.</p>

<p>Ruby&rsquo;s existing use of variables and references is certainly consistent. And once you know what #returning does, it remains consistent. However, this design decision isn&rsquo;t really about being consistent with Ruby&rsquo;s implementation, we are debating how an idiom should be designed. I think we have a blank canvas and it&rsquo;s reasonable to at least <em>consider</em> a version of #returning that handles assignment to the parameter.</p>

<p><strong>Rewriting #returning</strong></p>

<p>The <a href="http://github.com/raganwald-deprecated/rewrite_rails/tree/master">RewriteRails</a> plug-in adds syntactic abstractions like <a href="http://github.com/raganwald-deprecated/rewrite_rails/tree/master/doc/andand.textile" title="&quot;) and [String to Block](http://github.com/raganwald-deprecated/rewrite_rails/tree/master/doc/string_to_block.md#readme &quot;">Andand</a> to Rails projects <a href="http://avdi.org/devblog/2008/02/23/why-monkeypatching-is-destroying-ruby/" title="Monkeypatching is Destroying Ruby">without monkey-patching</a>. RewriteRails now includes its own version of #returning that overrides the #returning shipping with Rails.</p>

<p>When RewriteRails is processing source code, it turns code like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">returning</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">))</code> <code class="n">do</code> <code class="o">|</code><code class="n">person</code><code class="o">|</code>
    <code class="k">if</code> <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
      <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
    <code class="k">else</code>
      <code class="n">person</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(:</code><code class="n">default</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">)</code>
    <code class="k">end</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Into this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">registered_person</code><code class="p">(</code><code class="n">params</code> <code class="p">=</code> <code class="p">{})</code>
  <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">person</code><code class="o">|</code>
    <code class="k">if</code> <code class="n">Registry</code><code class="p">.</code><code class="n">register</code><code class="p">(</code><code class="n">person</code><code class="p">)</code>
      <code class="n">person</code><code class="p">.</code><code class="n">send_email_notification</code>
    <code class="k">else</code>
      <code class="n">person</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(:</code><code class="n">default</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">)</code>
    <code class="k">end</code>
    <code class="n">person</code>
  <code class="k">end</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">Person</code><code class="p">.</code><code class="n">new</code><code class="p">(</code><code class="n">params</code><code class="p">.</code><code class="n">merge</code><code class="p">(:</code><code class="n">registered</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">true</code><code class="p">)))</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Note that in addition to turning the #returning &ldquo;call&rdquo; into a lambda that is invoked immediately, it also makes sure the new lambda returns the <code>person</code> variable&rsquo;s contents. So assignment to the variable does change what #returning appears to return.</p>

<p>Like all processors in RewriteRails, #returning is only rewritten in <code>.rr</code> files that you write in your project. Existing <code>.rb</code> files are not affected, including all code in the Rails framework: RewriteRails will never monkey with other people&rsquo;s expectations. RewriteRails doesn&rsquo;t physically modify the .rr files you write: The rewritten code is put in another file that the Ruby interpreter sees. So you see the code you write and RewriteRails figures out what to show the interpreter. This is a little like a Lisp macro. </p>

<h2 section-num="3" id="the-thrush">The Thrush</h2>

<p>In Combinatory Logic, the thrush is an extremely simple <em>permuting</em> combinator; it reverses the normal order of evaluation. The thrush is written <code>Txy = yx</code>. It <em>reverses</em> evaluation. In Ruby terms,</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">thrush</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">a_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code>
</pre></div>

</div>

<p>In <a href="http://weblog.raganwald.com/2008/01/no-detail-too-small.html">No Detail Too Small</a>, I defined <code>Object#into</code>, an implementation of the thrush as a Ruby method:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Object</code>
  <code class="n">def</code> <code class="n">into</code> <code class="n">expr</code> <code class="p">=</code> <code class="n">nil</code>
    <code class="n">expr</code><code class="p">.</code><code class="n">nil</code>? ? <code class="n">yield</code><code class="p">(</code><code class="n">self</code><code class="p">)</code> <code class="p">:</code> <code class="n">expr</code><code class="p">.</code><code class="n">to_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">self</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>If you are in the habit of violating the <a href="http://en.wikipedia.org/wiki/Law_of_Demeter">Law of Demeter</a>, you can use <code>#into</code> to make an expression read consistently from left to right. For example, this code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code> <code class="o">*</code> <code class="n">x</code> <code class="p">}.</code><code class="n">call</code><code class="p">((</code>1<code class="p">..</code>100<code class="p">).</code><code class="n">select</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="n">odd</code>?<code class="p">).</code><code class="n">inject</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">))</code>
</pre></div>

</div>

<p>Reads &ldquo;Square (take the numbers from 1 to 100, select the odd ones, and take the sum of those).&rdquo; Confusing. Whereas with <code>#into</code>, you can write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code>1<code class="p">..</code>100<code class="p">).</code><code class="n">select</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="n">odd</code>?<code class="p">).</code><code class="n">inject</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">).</code><code class="n">into</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code> <code class="o">*</code> <code class="n">x</code> <code class="p">}</code>
</pre></div>

</div>

<p>Which reads &ldquo;Take the numbers from 1 to 100, keep the odd ones, take the sum of those, and then answer the square of that number.&rdquo;</p>

<p>A permuting combinator like <code>#into</code> is not strictly necessary when you have parentheses or local variables. Which is kind of interesting, because it shows that if you have permuting combinators, you can model parentheses and local variables.</p>

<p>But we are not interested in theory. <code>#into</code> may be equivalent to what we can accomplish with other means, but it is useful to us if we feel it makes the code clearer and easier to understand. Sometimes a longer expression should be broken into multiple small expressions to make it easier to understand. Sometimes it can be reordered using tools like <code>#into</code>.</p>

<h3 section-num="3.1" id="let">Let</h3>

<p><code>Object#into</code> defines the thrush as a method that takes a block, lambda, or anything that can become a block or lambda as its argument. There is another way to formulate a Thrush:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Kernel</code>
  <code class="n">def</code> <code class="n">let</code> <code class="n">it</code>
    <code class="n">yield</code> <code class="n">it</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>It&rsquo;s remarkably simple, so simple that it appears to be less useful than <code>#into</code>. The example above would look like this if we used <code>let</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">let</code> <code class="p">(</code>1<code class="p">..</code>100<code class="p">).</code><code class="n">select</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="n">odd</code>?<code class="p">).</code><code class="n">inject</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code>
  <code class="n">x</code> <code class="o">*</code> <code class="n">x</code>
<code class="k">end</code>
</pre></div>

</div>

<p>How does that help? I&rsquo;ll let you in on a secret: Ruby 1.9 changes the game. In Ruby 1.8, <code>x</code> is local to the surrounding method, so it doesn&rsquo;t help. But in Ruby 1.9, <code>x</code> is a <em>block local variable</em>, meaning that it does not clobber an existing variable. So in Ruby 1.8:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">say_the_square_of_the_sum_of_the_odd_numbers</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
  <code class="n">sotos</code> <code class="p">=</code> <code class="n">let</code> <code class="p">(</code>1<code class="p">..</code><code class="n">x</code><code class="p">).</code><code class="n">select</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="n">odd</code>?<code class="p">).</code><code class="n">inject</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code>
    <code class="n">x</code> <code class="o">*</code> <code class="n">x</code>
  <code class="k">end</code>
  &quot;<code class="n">The</code> <code class="n">square</code> <code class="n">of</code> <code class="n">the</code> <code class="n">sum</code> <code class="n">of</code> <code class="n">the</code> <code class="n">odd</code> <code class="n">numbers</code> <code class="n">from</code> 1<code class="p">..</code>#<code class="p">{</code><code class="n">x</code><code class="p">}</code> <code class="n">is</code> #<code class="p">{</code><code class="n">sotos</code><code class="p">}</code>&quot;
<code class="k">end</code>

<code class="n">say_the_square_of_the_sum_of_the_odd_numbers</code><code class="p">(</code>10<code class="p">)</code>
 <code class="p">=</code><code class="o">&gt;</code> &quot;<code class="n">The</code> <code class="n">square</code> <code class="n">of</code> <code class="n">the</code> <code class="n">sum</code> <code class="n">of</code> <code class="n">the</code> <code class="n">odd</code> <code class="n">numbers</code> <code class="n">from</code> 1<code class="p">..</code>25 <code class="n">is</code> 625&quot;
</pre></div>

</div>

<p><code>1..25</code>!? What happened here is that the <code>x</code> inside the block clobbered the value of the <code>x</code> parameter. Not good. In Ruby 1.9:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">say_the_square_of_the_sum_of_the_odd_numbers</code><code class="p">(</code>10<code class="p">)</code>
 <code class="p">=</code><code class="o">&gt;</code> &quot;<code class="n">The</code> <code class="n">square</code> <code class="n">of</code> <code class="n">the</code> <code class="n">sum</code> <code class="n">of</code> <code class="n">the</code> <code class="n">odd</code> <code class="n">numbers</code> <code class="n">from</code> 1<code class="p">..</code>10 <code class="n">is</code> 625&quot;
</pre></div>

</div>

<p>Much better, Ruby 1.9 creates a new scope inside the block and <code>x</code> is local to that block, <em>shadowing</em> the <code>x</code> parameter. Now we see a use for <code>let</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">let</code><code class="p">(</code><code class="n">some_expression</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">my_block_local_variable</code><code class="o">|</code>
  # <code class="p">...</code>
<code class="k">end</code>
</pre></div>

</div>

<p><code>let</code> creates a new scope and defines your block local variable inside the block. This <a href="http://weblog.raganwald.com/2007/11/programming-conventions-as-signals.html" title="Programming conventions as signals">signals</a> that the block local variable is not used elsewhere. Imperative methods can be easier to understand when they are composed of smaller blocks with well-defined dependencies between them. A variable local to the entire method creates a dependency across the entire method. A variable local to a block only creates dependencies within that block.</p>

<p>Although Ruby 1.8 does not enforce this behaviour, it can be useful to write code in this style as a signal to make the code easier to read.</p>

<p><strong>Summary</strong></p>

<p>We have seen two formulations of the thrush combinator, <code>#into</code> and <code>let</code>. One is useful for making expressions more consistent and easier to read, the other for signaling the scope of block-local variables.</p>

<h2 section-num="4" id="songs-of-the-cardinal">Songs of the Cardinal</h2>

<p>In Combinatory Logic, the cardinal is one of the most basic <em>permuting</em> combinators; it reverses and parenthesizes the normal order of evaluation. The cardinal is written <code>Cxyz = xzy</code>. In Ruby:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">cardinal</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">proc_over_proc</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">proc_over_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code>
</pre></div>

</div>

<p>What does this mean? Let&rsquo;s compare it to the Thrush. The thrush is written <code>Txy = yx</code>. In Ruby terms,</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">thrush</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">a_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code>
</pre></div>

</div>

<p>The salient difference is that a cardinal doesn&rsquo;t just pass <code>a_value</code> to <code>a_proc</code>. What it does is first passes <code>a_proc</code> to <code>proc_over_proc</code> and then passes <code>a_value</code> to the result. This implies that <code>proc_over_proc</code> is a function that takes a function as its argument and returns a function.</p>

<p>Or in plainer terms, you want a cardinal when you would like to modify what a function or a block does. Now you can see why we can derive a thrush from a cardinal. If we write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">identity</code> <code class="p">=</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">f</code><code class="o">|</code> <code class="n">f</code> <code class="p">}</code>
</pre></div>

</div>

<p>Then we can write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">thrush</code> <code class="p">=</code> <code class="n">cardinal</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">identity</code><code class="p">)</code>
</pre></div>

</div>

<p>What we have done is say a thrush is what you get when you use a cardinal and a function that doesn&rsquo;t modify its function but answers it right back.</p>

<blockquote>
  <p><em>Note to ornithologists and ontologists</em>:</p>
</blockquote>

<blockquote>
  <p>This is not object orientation: a thrush is not a kind of cardinal. The correct relationship between them in Ruby is that a cardinal creates a thrush. Or in Smullyan&rsquo;s songbird metaphor, if you call out the name of an identity bird to a cardinal, it will call out the name of a thrush back to you.</p>
</blockquote>

<p>Now, this bizarre syntactic convention of writing <code>foo.call(bar).call(bash)</code> is not very helpful for actually writing software. It is great for explaining what&rsquo;s going on, but if we are going to use Ruby for the examples, we need to lift our game up a level and make some idiomatic Ruby.</p>

<h3 section-num="4.1" id="building-a-cardinal-in-ruby">Building a Cardinal in Ruby</h3>

<p>The next chunk of code works around the fact that Ruby 1.8 can&rsquo;t define a proc that takes a block and also doesn&rsquo;t allow <code>define_method</code> to define a method that takes a block. So for Ruby 1.8, we will start by making a utility method that defines methods that can take a block, based on <a href="http://coderrr.wordpress.com/2008/10/29/using-define_method-with-blocks-in-ruby-18/" title="Using define_method with blocks in Ruby 1.8">an idea from coderr</a>. For Ruby 1.9 this is not necessary: you can use <code>define_method</code> to define methods that take blocks as arguments.</p>

<div class="code-block">
<div class="highlight"><pre>def define_method_taking_block<code class="p">(</code>name<code class="p">,</code> method_body_proc<code class="p">)</code>
  self.class.send :define_method<code class="p">,</code> <code class="s">&quot;__cardinal_helper_#{name}__&quot;</code><code class="p">,</code> <code class="o">&amp;</code>method_bo\
dy_proc
  eval <code class="o">&lt;&lt;-</code>EOM
    def <code class="c1">#{name}(a_value, &amp;a_proc)</code>
      __cardinal_helper_<code class="c1">#{name}__(a_value, a_proc)</code>
    end
  EOM
end
</pre></div>

</div>

<blockquote>
  <p>Now we can see what the expression &ldquo;accidental complexity&rdquo; means. Do you see how we need a long paragraph and a chunk of code to explain how we are working around a limitation in our tool? And how the digression to explain the workaround is longer than the actual code we want to write? Ugh!</p>
</blockquote>

<p>With <em>that</em> out of the way, we can write our cardinal:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">cardinal_define</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">proc_over_proc</code><code class="p">)</code>
  <code class="n">define_method_taking_block</code><code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">a_value</code><code class="p">,</code> <code class="n">a_proc</code><code class="o">|</code>
      <code class="n">proc_over_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Ready to try it? Here&rsquo;s a familiar example. We&rsquo;ll need a <code>proc_over_proc</code>, our proc that modifies another proc. Because we&rsquo;re trying to be Ruby-ish, we&rsquo;ll write it out as a block:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="o">|</code><code class="n">a_proc</code><code class="o">|</code>
</pre></div>

</div>
      lambda { |a_value|
<div class="code-block">
<div class="highlight"><pre>    <code class="n">a_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code> <code class="n">unless</code> <code class="n">a_value</code><code class="p">.</code><code class="n">nil</code>?
  <code class="p">}</code>
<code class="k">end</code>
</pre></div>

</div>

<p>This takes a <code>a_proc</code> and returns a brand new proc that only calls <code>a_proc</code> if the value you pass it is not nil. Now let&rsquo;s use our cardinal to define a new method:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">cardinal_define</code><code class="p">(:</code><code class="n">maybe</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">a_proc</code><code class="o">|</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">a_value</code><code class="o">|</code>
    <code class="n">a_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code> <code class="n">unless</code> <code class="n">a_value</code><code class="p">.</code><code class="n">nil</code>?
  <code class="p">}</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Let&rsquo;s try it out:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">maybe</code><code class="p">(</code>1<code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> 1 <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> 2
<code class="n">maybe</code><code class="p">(</code><code class="n">nil</code><code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> 1 <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>If we&rsquo;re using Rails, we can make a slightly different version of <code>maybe</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">cardinal_define</code><code class="p">(:</code><code class="n">unless_blank</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">a_proc</code><code class="o">|</code>
</pre></div>

</div>
      lambda { |a_value|
<div class="code-block">
<div class="highlight"><pre>    <code class="n">a_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code> <code class="n">unless</code> <code class="n">a_value</code><code class="p">.</code><code class="n">blank</code>?
  <code class="p">}</code>
<code class="k">end</code>

<code class="n">unless_blank</code><code class="p">(</code><code class="n">Person</code><code class="p">.</code><code class="nb">find</code><code class="p">(...).</code><code class="n">name</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">name</code><code class="o">|</code>
  <code class="n">register_name_on_title</code><code class="p">(</code><code class="n">name</code><code class="p">)</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Remember we said the cardinal can be used to define a thrush? Let&rsquo;s try our Ruby cardinal out to do the same thing. Recall that expressing the identity bird as a block is:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">do</code> <code class="o">|</code><code class="n">a_proc</code><code class="o">|</code>
  <code class="n">a_proc</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Therefore we can define a thrush with:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">cardinal_define</code><code class="p">(:</code><code class="n">let</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">a_proc</code><code class="o">|</code>
  <code class="n">a_proc</code>
<code class="k">end</code>

<code class="n">let</code><code class="p">((</code>1<code class="p">..</code>10<code class="p">).</code><code class="n">select</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="c">% 2 == 1 }.inject { |mem, var| mem + var }) do |\</code>
<code class="n">x</code><code class="o">|</code>
  <code class="n">x</code> <code class="o">*</code> <code class="n">x</code>
<code class="k">end</code>
  <code class="p">=</code><code class="o">&gt;</code> 625
</pre></div>

</div>

<p>As you can see, once you have a defined a cardinal, you can create an infinite variety of methods that have thrush-like syntax&ndash;a method that applies a value to a block&ndash;but you can modify or augment the <em>semantics</em> of the block in any way you want.</p>

<p>In Ruby terms, you are meta-programming. In Smullyan&rsquo;s terms, you are <em>Listening to the Songs of the Cardinal</em>.</p>

<h2 section-num="5" id="quirky-birds-and-meta-syntactic-programming">Quirky Birds and Meta-Syntactic Programming</h2>

<p>In Combinatory Logic, the Queer Birds are a family of combinators which both parenthesize and permute. One member of the family, the <em>Quirky Bird</em>, has interesting implications for Ruby. The quirky bird is written <code>Q</code><sub><code>3</code></sub><code>xyz = z(xy)</code>. In Ruby:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">quirky</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">value_proc</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">a_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">value_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">))</code>
</pre></div>

</div>

<p>Like the Cardinal, the quirky bird reverses the order of application. But where the cardinal modifies the function that is applied to a value, the quirky bird modifies the value itself. Let&rsquo;s compare how cardinals and quirky birds work.</p>

<p><strong>a cardinals refresher</strong></p>

<p>The cardinal is defined in its simplest Ruby form as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">cardinal</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">proc_over_proc</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">proc_over_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code>
</pre></div>

</div>

<p>From that definition, we wrote a method called <code>cardinal_define</code> that writes methods in idiomatic Ruby. For example, here&rsquo;s how we used <code>cardinal_define</code> to generate the <code>maybe</code> method:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">cardinal_define</code><code class="p">(:</code><code class="n">maybe</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">a_proc</code><code class="o">|</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">a_value</code><code class="o">|</code>
    <code class="n">a_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code> <code class="n">unless</code> <code class="n">a_value</code><code class="p">.</code><code class="n">nil</code>?
  <code class="p">}</code>
<code class="k">end</code>

<code class="n">maybe</code><code class="p">(</code>1<code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> 1 <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> 2
<code class="n">maybe</code><code class="p">(</code><code class="n">nil</code><code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> 1 <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>Now we are not looking at the source code for <code>maybe</code>, but from the definition of a cardinal above we know that any method defined by <code>cardinal_define</code> will look roughly like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">defined_by_a_cardinal</code><code class="p">(</code><code class="n">a_value</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">a_proc</code><code class="p">)</code>
  <code class="n">proc_over_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Or in our case:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">maybe</code><code class="p">(</code><code class="n">a_value</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">a_proc</code><code class="p">)</code>
  <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">a_proc</code><code class="o">|</code>
    <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">a_value</code><code class="o">|</code>
      <code class="n">a_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code> <code class="n">unless</code> <code class="n">a_value</code><code class="p">.</code><code class="n">nil</code>?
    <code class="p">}</code>
  <code class="k">end</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code>
<code class="k">end</code>
</pre></div>

</div>

<p><strong>and now to the quirky bird</strong></p>

<p>From the definition for the quirky bird, we expect that if we write <code>quirky_bird_define</code>, the methods it generates will look roughly like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">defined_by_a_quirky_bird</code><code class="p">(</code><code class="n">a_value</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">a_proc</code><code class="p">)</code>
  <code class="n">a_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">value_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">))</code>
<code class="k">end</code>
</pre></div>

</div>

<p>So, are we ready to write <code>quirky_bird_define</code>? This seems too easy. Just copy the <code>cardinal_define</code> code, make a few changes, and we&rsquo;re done:</p>

<div class="code-block">
<div class="highlight"><pre>def quirky_bird_define<code class="p">(</code>name<code class="p">,</code> <code class="o">&amp;</code>value_proc<code class="p">)</code>
  define_method_taking_block<code class="p">(</code>name<code class="p">)</code> do <code class="o">|</code>a_value<code class="p">,</code> a_proc<code class="o">|</code>
    a_proc.call<code class="p">(</code>value_proc.call<code class="p">(</code>a_value<code class="p">))</code>
  end
end

<code class="c1"># method_body_proc should expect (a_value, a_proc)</code>
<code class="c1"># see http://coderrr.wordpress.com/2008/10/29/using-define_method-with-bloc\</code>
ks<code class="o">-</code>in<code class="o">-</code>ruby<code class="o">-</code><code class="m">18</code><code class="o">/</code>
def define_method_taking_block<code class="p">(</code>name<code class="p">,</code> <code class="o">&amp;</code>method_body_proc<code class="p">)</code>
  self.class.send :define_method<code class="p">,</code> <code class="s">&quot;__quirky_bird_helper_#{name}__&quot;</code><code class="p">,</code> method_\
body_proc
  eval <code class="o">&lt;&lt;-</code>EOM
    def <code class="c1">#{name}(a_value, &amp;a_proc)</code>
      __quirky_bird_helper_<code class="c1">#{name}__(a_value, a_proc)</code>
    end
  EOM
end
</pre></div>

</div>

<p>Ok, let&rsquo;s try it out on something really trivial:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">quirky_bird_define</code><code class="p">(:</code><code class="n">square_first</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">a_value</code><code class="o">|</code>
  <code class="n">a</code> <code class="n">value</code> <code class="o">*</code> <code class="n">a_value</code>
<code class="k">end</code>

<code class="n">square_first</code><code class="p">(</code>1<code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">+</code> 1 <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> 2

<code class="n">square_first</code><code class="p">(</code>2<code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">+</code> 1 <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> 5
</pre></div>

</div>

<p>It works, good. Now let&rsquo;s define <code>maybe</code> using the quirky bird we just wrote. Just so we&rsquo;re clear, I want to write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">quirky_bird_define</code><code class="p">(:</code><code class="n">maybe</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">a_value</code><code class="o">|</code>
  # <code class="p">...</code> <code class="n">something</code> <code class="n">goes</code> <code class="n">here</code> <code class="p">...</code>
<code class="k">end</code>

<code class="n">maybe</code><code class="p">(</code>1<code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">+</code> 1 <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> 2

<code class="n">maybe</code><code class="p">(</code><code class="n">nil</code><code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">+</code> 1 <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>Scheisse! Figuring out what to put in the block to make <code>maybe</code> work is indeed queer and quirky!!</p>

<p>Now, the simple truth is, I know of no way to use a quirky bird to cover all of the possible blocks you could use with <code>maybe</code> so that it works exactly like the version of <code>maybe</code> we built with a cardinal. However, I have found that sometimes it is interesting to push an incomplete idea along if it is incomplete in interesting ways. &ldquo;Maybe&rdquo; we can learn something in the process.</p>

<h3 section-num="5.1" id="a-limited-interpretation-of-the-quirky-bird-in-ruby">A limited interpretation of the Quirky Bird in Ruby</h3>

<p>Let&rsquo;s solve <code>maybe</code> any-which-way-we-can and see how it goes. When we used a cardinal, we wanted a proc that would modify another proc to such that if it was passed <code>nil</code>, it would answer <code>nil</code> without evaluating its contents.</p>

<p>Now we want to modify a value such that if it is <code>nil</code>, it responds <code>nil</code> to the method <code>+</code>. This is doable, with the help of the <code>BlankSlate</code> class, also called a <code>BasicObject</code>. You&rsquo;ll find <code>BlankSlate</code> and <code>BasicObject</code> classes in various frameworks and Ruby 1.9, and there&rsquo;s one at <a href="http://github.com/raganwald/homoiconic/tree/master/2008-11-04/blank_slate.rb" title="2008-11-04/blank_slate.rb at master from raganwald's homoiconic &mdash; GitHub">blank_slate.rb</a> you can use.</p>

<p><code>BlankSlate</code> is a class with no methods, which is very different from the base class <code>Object</code>. That&rsquo;s because <code>Object</code> in Ruby is <em>heavyweight</em>, it has lots of useful stuff.  But we don&rsquo;t want useful stuff, because our mission is to answer a value that responds <code>nil</code> to any method you send it.</p>

<p>The Ruby way to handle any method is with <code>method_missing</code>. Here&rsquo;s a really simple expression that answers an object that responds <code>nil</code> to any method:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">returning</code><code class="p">(</code><code class="n">BlankSlate</code><code class="p">.</code><code class="n">new</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">it</code><code class="o">|</code>
  <code class="n">def</code> <code class="n">it</code><code class="p">.</code><code class="n">method_missing</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">)</code>
    <code class="n">nil</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Hmmm. What about:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">quirky_bird_define</code><code class="p">(:</code><code class="n">maybe</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
  <code class="k">if</code> <code class="n">value</code><code class="p">.</code><code class="n">nil</code>?
    <code class="n">returning</code><code class="p">(</code><code class="n">BlankSlate</code><code class="p">.</code><code class="n">new</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">it</code><code class="o">|</code>
      <code class="n">def</code> <code class="n">it</code><code class="p">.</code><code class="n">method_missing</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">)</code>
        <code class="n">nil</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="k">else</code>
    <code class="n">value</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>This is saying, &ldquo;Let&rsquo;s define a quirky bird method based on a <code>value_proc</code> as usual. Our <code>value_proc</code> will take a value, and if the value is <code>nil</code> we will return an object that responds with <code>nil</code> to any method. But if the value is not nil, our <code>value_proc</code> will respond with the object.&rdquo;</p>

<p>Let&rsquo;s try it:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">maybe</code><code class="p">(</code>1<code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">+</code> 1 <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> 2

<code class="n">maybe</code><code class="p">(</code><code class="n">nil</code><code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">+</code> 1 <code class="p">}</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>Now, I admit this is <em>very</em> flawed:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">maybe</code><code class="p">(</code><code class="n">nil</code><code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">+</code> 1 <code class="o">+</code> 1 <code class="p">}</code>
</pre></div>

</div>
      =&gt; NoMethodError: undefined method `+&rsquo; for nil:NilClass

<div class="code-block">
<div class="highlight"><pre><code class="n">maybe</code><code class="p">(</code><code class="n">nil</code><code class="p">)</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> 1 <code class="o">+</code> <code class="n">n</code> <code class="p">}</code>
</pre></div>

</div>
      =&gt; TypeError: coerce must return [x, y]

<p>The basic problem here is that we only control the value we pass in. We can&rsquo;t modify how other objects respond to it, nor can we control what happens to any objects we return from methods called on it. So, the quirky bird turns out to be useful in the case where (a) the value is the receiver of a method, and (b) there is only one method being called, not a chain of methods.</p>

<p>Hmmm again.</p>

<h3 section-num="5.2" id="embracing-the-quirky-bird">Embracing the Quirky Bird</h3>

<p>Maybe we shouldn&rsquo;t be generating methods that deal with arbitrary blocks and procedures. One way to scale this down is to deal only with single method invocations. For example, what if instead of designing our new version of <code>maybe</code> so that we invoke it by writing <code>maybe(nil) { |n| n + 1 }</code> or <code>maybe(1) { |n| n + 1 }</code>, we design it so that we write <code>nil.maybe + 1</code> or <code>1.maybe + 1</code> instead?</p>

<p>In that case, <code>maybe</code> becomes a method on the object class that applies <code>value_proc</code> to its receiver rather than being a method that takes a value and a block. Getting down to business, we are going to open the core <code>Object</code> class and add a new method to it. The body of that method will be our <code>value_proc</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">quirky_bird_extend</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">value_proc</code><code class="p">)</code>
  <code class="n">Object</code><code class="p">.</code><code class="n">send</code><code class="p">(:</code><code class="n">define_method</code><code class="p">,</code> <code class="n">name</code><code class="p">)</code> <code class="n">do</code>
    <code class="n">value_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">self</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Just as we said, we are defining a new method in the <code>Object</code> class.</p>

<blockquote>
  <p>We are using <code>define_method</code> and a block rather than the <code>def</code> keyword. The reason is that when we use <code>define_method</code> and a block, the body of the method executes in the context of the block, not the context of the object itself. Blocks are closures in Ruby, which means that the block has access to <code>value_proc</code>, the parameter from our <code>quirky_bird_extend</code> method. </p>
</blockquote>

<blockquote>
  <p>Had we used <code>def</code>, Ruby would try to evaluate <code>value_proc</code> in the context of the object itself. So our parameter would be lost forever. Performance wonks and compiler junkies will be interested in this behaviour, as it has very serious implications for garbage collection and memory leaks.</p>
</blockquote>

<p>Now let&rsquo;s use it with exactly the same block we used with <code>quirky_bird_define</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">require</code> <code class="s">&#39;quirky_bird&#39;</code>
<code class="n">require</code> <code class="s">&#39;blank_slate&#39;</code>
<code class="n">require</code> <code class="s">&#39;returning&#39;</code>

<code class="n">quirky_bird_extend</code><code class="p">(:</code><code class="n">maybe</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
  <code class="k">if</code> <code class="n">value</code><code class="p">.</code><code class="n">nil</code>?
    <code class="n">returning</code><code class="p">(</code><code class="n">BlankSlate</code><code class="p">.</code><code class="n">new</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">it</code><code class="o">|</code>
      <code class="n">def</code> <code class="n">it</code><code class="p">.</code><code class="n">method_missing</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">)</code>
        <code class="n">nil</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="k">else</code>
    <code class="n">value</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">nil</code><code class="p">.</code><code class="n">maybe</code> <code class="o">+</code> 1
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>

1<code class="p">.</code><code class="n">maybe</code> <code class="o">+</code> 1
  <code class="p">=</code><code class="o">&gt;</code> 2
</pre></div>

</div>

<p>It works. And it looks familiar! We have defined our own version of <a href="http://github.com/raganwald/andand/tree" title="sudo gem install andand">andand</a>, only this is much more <strong>interesting</strong>. Instead of a one-off handy-dandy, we have created a method that creates similar methods.</p>

<p>Let&rsquo;s try it again, this time emulating Chris Wanstrath&rsquo;s <a href="http://ozmm.org/posts/try.html">try</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">quirky_bird_extend</code><code class="p">(:</code><code class="k">try</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
  <code class="n">returning</code><code class="p">(</code><code class="n">BlankSlate</code><code class="p">.</code><code class="n">new</code><code class="p">)</code> <code class="n">do</code> <code class="o">|</code><code class="n">it</code><code class="o">|</code>
    <code class="n">def</code> <code class="n">it</code><code class="p">.</code><code class="n">__value__</code><code class="p">=(</code><code class="n">arg</code><code class="p">)</code>
       <code class="p">@</code><code class="n">value</code> <code class="p">=</code> <code class="n">arg</code>
    <code class="k">end</code>
    <code class="n">def</code> <code class="n">it</code><code class="p">.</code><code class="n">method_missing</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="o">*</code><code class="n">args</code><code class="p">)</code>
      <code class="k">if</code> <code class="p">@</code><code class="n">value</code><code class="p">.</code><code class="n">respond_to</code>?<code class="p">(</code><code class="n">name</code><code class="p">)</code>
        <code class="p">@</code><code class="n">value</code><code class="p">.</code><code class="n">send</code><code class="p">(</code><code class="n">name</code><code class="p">,</code> <code class="o">*</code><code class="n">args</code><code class="p">)</code>
      <code class="k">end</code>
    <code class="k">end</code>
    <code class="n">it</code><code class="p">.</code><code class="n">__value__</code> <code class="p">=</code> <code class="n">value</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">nil</code><code class="p">.</code><code class="k">try</code> <code class="o">+</code> 1
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>

1<code class="p">.</code><code class="k">try</code> <code class="o">+</code> 1
  <code class="p">=</code><code class="o">&gt;</code> 2

1<code class="p">.</code><code class="k">try</code><code class="p">.</code><code class="n">ordinalize</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>As you can see, we can used the quirky bird to create a whole family of methods that modify the receiver in some way to produce new semantics. I can&rsquo;t show you the source code, but here is something from a proprietary Rails application:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Account</code><code class="p">.</code><code class="n">without_requiring_authorization</code><code class="p">.</code><code class="n">create</code>!<code class="p">(...)</code>
</pre></div>

</div>

<p>In this case, <code>without_requiring_authorization</code> follows the quirky bird pattern, only instead of taking an instance and producing a version that handles certain methods specially, this one takes a class and produces a version that doesn&rsquo;t enforce authorization for use in test cases.</p>

<p><strong>so what have we learned?</strong></p>

<p>The quirky bird is superficially similar to the cardinal, however it can be used to generate syntax that is a little more method-oriented rather than function-oriented. And what&rsquo;s better than a handy method like andand? A method for defining such methods, of course.</p>

<h3 section-num="5.3" id="andand-even-more">Andand even more</h3>

<p>As we&rsquo;ve discovered, &ldquo;andand&rdquo; is a Quirky Bird. Here&rsquo;s a little tip for using it effectively: You already know that you can use it to conditionally invoke a method on an object:</p>

<div class="code-block">
<div class="highlight"><pre>&quot;<code class="n">foo</code>&quot;<code class="p">.</code><code class="n">andand</code> <code class="o">+</code> &quot;<code class="n">bar</code>&quot;
    # <code class="p">=</code><code class="o">&gt;</code> &quot;<code class="n">foobar</code>&quot;
<code class="n">nil</code><code class="p">.</code><code class="n">andand</code> <code class="o">+</code> &quot;<code class="n">bar</code>&quot;
    # <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>In other words, it&rsquo;s a Quirky Bird. But did you know that you can also use it to conditionally invoke a block? </p>

<div class="code-block">
<div class="highlight"><pre><code class="p">(</code>1<code class="p">..</code>10<code class="p">).</code><code class="n">andand</code> <code class="n">do</code> <code class="o">|</code><code class="n">numbers</code><code class="o">|</code>
  <code class="n">doubles</code> <code class="p">=</code> <code class="n">numbers</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">*</code> 2 <code class="p">}</code>
  <code class="n">double_doubles</code> <code class="p">=</code> <code class="n">doubles</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">*</code> 2 <code class="p">}</code>
<code class="k">end</code>
    # <code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code>4<code class="p">,</code> 8<code class="p">,</code> 12<code class="p">,</code> 16<code class="p">,</code> 20<code class="p">,</code> 24<code class="p">,</code> 28<code class="p">,</code> 32<code class="p">,</code> 36<code class="p">,</code> 40<code class="p">]</code>

<code class="n">nil</code><code class="p">.</code><code class="n">andand</code> <code class="n">do</code> <code class="o">|</code><code class="n">numbers</code><code class="o">|</code>
  <code class="n">doubles</code> <code class="p">=</code> <code class="n">numbers</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">*</code> 2 <code class="p">}</code>
  <code class="n">double_doubles</code> <code class="p">=</code> <code class="n">doubles</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">*</code> 2 <code class="p">}</code>
<code class="k">end</code>
    # <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>It&rsquo;s not just a Quirky Bird, it&rsquo;s also a Cardinal!</p>

<p>Consider this conditional code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">if</code> <code class="n">my_var</code> <code class="p">=</code> <code class="n">something_or_other</code><code class="p">()</code>
  3<code class="p">.</code><code class="n">times</code> <code class="n">do</code>
    <code class="n">yada</code><code class="p">(</code><code class="n">my_var</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>I&rsquo;m not a big fan. The obvious sin is the pathetic 90s cultural reference. But I&rsquo;m even more annoyed by having side-effects in the predicate of an <code>if</code> clause, in this case assigning something to the variable <code>my_var</code>. Although I&rsquo;m not switching to a purely functional language any time soon, I strongly prefer that when you write <code>if something()</code>, then &ldquo;something()&rdquo; should not cause any side effects, ever.</p>

<p>Another problem is that we are obviously creating <code>my_var</code> just to use inside the block, but we&rsquo;re declaring it in top-level scope. We could fool around with a Thrush like <code>let</code>, but instead let&rsquo;s use <code>Object#andand</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">something_or_other</code><code class="p">().</code><code class="n">andand</code> <code class="n">do</code> <code class="o">|</code><code class="n">my_var</code><code class="o">|</code>
  3<code class="p">.</code><code class="n">times</code> <code class="n">do</code>
    <code class="n">yada</code><code class="p">(</code><code class="n">my_var</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Now we are making it clear that we wish to execute this block only if <code>something_or_other()</code> is not nil. Furthermore, we are assigning the result of <code>something_or_other()</code> to <code>my_var</code> and using it within the block. <a href="http://www.youtube.com/watch?v=ryXsn7fLV-M" title="YouTube - 7-UP Commercial featuring Geoffrey Holder">Crisp and clean, no caffeine</a>.</p>

<p>Note that if we don&rsquo;t actually <em>need</em> <code>my_var</code> in the block, we don&rsquo;t really need <code>andand</code> either:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">something_or_other</code><code class="p">()</code> <code class="n">and</code> <code class="n">begin</code>
  3<code class="p">.</code><code class="n">times</code> <code class="n">do</code>
    <code class="n">yada</code><code class="p">()</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Like anything else, <code>andand do ... end</code> is a tool to be used in specialized situations. Use it whenever you want to do something more complicated than a simple message send, but only when the subject is not <code>nil</code>.</p>

<h2 section-num="6" id="aspect-oriented-programming-in-ruby-using-combinator-birds">Aspect-Oriented Programming in Ruby using Combinator Birds</h2>

<p>In Combinatory Logic, the bluebird is one of the most important and fundamental combinators, because the bluebird <em>composes</em> two other combinators. Although this is usually discussed as part of <a href="http://weblog.raganwald.com/2007/03/why-why-functional-programming-matters.html" title="Why Why Functional Programming Matters Matters">functional programming style</a>, it is just as valuable when writing object-oriented programs. In this post, we will develop an <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming">aspect-oriented programming</a> (or &ldquo;AOP&rdquo;) module that adds before methods and after methods to Ruby programs, with the implementation inspired by the bluebird. The bluebird is written <code>Bxyz = x(yz)</code>. In Ruby, we can express the bluebird like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">bluebird</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">proc1</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">proc2</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">proc1</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">proc2</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">))</code>
</pre></div>

</div>

<p>If this seems a little arcane, consider a simple Ruby expression <code>(x * 2) + 1</code>: This expression <em>composes</em> multiplication and addition. Composition is so pervasive in programming languages that it becomes part of the syntax, something we take for granted. We don&rsquo;t have to think about it until someone like Oliver Steele writes a library like <a href="http://osteele.com/sources/javascript/functional/">functional javascript</a> that introduces a <code>compose</code> function, then we have to ask what it does.</p>

<p>Before we start using bluebirds, let&rsquo;s be clear about something. We wrote that <code>bluebird.call(proc1).call(proc2).call(value)</code> is equivalent to <code>proc1.call(proc2.call(value))</code>. We want to be very careful that we understand what is special about <code>proc1.call(proc2.call(value))</code>. How is it different from <code>proc1.call(proc2).call(value)</code>?</p>

<p>The answer is:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">proc1</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">proc2</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">))</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">puts</code> <code class="n">value</code> <code class="n">into</code> <code class="n">proc2</code><code class="p">,</code> <code class="n">then</code> <code class="n">puts</code> <code class="n">the</code> <code class="n">result</code> <code class="n">of</code> <code class="n">that</code> <code class="n">into</code> <code class="n">proc1</code>

<code class="n">proc1</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">proc2</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">puts</code> <code class="n">proc2</code> <code class="n">into</code> <code class="n">proc1</code><code class="p">,</code> <code class="n">getting</code> <code class="n">a</code> <code class="k">function</code> <code class="n">out</code><code class="p">,</code> <code class="n">then</code> <code class="n">puts</code> <code class="n">value</code> <code class="n">into</code> <code class="n">the</code><code class="o">\</code>
 <code class="n">new</code> <code class="k">function</code>
</pre></div>

</div>

<p>So with a bluebird you can chain functions together in series, while if you didn&rsquo;t have a bluebird all you could do is write functions that transform other functions. Not that there&rsquo;s anything wrong with that, we used that to great effect with <a href="http://github.com/raganwald/homoiconic/tree/master/2008-10-31/songs_of_the_cardinal.markdown#readme">cardinals</a> and <a href="http://github.com/raganwald/homoiconic/tree/master/2008-11-04/quirky_birds_and_meta_syntactic_programming.markdown#readme">quirky birds</a>.</p>

<h3 section-num="6.1" id="giving-methods-advice">Giving methods advice</h3>

<p>We&rsquo;re not actually going to <a href="http://en.wikipedia.org/wiki/Greenspun%27s_Tenth_Rule" title="Greenspun's Tenth Rule - Wikipedia, the free encyclopedia">Greenspun</a> an entire aspect-oriented layer on top of Ruby, but we will add a simple feature, we are going to add <em>before and after methods</em>. You already know what a normal method is. A before method simply specifies some behaviour you want executed before the method is called, while an after method specifies some behaviour you want executed after the method is called. In AOP, before and after methods are called &ldquo;advice.&rdquo;</p>

<blockquote>
  <p>There is an unwritten rule that says every Ruby programmer must, at some point, write his or her own AOP implementation &ndash;Avdi Grimm</p>
</blockquote>

<p>Ruby on Rails programmers are familiar with method advice. If you have ever written any of the following, you were using Rails&rsquo; built-in aspect-oriented programming support:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">after_save</code>
<code class="n">validates_each</code>
<code class="n">alias_method_chain</code>
<code class="n">before_filter</code>
</pre></div>

</div>

<p>These and other features of Rails implement method advice, albeit in a very specific way tuned to portions of the Rails framework. We&rsquo;re going to implement method advice in a module that you can use in any of your classes, on any method or methods you choose. We&rsquo;ll start with before methods. Here&rsquo;s the syntax we want:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">something</code><code class="p">(</code><code class="n">parameter</code><code class="p">)</code>
  # <code class="n">do</code> <code class="n">stuff</code><code class="p">...</code>
<code class="k">end</code>

<code class="n">before</code> <code class="p">:</code><code class="n">something</code> <code class="n">do</code> <code class="o">|</code><code class="n">parameter</code><code class="o">|</code>
  # <code class="n">stuff</code> <code class="n">to</code> <code class="n">do</code> <code class="n">BEFORE</code> <code class="n">we</code> <code class="n">do</code> <code class="n">stuff</code><code class="p">...</code>
<code class="k">end</code>

<code class="n">before</code> <code class="p">:</code><code class="n">something</code> <code class="n">do</code> <code class="o">|</code><code class="n">parameter</code><code class="o">|</code>
  # <code class="n">stuff</code> <code class="n">to</code> <code class="n">do</code> <code class="n">BEFORE</code> <code class="n">stuff</code> <code class="n">to</code> <code class="n">do</code> <code class="n">BEFORE</code> <code class="n">we</code> <code class="n">do</code> <code class="n">stuff</code><code class="p">...</code>
<code class="k">end</code>
</pre></div>

</div>

<p>As we can see, the before methods get chained together before the method. To keep this nice and clean, we are going to make them work just like composable functions: whatever our before method&rsquo;s block returns will be passed as a parameter up the chain. We also won&rsquo;t fool around with altering the order of before methods, we&rsquo;ll just take them as they come.</p>

<p>This is really simple, we are composing methods. To compare to the bluebird above, we are writing <code>before</code>, then the name of a method, then a function. I&rsquo;ll rewrite it like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">bluebird</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">something</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">stuff_to_do_before_we_do_stuff</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">something</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">stuff_to_do_before_we_do_stuff</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">))</code>
</pre></div>

</div>

<p>Now we can see that this newfangled aspect-oriented programming stuff was figured out nearly a century ago by people like <a href="http://en.wikipedia.org/wiki/Alonzo_Church">Alonzo Church</a>.</p>

<p>Okay, enough history, let&rsquo;s get started. First, we are not going to write any C, so there is no way to actually force the Ruby VM to call our before methods. So instead, we are going to have to rewrite our method. We&rsquo;ll use a <a href="http://blog.jayfields.com/2006/12/ruby-alias-method-alternative.html" title="Jay Fields' Thoughts: Ruby: Alias method alternative">trick</a> I found on Jay Fields&rsquo; blog:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">module</code> <code class="n">NaiveBeforeMethods</code>

  <code class="n">module</code> <code class="n">ClassMethods</code>

    <code class="n">def</code> <code class="n">before</code><code class="p">(</code><code class="n">method_sym</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">block</code><code class="p">)</code>
      <code class="n">old_method</code> <code class="p">=</code> <code class="n">self</code><code class="p">.</code><code class="n">instance_method</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code>
      <code class="k">if</code> <code class="n">old_method</code><code class="p">.</code><code class="n">arity</code> <code class="o">==</code> 0
        <code class="n">define_method</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code> <code class="n">do</code>
          <code class="n">block</code><code class="p">.</code><code class="n">call</code>
          <code class="n">old_method</code><code class="p">.</code><code class="n">bind</code><code class="p">(</code><code class="n">self</code><code class="p">).</code><code class="n">call</code>
        <code class="k">end</code>
      <code class="k">else</code>
        <code class="n">define_method</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code> <code class="n">do</code> <code class="o">|*</code><code class="n">params</code><code class="o">|</code>
          <code class="n">old_method</code><code class="p">.</code><code class="n">bind</code><code class="p">(</code><code class="n">self</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="o">*</code><code class="n">block</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="o">*</code><code class="n">params</code><code class="p">))</code>
        <code class="k">end</code>
      <code class="k">end</code>
    <code class="k">end</code>

  <code class="k">end</code>

  <code class="n">def</code> <code class="n">self</code><code class="p">.</code><code class="n">included</code><code class="p">(</code><code class="n">receiver</code><code class="p">)</code>
    <code class="n">receiver</code><code class="p">.</code><code class="n">extend</code>         <code class="n">ClassMethods</code>
  <code class="k">end</code>

<code class="k">end</code>
</pre></div>

</div>

<p>As you can see, we have a special case for methods with no parameters, and when we have a method with multiple parameters, our before method must answer an array of parameters. And the implementation relies on a &ldquo;flock of bluebirds:&rdquo; Our before methods and the underlying base method are composed with each other to define the method that is actually executed at run time.</p>

<p>Using it is very easy:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">SuperFoo</code>

  <code class="n">def</code> <code class="n">one_parameter</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
    <code class="n">x</code> <code class="o">+</code> 1
  <code class="k">end</code>

  <code class="n">def</code> <code class="n">two_parameters</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">)</code>
    <code class="n">x</code> <code class="o">*</code> <code class="n">y</code>
  <code class="k">end</code>

<code class="k">end</code>

<code class="n">class</code> <code class="n">Foo</code> <code class="o">&lt;</code> <code class="n">SuperFoo</code>

  <code class="n">include</code> <code class="n">NaiveBeforeMethods</code>

  <code class="n">before</code> <code class="p">:</code><code class="n">one_parameter</code> <code class="n">do</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code>
    <code class="n">x</code> <code class="o">*</code> 2
  <code class="k">end</code>

  <code class="n">before</code> <code class="p">:</code><code class="n">two_parameters</code> <code class="n">do</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="o">|</code>
    <code class="p">[</code><code class="n">x</code> <code class="o">+</code> <code class="n">y</code><code class="p">,</code> <code class="n">x</code> <code class="o">-</code> <code class="n">y</code><code class="p">]</code>
  <code class="k">end</code>

<code class="k">end</code>

<code class="n">Foo</code><code class="p">.</code><code class="n">new</code><code class="p">.</code><code class="n">one_parameter</code><code class="p">(</code>5<code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> 11

<code class="n">Foo</code><code class="p">.</code><code class="n">new</code><code class="p">.</code><code class="n">two_parameters</code><code class="p">(</code>3<code class="p">,</code>1<code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> 8
</pre></div>

</div>

<blockquote>
  <p>This could be even more useful if it supported methods with blocks. Adventurous readers may want to combine this code with the tricks in <code>cardinal.rb</code> and see if they can build a version of <code>before</code> that supports methods that take blocks.</p>
</blockquote>

<h3 section-num="6.2" id="the-super-keyword-perhaps-youve-heard-of-it">The super keyword, perhaps you&rsquo;ve heard of it?</h3>

<p>Of course, Ruby provides a means of &lsquo;decorating&rsquo; methods like this by overriding a method and calling <code>super</code> within it. So we might have written:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Foo</code> <code class="o">&lt;</code> <code class="n">SuperFoo</code>

  <code class="n">def</code> <code class="n">one_parameter</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
    <code class="n">super</code><code class="p">(</code><code class="n">x</code> <code class="o">*</code> 2<code class="p">)</code>
  <code class="k">end</code>

  <code class="n">def</code> <code class="n">two_parameters</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">)</code>
    <code class="n">super</code><code class="p">(</code><code class="n">x</code> <code class="o">+</code> <code class="n">y</code><code class="p">,</code> <code class="n">x</code> <code class="o">-</code> <code class="n">y</code><code class="p">)</code>
  <code class="k">end</code>

<code class="k">end</code>
</pre></div>

</div>

<p>On a trivial example, the two techniques seem equivalent, so why bother with the extra baggage? The answer is that using <code>super</code> is a little low level. When you see a method definition in a language like Ruby, you don&rsquo;t know whether you are defining a new method, overriding an existing method with entirely new functionality, or &ldquo;decorating&rdquo; a method with before advice. Using advice can be useful when you want to signal exactly what you are trying to accomplish.</p>

<p>Another reason to prefer method advice is when you want to share some functionality:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">LoggingFoo</code> <code class="o">&lt;</code> <code class="n">SuperFoo</code>

  <code class="n">def</code> <code class="n">one_parameter</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
    <code class="n">log_entry</code>
    <code class="n">returning</code><code class="p">(</code><code class="n">super</code><code class="p">)</code> <code class="n">do</code>
      <code class="n">log_exit</code>
    <code class="k">end</code>
  <code class="k">end</code>

  <code class="n">def</code> <code class="n">two_parameters</code><code class="p">(</code><code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">)</code>
    <code class="n">log_entry</code>
    <code class="n">returning</code><code class="p">(</code><code class="n">super</code><code class="p">)</code> <code class="n">do</code>
      <code class="n">log_exit</code>
    <code class="k">end</code>
  <code class="k">end</code>

<code class="k">end</code>
</pre></div>

</div>

<p>This could be written as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">LoggingFoo</code> <code class="o">&lt;</code> <code class="n">SuperFoo</code>

  <code class="n">include</code> <code class="n">NaiveBeforeMethods</code>

  <code class="n">before</code> <code class="p">:</code><code class="n">one_parameter</code><code class="p">,</code> <code class="p">:</code><code class="n">two_parameters</code> <code class="n">do</code> # <code class="n">see</code> <code class="n">below</code>
    <code class="n">log_entry</code>
  <code class="k">end</code>

  <code class="n">after</code> <code class="p">:</code><code class="n">one_parameter</code><code class="p">,</code> <code class="p">:</code><code class="n">two_parameters</code> <code class="n">do</code>
    <code class="n">log_exit</code>
  <code class="k">end</code>

<code class="k">end</code>
</pre></div>

</div>

<p>This cleanly separates the concern of logging from the mechanism of what the methods actually do</p>

<blockquote>
  <p>Although this is not the main benefit, method advice also works with methods defined in modules and the current class, not just superclasses. So in some ways it is even more flexible than Ruby&rsquo;s <code>super</code> keyword.</p>
</blockquote>

<h3 section-num="6.3" id="the-queer-bird">The Queer Bird</h3>

<p>That looks handy. But we also want an <em>after method</em>, a way to compose methods in the other order. Good news, the Queer Bird combinator is exactly what we want. Written <code>Qxyz = y(xz)</code>, the Ruby equivalent is:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">queer_bird</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">something</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">stuff_to_do_after_we_do_stuff</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">stuff_to_do_after_we_do_stuff</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">something</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">))</code>
</pre></div>

</div>

<p>Which is, of course:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">something</code><code class="p">(</code><code class="n">parameter</code><code class="p">)</code>
  # <code class="n">do</code> <code class="n">stuff</code><code class="p">...</code>
<code class="k">end</code>

<code class="n">after</code> <code class="p">:</code><code class="n">something</code> <code class="n">do</code> <code class="o">|</code><code class="n">return_value</code><code class="o">|</code>
  # <code class="n">stuff</code> <code class="n">to</code> <code class="n">do</code> <code class="n">AFTER</code> <code class="n">we</code> <code class="n">do</code> <code class="n">stuff</code><code class="p">...</code>
<code class="k">end</code>
</pre></div>

</div>

<p>The difference between before and after advice is that after advice is consumes and transforms whatever the method returns, while before advice consumes and transforms the parameters to the method.</p>

<p>We <em>could</em> copy, paste and modify our bluebird code for the before methods to create after methods. But before you rush off to implement that, you might want to think about a few interesting &ldquo;real world&rdquo; requirements:</p>

<ol>
  <li>If you define before and after methods in any order, the final result should be that all of the before methods are run before the main method, then all of the after methods. This is not part of combinatory logic, but it&rsquo;s the standard behaviour people expect from before and after methods.</li>
  <li>You should be able to apply the same advice to more than one method, for example by writing <code>after :foo, :bar do ... end</code></li>
  <li>If you declare parameters for before advice, whatever it returns will be used by the next method, just like the example above. If you do not declare parameters for before advice, whatever it returns should be ignored. The same goes for after advice.</li>
  <li>If you override the main method, the before and after methods should still work.</li>
  <li>The blocks provided should execute in the receiver&rsquo;s scope, like method bodies.</li>
</ol>

<p>One implementation meeting these requirements is in the appendix. Embedded in a lot of extra moving parts, the basic pattern of composing methods is still evident:</p>

<div class="code-block">
  <p class="codeblock-title">naive_before_advice.rb</p>

  <hr />
<div class="highlight"><pre><code class="k">module</code> <code class="nn">NaiveBeforeAdvice</code>

  <code class="k">module</code> <code class="nn">ClassMethods</code>

    <code class="k">def</code> <code class="nf">before</code><code class="p">(</code><code class="n">method_sym</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">block</code><code class="p">)</code>
      <code class="n">old_method</code> <code class="o">=</code> <code class="nb">self</code><code class="o">.</code><code class="n">instance_method</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code>
      <code class="k">if</code> <code class="n">old_method</code><code class="o">.</code><code class="n">arity</code> <code class="o">==</code> <code class="mi">0</code>
        <code class="n">define_method</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code> <code class="k">do</code>
          <code class="n">block</code><code class="o">.</code><code class="n">call</code>
          <code class="n">old_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code>
        <code class="k">end</code>
      <code class="k">else</code>
        <code class="n">define_method</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code> <code class="k">do</code> <code class="o">|*</code><code class="n">params</code><code class="o">|</code>
          <code class="n">old_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="o">*</code><code class="n">block</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="o">*</code><code class="n">params</code><code class="p">))</code>
        <code class="k">end</code>
      <code class="k">end</code>
    <code class="k">end</code>

  <code class="k">end</code>

  <code class="k">def</code> <code class="nc">self</code><code class="o">.</code><code class="nf">included</code><code class="p">(</code><code class="n">receiver</code><code class="p">)</code>
    <code class="n">receiver</code><code class="o">.</code><code class="n">extend</code>         <code class="no">ClassMethods</code>
  <code class="k">end</code>

<code class="k">end</code>
</pre></div>

  <hr />
</div>

<p>That is why we looked at supporting just before methods first. If you are comfortable with the na&iuml;ve implementation of before advice discussed above, the mechanism is easy to understand. The complete version is considerably more powerful. As mentioned, it supports before and after advice. It also uses <code>instance_exec</code> to evaluate the blocks in the receiver&rsquo;s scope, providing access to private methods and instance variables. And it works properly even when you override the method being advised.</p>

<h2 section-num="7" id="mockingbirds">Mockingbirds</h2>

<p>In this chapter, we will meet a combinator that duplicates its arguments, and see how to use it to achieve recursion. Such combinators are called <em>recursive combinators</em>, and are an important foundation for separating the concrete implementation of an algorithm from its definition.</p>

<h3 section-num="7.1" id="duplicative-combinators">Duplicative Combinators</h3>

<p>Almost all of the combinators we&rsquo;ve seen in previous essays about combinators &ldquo;conserve&rdquo; their arguments. For example, if you pass <code>xyz</code> to a <em>Bluebird</em>, you get one <code>x</code>, one <code>y</code>, and one <code>z</code> back, exactly what you passed in. You get <code>x(yz)</code> back, so they have been grouped for you. But nothing has been added and nothing has been taken away. Likewise the <em>Thrush</em> reverses its arguments, but again it answers back the same number arguments you passed to it. The Kestrel, on the other hand, does not conserve its arguments. It <em>erases</em> one. If you pass <code>xy</code> to a Kestrel, you only get <code>x</code> back. The <code>y</code> is erased. Kestrels do not conserve their arguments.</p>

<p>Today we are going to meet another combinator that does not conserve its arguments, the Mockingbird. Where a Kestrel erases one of its arguments, the Mockingbird <em>duplicates</em> its argument. In logic notation, <code>Mx = xx</code>. Or in Ruby:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">mockingbird</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
  #<code class="p">=</code><code class="o">&gt;</code> <code class="n">x</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
</pre></div>

</div>

<p>The Mockingbird is not the only combinator that duplicates one or more of its arguments. Logicians have also found important uses for many other duplicating combinators like the Starling (<code>Sxyz = xz(yz)</code>), which is one half of the <a href="http://en.wikipedia.org/wiki/SKI_combinator_calculus" title="SKI combinator calculus - Wikipedia, the free encyclopedia">SK combinator calculus</a>, and the Turing Bird (<code>Uxy = y(xxy)</code>), which is named after <a href="http://www.alanturing.net/turing_archive/index.html" title="Alan Turing">its discoverer</a>.</p>

<p>The great benefit of duplicative combinators from a <em>theoretical</em> perspective is that combinators that duplicate an argument can be used to introduce recursion without names, scopes, bindings, and other things that clutter things up. Being able to introduce anonymous recursion is very elegant, and <a href="http://www.eecs.harvard.edu/~cduan/technical/ruby/ycombinator.shtml" title="A Use of the Y Combinator in Ruby">there are times when it is useful in its own right</a>.</p>

<h3 section-num="7.2" id="recursive-lambdas-in-ruby">Recursive Lambdas in Ruby</h3>

<p>Let&rsquo;s write a simple recursive combinator in Ruby from first principles. To start with, let&rsquo;s pick a recursive algorithm to implement: We&rsquo;ll <em>sum the numbers of a nested list</em>. In other words, we&rsquo;re going to traverse a tree of numbers and generate the sum of the leaves, a recursive problem.</p>

<blockquote>
  <p>This is a trivial problem in Ruby, <code>[1, [[2,3], [[[4]]]]].flatten.inject(&amp;:+)</code> will do the trick. Of course, it does so by calling <code>.flatten</code>, a built-in method that is itself recursive. However, by picking a really simple example, it&rsquo;s easy to focus on the recursion rather than by the domain-specific parts of our problem. That will make things look a little over-engineered here, but when you&rsquo;re interested in the engineering, that&rsquo;s a good thing.</p>
</blockquote>

<p>So what is our algorithm?</p>

<ol>
  <li>If we are given a number, return it.</li>
  <li>If we are given a list, call ourself for each item of the list and sum the numbers that are returned.</li>
</ol>

<p>In Ruby:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">sum_of_nested_list</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="o">|</code>
  <code class="n">arg</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> ? <code class="n">arg</code> <code class="p">:</code> <code class="n">arg</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">item</code><code class="o">|</code> <code class="n">sum_of_nested_list</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">it</code><code class="o">\</code>
<code class="n">em</code><code class="p">)</code> <code class="p">}.</code><code class="n">inject</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code>
<code class="k">end</code>
</pre></div>

</div>

<p>One reason we don&rsquo;t like this is that it breaks badly if we ever modify the variable <code>sum_of_nested_list</code>. Although you may think that&rsquo;s unlikely, it can happen when writing the method combinators you&rsquo;ve seen in previous chapters. For example, imagine you wanted to write to the log when calling this function, but only once, you don&rsquo;t want to write to the log when it calls itself.</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">old_sum</code> <code class="p">=</code> <code class="n">sum_of_nested_list</code>
<code class="n">sum_of_nested_list</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="o">|</code>
  <code class="n">puts</code> &quot;<code class="n">sum_of_nested_list</code><code class="p">(</code>#<code class="p">{</code><code class="n">arg</code><code class="p">.</code><code class="n">inspect</code><code class="p">})</code>&quot;
  <code class="n">old_sum</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">arg</code><code class="p">)</code>
<code class="k">end</code>

<code class="n">sum_of_nested_list</code><code class="p">.</code><code class="n">call</code><code class="p">([[[[[</code>6<code class="p">]]]]])</code>

  <code class="n">sum_of_nested_list</code><code class="p">([[[[[</code>6<code class="p">]]]]])</code>
  <code class="n">sum_of_nested_list</code><code class="p">([[[[</code>6<code class="p">]]]])</code>
  <code class="n">sum_of_nested_list</code><code class="p">([[[</code>6<code class="p">]]])</code>
  <code class="n">sum_of_nested_list</code><code class="p">([[</code>6<code class="p">]])</code>
  <code class="n">sum_of_nested_list</code><code class="p">([</code>6<code class="p">])</code>
  <code class="n">sum_of_nested_list</code><code class="p">(</code>6<code class="p">)</code>
    #<code class="p">=</code><code class="o">&gt;</code> 6
</pre></div>

</div>

<p>This doesn&rsquo;t work because inside our original <code>sum_of_nested_list</code>, we call <code>sum_of_nested_list</code> by name. If that gets redefined by a method combinator or anything else, we&rsquo;re calling the new thing and not the old one.</p>

<p>Another reason to eschew having lambdas call themselves by name is that we won&rsquo;t be able to create anonymous recursive lambdas. Although naming things is an important part of writing readable software, being able to make anonymous things like object literals opens up a world where everything is truly first class and can be created on the fly or passed around like parameters. So by figuring out how to have lambdas call themselves without using their names, we&rsquo;re figuring out how to make all kinds of lambdas anonymous and flexible, not just the non-recursive ones.</p>

<h3 section-num="7.3" id="recursive-combinatorics">Recursive Combinatorics</h3>

<p>The combinator way around this is to find a way to pass a function to itself as a parameter. If a lambda only ever calls its own parameters, it doesn&rsquo;t depend on anything being bound to a name in its environment. Let&rsquo;s start by rewriting our function to take itself as an argument:</p>

    sum_of_nested_list = lambda do |myself, arg|
<div class="code-block">
<div class="highlight"><pre>  <code class="n">arg</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> ? <code class="n">arg</code> <code class="p">:</code> <code class="n">arg</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">item</code><code class="o">|</code> <code class="n">myself</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">myself</code><code class="p">,</code> <code class="n">item</code><code class="p">)</code> <code class="o">\</code>
<code class="p">}.</code><code class="n">inject</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code>
</pre></div>

</div>
    end

<p>One little problem: How are we going to pass our function to itself? Let&rsquo;s start by <em>currying</em> it into a function that takes one argument, itself, and returns a function that takes an item:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">sum_of_nested_list</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">myself</code><code class="o">|</code>
  <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="o">|</code>
    <code class="n">arg</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> ? <code class="n">arg</code> <code class="p">:</code> <code class="n">arg</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">item</code><code class="o">|</code> <code class="n">myself</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">myself</code><code class="p">).</code><code class="n">call</code><code class="o">\</code>
<code class="p">(</code><code class="n">item</code><code class="p">)</code> <code class="p">}.</code><code class="n">inject</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Notice that we now have <code>myself</code> call itself and have the result call an item. To use it, we have to have it call itself:</p>

    sum_of_nested_list.call(sum_of_nested_list).call([1, [[2,3], [[[4]]]]])
      #=&gt; 10

<p>This works, but is annoying. Writing our function to take itself as an argument and return a function is one thing, we can fix that, but having our function call itself by name defeats the very purpose of the exercise. Let&rsquo;s fix it. First thing we&rsquo;ll do, let&rsquo;s get rid of <code>myself.call(myself).call(item)</code>. We&rsquo;ll use a new parameter, <code>recurse</code> (it&rsquo;s the <em>last</em> parameter in an homage to callback-oriented programming style). We&rsquo;ll pass it <code>myself.call(myself)</code>, thus removing <code>myself.call(myself)</code> from our inner lambda:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">sum_of_nested_list</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">myself</code><code class="o">|</code>
  <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="o">|</code>
    <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="p">,</code> <code class="n">recurse</code><code class="o">|</code>
      <code class="n">arg</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> ? <code class="n">arg</code> <code class="p">:</code> <code class="n">arg</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">item</code><code class="o">|</code> <code class="n">recurse</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">item</code><code class="p">)</code> <code class="p">}.</code><code class="nb">i</code><code class="o">\</code>
<code class="n">nject</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code>
    <code class="k">end</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">arg</code><code class="p">,</code> <code class="n">myself</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">myself</code><code class="p">))</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">sum_of_nested_list</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">sum_of_nested_list</code><code class="p">).</code><code class="n">call</code><code class="p">([</code>1<code class="p">,</code> <code class="p">[[</code>2<code class="p">,</code>3<code class="p">],</code> <code class="p">[[[</code>4<code class="p">]]]]])</code>
</pre></div>

</div>
      #=&gt; 10

<p>Next, we hoist our code out of the middle and make it a parameter. This allows us to get rid of the ` sum_of_nested_list.call(sum_of_nested_list)` by moving it into our lambda:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">sum_of_nested_list</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">fn</code><code class="o">|</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="p">}.</code><code class="n">call</code><code class="p">(</code>
    <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">myself</code><code class="o">|</code>
      <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="o">|</code>
        <code class="n">fn</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">arg</code><code class="p">,</code> <code class="n">myself</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">myself</code><code class="p">))</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="p">)</code>
<code class="k">end</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>
  <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="p">,</code> <code class="n">recurse</code><code class="o">|</code>
    <code class="n">arg</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> ? <code class="n">arg</code> <code class="p">:</code> <code class="n">arg</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">item</code><code class="o">|</code> <code class="n">recurse</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">item</code><code class="p">)</code> <code class="p">}.</code><code class="n">inj</code><code class="o">\</code>
<code class="n">ect</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code>
  <code class="k">end</code>
<code class="p">)</code>

<code class="n">sum_of_nested_list</code><code class="p">.</code><code class="n">call</code><code class="p">([</code>1<code class="p">,</code> <code class="p">[[</code>2<code class="p">,</code>3<code class="p">],</code> <code class="p">[[[</code>4<code class="p">]]]]])</code>
</pre></div>

</div>
      #=&gt; 10

<p>Lots of code there, but let&rsquo;s check and see that it works as an anonymous lambda:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">fn</code><code class="o">|</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="p">}.</code><code class="n">call</code><code class="p">(</code>
    <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">myself</code><code class="o">|</code>
      <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="o">|</code>
        <code class="n">fn</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">arg</code><code class="p">,</code> <code class="n">myself</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">myself</code><code class="p">))</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="p">)</code>
<code class="k">end</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>
  <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="p">,</code> <code class="n">recurse</code><code class="o">|</code>
    <code class="n">arg</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> ? <code class="n">arg</code> <code class="p">:</code> <code class="n">arg</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">item</code><code class="o">|</code> <code class="n">recurse</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">item</code><code class="p">)</code> <code class="p">}.</code><code class="n">inj</code><code class="o">\</code>
<code class="n">ect</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code>
  <code class="k">end</code>
<code class="p">).</code><code class="n">call</code><code class="p">([</code>1<code class="p">,</code> <code class="p">[[</code>2<code class="p">,</code>3<code class="p">],</code> <code class="p">[[[</code>4<code class="p">]]]]])</code>
</pre></div>

</div>
      #=&gt; 10

<p>Looking at this final example, we can see it has two cleanly separated parts:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c"># The recursive combinator</code>

<code class="n">lambda</code> <code class="k">do</code> <code class="o">|</code><code class="n">fn</code><code class="o">|</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="p">}.</code><code class="n">call</code><code class="p">(</code>
    <code class="n">lambda</code> <code class="k">do</code> <code class="o">|</code><code class="n">myself</code><code class="o">|</code>
      <code class="n">lambda</code> <code class="k">do</code> <code class="o">|</code><code class="nb">arg</code><code class="o">|</code>
        <code class="n">fn</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="nb">arg</code><code class="p">,</code> <code class="n">myself</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">myself</code><code class="p">))</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="p">)</code>
<code class="k">end</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>

  <code class="c"># The lambda we wish to make recursive</code>

  <code class="n">lambda</code> <code class="k">do</code> <code class="o">|</code><code class="nb">arg</code><code class="p">,</code> <code class="n">recurse</code><code class="o">|</code>
    <code class="nb">arg</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> ? <code class="nb">arg</code> <code class="p">:</code> <code class="nb">arg</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">item</code><code class="o">|</code> <code class="n">recurse</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">item</code><code class="p">)</code> <code class="p">}.</code><code class="n">inj</code><code class="o">\</code>
<code class="n">ect</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code>
  <code class="k">end</code>

<code class="p">)</code>
</pre></div>

</div>

<h3 section-num="7.4" id="recursive-combinators-in-idiomatic-ruby">Recursive Combinators in Idiomatic Ruby</h3>

<p>We&rsquo;ve now managed to separate the mechanism of recursing (the combinator) from what we want to do while recursing. Let&rsquo;s formalize this and make it idiomatic Ruby. We&rsquo;ll make it a method for creating recursive lambdas and call it with a block instead of a lambda:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">lambda_with_recursive_callback</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">x</code><code class="p">)</code> <code class="p">}.</code><code class="n">call</code><code class="p">(</code>
    <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">myself</code><code class="o">|</code>
      <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="o">|</code>
        <code class="n">yield</code><code class="p">(</code><code class="n">arg</code><code class="p">,</code> <code class="n">myself</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">myself</code><code class="p">))</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="p">)</code>
<code class="k">end</code>

<code class="n">sum_of_nested_list</code> <code class="p">=</code> <code class="n">lambda_with_recursive_callback</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="p">,</code> <code class="n">recurse</code><code class="o">|</code>
  <code class="n">arg</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> ? <code class="n">arg</code> <code class="p">:</code> <code class="n">arg</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">item</code><code class="o">|</code> <code class="n">recurse</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">item</code><code class="p">)</code> <code class="p">}.</code><code class="n">injec</code><code class="o">\</code>
<code class="n">t</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code>
<code class="k">end</code>

<code class="n">sum_of_nested_list</code><code class="p">.</code><code class="n">call</code><code class="p">([</code>1<code class="p">,</code> <code class="p">[[</code>2<code class="p">,</code>3<code class="p">],</code> <code class="p">[[[</code>4<code class="p">]]]]])</code>
</pre></div>

</div>
      #=&gt; 10

<p>Not bad. But hey, let&rsquo;s DRY things up. Aren&rsquo;t <code>x.call(x)</code> and <code>myself.call(myself)</code> the same thing?</p>

<h3 section-num="7.5" id="the-mockingbird">The Mockingbird</h3>

<p>Yes, <code>x.call(x)</code> and <code>myself.call(myself)</code> <em>are</em> the same thing:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">mockingbird</code> <code class="o">&amp;</code><code class="n">x</code>
  <code class="n">x</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">x</code><code class="p">)</code>
<code class="k">end</code>

<code class="n">def</code> <code class="n">lambda_with_recursive_callback</code>
  <code class="n">mockingbird</code> <code class="n">do</code> <code class="o">|</code><code class="n">myself</code><code class="o">|</code>
    <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="o">|</code>
      <code class="n">yield</code><code class="p">(</code><code class="n">arg</code><code class="p">,</code> <code class="n">mockingbird</code><code class="p">(</code><code class="o">&amp;</code><code class="n">myself</code><code class="p">))</code>
    <code class="k">end</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">sum_of_nested_list</code> <code class="p">=</code> <code class="n">lambda_with_recursive_callback</code> <code class="n">do</code> <code class="o">|</code><code class="n">arg</code><code class="p">,</code> <code class="n">recurse</code><code class="o">|</code>
  <code class="n">arg</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> ? <code class="n">arg</code> <code class="p">:</code> <code class="n">arg</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">item</code><code class="o">|</code> <code class="n">recurse</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">item</code><code class="p">)</code> <code class="p">}.</code><code class="n">injec</code><code class="o">\</code>
<code class="n">t</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code>
<code class="k">end</code>

<code class="n">sum_of_nested_list</code><code class="p">.</code><code class="n">call</code><code class="p">([</code>1<code class="p">,</code> <code class="p">[[</code>2<code class="p">,</code>3<code class="p">],</code> <code class="p">[[[</code>4<code class="p">]]]]])</code>
</pre></div>

</div>
      #=&gt; 10

<p>But does it blend?</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">lambda_with_recursive_callback</code> <code class="p">{</code> <code class="o">|</code><code class="n">arg</code><code class="p">,</code> <code class="n">recurse</code><code class="o">|</code>
  <code class="n">arg</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> ? <code class="n">arg</code> <code class="p">:</code> <code class="n">arg</code><code class="p">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">item</code><code class="o">|</code> <code class="n">recurse</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">item</code><code class="p">)</code> <code class="p">}.</code><code class="n">injec</code><code class="o">\</code>
<code class="n">t</code><code class="p">(</code><code class="o">&amp;</code><code class="p">:</code><code class="o">+</code><code class="p">)</code>
<code class="p">}.</code><code class="n">call</code><code class="p">([</code>1<code class="p">,</code> <code class="p">[[</code>2<code class="p">,</code>3<code class="p">],</code> <code class="p">[[[</code>4<code class="p">]]]]])</code>
</pre></div>

</div>
      #=&gt; 10

<p>Yes!</p>

<p>And now we have our finished recursive combinator. We are able to create recursive lambdas in Ruby without relying on environment variables, just on parameters passed to blocks or lambdas. Our recursive combinator is built on the simplest and most basic of duplicating combinators, the Mockingbird.</p>

<p>In the next chapter, we&rsquo;ll build more sophisticated (and practical) recursive combinators. And while doing so, we&rsquo;ll take an aggressive approach to separating interfaces from implementations in algorithms.</p>

<h2 section-num="8" id="refactoring-methods-with-recursive-combinators">Refactoring Methods with Recursive Combinators</h2>

<p>In previous chapters, we have met some of Combinatory Logic&rsquo;s most interesting combinators like the Kestrel, Thrush, Cardinal, Quirky Bird, and Bluebird. Today we are going to learn how combinators can help us separate the general form of an algorithm like &ldquo;divide and conquer&rdquo; from its specific concrete steps. Consider the method <code>#sum_squares</code>: It sums the squares of a tree of numbers, represented as a nested list.</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">sum_squares</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="k">if</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code>
    <code class="n">value</code><code class="p">.</code><code class="n">map</code> <code class="n">do</code> <code class="o">|</code><code class="n">sub_value</code><code class="o">|</code>
      <code class="n">sum_squares</code><code class="p">(</code><code class="n">sub_value</code><code class="p">)</code>
    <code class="k">end</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code>
  <code class="k">else</code>
    <code class="n">value</code> <code class="o">**</code> 2
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">p</code> <code class="n">sum_squares</code><code class="p">([</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">,</code> <code class="p">[[</code>4<code class="p">,</code>5<code class="p">],</code> 6<code class="p">],</code> <code class="p">[[[</code>7<code class="p">]]]])</code>
  <code class="p">=</code><code class="o">&gt;</code> 140
</pre></div>

</div>

<p>And the method <code>#rotate</code>: It rotates a square matrix, provided the length of each side is a power of two:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">rotate</code><code class="p">(</code><code class="n">square</code><code class="p">)</code>
  <code class="k">if</code> <code class="n">square</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="n">square</code><code class="p">.</code><code class="nb">size</code> <code class="o">&gt;</code> 1
    <code class="n">half_sz</code> <code class="p">=</code> <code class="n">square</code><code class="p">.</code><code class="nb">size</code> <code class="o">/</code> 2
    <code class="n">sub_square</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">row</code><code class="p">,</code> <code class="n">col</code><code class="o">|</code>
      <code class="n">square</code><code class="p">.</code><code class="n">slice</code><code class="p">(</code><code class="n">row</code><code class="p">,</code> <code class="n">half_sz</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">a_row</code><code class="o">|</code> <code class="n">a_row</code><code class="p">.</code><code class="n">slice</code><code class="p">(</code><code class="n">col</code><code class="p">,</code> <code class="n">half_sz</code><code class="p">)</code> <code class="p">}</code>
    <code class="k">end</code>
    <code class="n">upper_left</code> <code class="p">=</code> <code class="n">rotate</code><code class="p">(</code><code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>0<code class="p">,</code>0<code class="p">))</code>
    <code class="n">lower_left</code> <code class="p">=</code> <code class="n">rotate</code><code class="p">(</code><code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">half_sz</code><code class="p">,</code>0<code class="p">))</code>
    <code class="n">upper_right</code> <code class="p">=</code> <code class="n">rotate</code><code class="p">(</code><code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>0<code class="p">,</code><code class="n">half_sz</code><code class="p">))</code>
    <code class="n">lower_right</code> <code class="p">=</code> <code class="n">rotate</code><code class="p">(</code><code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">half_sz</code><code class="p">,</code><code class="n">half_sz</code><code class="p">))</code>
    <code class="n">upper_right</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">lower_right</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">l</code><code class="p">,</code><code class="n">r</code><code class="o">|</code> <code class="n">l</code> <code class="o">+</code> <code class="n">r</code> <code class="p">}</code> <code class="o">+</code>
      <code class="n">upper_left</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">lower_left</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">l</code><code class="p">,</code><code class="n">r</code><code class="o">|</code> <code class="n">l</code> <code class="o">+</code> <code class="n">r</code> <code class="p">}</code>
  <code class="k">else</code>
    <code class="n">square</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">p</code> <code class="n">rotate</code><code class="p">([[</code>1<code class="p">,</code>2<code class="p">,</code>3<code class="p">,</code>4<code class="p">],</code> <code class="p">[</code>5<code class="p">,</code>6<code class="p">,</code>7<code class="p">,</code>8<code class="p">],</code> <code class="p">[</code>9<code class="p">,</code>10<code class="p">,</code>11<code class="p">,</code>12<code class="p">],</code> <code class="p">[</code>13<code class="p">,</code>14<code class="p">,</code>15<code class="p">,</code>16<code class="p">]])</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">[[</code>4<code class="p">,</code> 8<code class="p">,</code> 12<code class="p">,</code> 16<code class="p">],</code> <code class="p">[</code>3<code class="p">,</code> 7<code class="p">,</code> 11<code class="p">,</code> 15<code class="p">],</code> <code class="p">[</code>2<code class="p">,</code> 6<code class="p">,</code> 10<code class="p">,</code> 14<code class="p">],</code> <code class="p">[</code>1<code class="p">,</code> 5<code class="p">,</code> 9<code class="p">,</code> 13<code class="p">]]</code>
</pre></div>

</div>

<p>Our challenge is to refactor them. You could change <code>sub_square</code> from a closure to a private method (and in languages like Java, you have to do that in the first place). What else? Is there any common behaviour we can extract from these two methods?</p>

<p>Looking at the two methods, there are no lines of code that are so obviously identical that we could mechanically extract them into a private helper. Automatic refactoring tools fall down given these two methods. And yet, there is a really, really important refactoring that should be performed here.</p>

<h3 section-num="8.1" id="divide-and-conquer">Divide and Conquer</h3>

<p>Both of these methods use the <a href="http://www.cs.berkeley.edu/~vazirani/algorithms/chap2.pdf">Divide and Conquer</a> strategy.</p>

<p>As described, there are two parts to each divide and conquer algorithm. We&rsquo;ll start with conquer: you need a way to decide if the problem is simple enough to solve in a trivial manner, and a trivial solution. You&rsquo;ll also need a way to divide the problem into sub-problems if it&rsquo;s too complex for the trivial solution, and a way to recombine the pieces back into the solution. The entire process is carried our recursively.</p>

<p>For example, here&rsquo;s how <code>#rotate</code> rotated the square. We started with a square matrix of size 4:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code>
  <code class="p">[</code>  1<code class="p">,</code>  2<code class="p">,</code>  3<code class="p">,</code>  4<code class="p">],</code>
  <code class="p">[</code>  5<code class="p">,</code>  6<code class="p">,</code>  7<code class="p">,</code>  8<code class="p">],</code>
  <code class="p">[</code>  9<code class="p">,</code> 10<code class="p">,</code> 11<code class="p">,</code> 12<code class="p">],</code>
  <code class="p">[</code> 13<code class="p">,</code> 14<code class="p">,</code> 15<code class="p">,</code> 16<code class="p">]</code>
<code class="p">]</code>
</pre></div>

</div>

<p>That cannot be rotated trivially, so we divided it into four smaller sub-squares:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code>            <code class="p">[</code>
  <code class="p">[</code>  1<code class="p">,</code>  2<code class="p">],</code>   <code class="p">[</code>  3<code class="p">,</code>  4<code class="p">],</code>
  <code class="p">[</code>  5<code class="p">,</code>  6<code class="p">]</code>    <code class="p">[</code>  7<code class="p">,</code>  8<code class="p">]</code>
<code class="p">]</code>            <code class="p">]</code>

<code class="p">[</code>            <code class="p">[</code>
  <code class="p">[</code>  9<code class="p">,</code> 10<code class="p">],</code>   <code class="p">[</code> 11<code class="p">,</code> 12<code class="p">],</code>
  <code class="p">[</code> 13<code class="p">,</code> 14<code class="p">]</code>    <code class="p">[</code> 15<code class="p">,</code> 16<code class="p">]</code>
<code class="p">]</code>            <code class="p">]</code>
</pre></div>

</div>

<p>Those couldn&rsquo;t be rotated trivially either, so our algorithm divide each of them into four smaller squares again, giving us sixteen squares of one number each. Those are small enough to rotate trivially (they do not change), so the algorithm could stop subdividing.</p>

<p>We said there was a recombination step. For <code>#rotate</code>, four sub-squares are recombined into one square by moving them counter-clockwise 90 degrees. The sixteen smallest squares were recombined into four sub-squares like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code>            <code class="p">[</code>
  <code class="p">[</code>  2<code class="p">,</code>  6<code class="p">],</code>   <code class="p">[</code>  4<code class="p">,</code>  8<code class="p">],</code>
  <code class="p">[</code>  1<code class="p">,</code>  5<code class="p">]</code>    <code class="p">[</code>  3<code class="p">,</code>  7<code class="p">]</code>
<code class="p">]</code>            <code class="p">]</code>

<code class="p">[</code>            <code class="p">[</code>
  <code class="p">[</code> 10<code class="p">,</code> 14<code class="p">],</code>   <code class="p">[</code> 12<code class="p">,</code> 16<code class="p">],</code>
  <code class="p">[</code>  9<code class="p">,</code> 13<code class="p">]</code>    <code class="p">[</code> 11<code class="p">,</code> 15<code class="p">]</code>
<code class="p">]</code>            <code class="p">]</code>
</pre></div>

</div>

<p>Then those four squares were recombined into the final result like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code>            <code class="p">[</code>
  <code class="p">[</code>  4<code class="p">,</code>  8<code class="p">],</code>   <code class="p">[</code> 12<code class="p">,</code> 16<code class="p">],</code>
  <code class="p">[</code>  3<code class="p">,</code>  7<code class="p">]</code>    <code class="p">[</code> 11<code class="p">,</code> 15<code class="p">]</code>
<code class="p">]</code>            <code class="p">]</code>

<code class="p">[</code>            <code class="p">[</code>
  <code class="p">[</code>  2<code class="p">,</code>  6<code class="p">],</code>   <code class="p">[</code> 10<code class="p">,</code> 14<code class="p">],</code>
  <code class="p">[</code>  1<code class="p">,</code>  5<code class="p">]</code>    <code class="p">[</code>  9<code class="p">,</code> 13<code class="p">]</code>
<code class="p">]</code>
</pre></div>

</div>

<p>And smooshed (that is the technical term) back together:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code>
  <code class="p">[</code>  4<code class="p">,</code>  8<code class="p">,</code>  12<code class="p">,</code> 16<code class="p">],</code>
  <code class="p">[</code>  3<code class="p">,</code>  7<code class="p">,</code>  11<code class="p">,</code> 15<code class="p">],</code>
  <code class="p">[</code>  2<code class="p">,</code>  6<code class="p">,</code>  10<code class="p">,</code> 14<code class="p">],</code>
  <code class="p">[</code>  1<code class="p">,</code>  5<code class="p">,</code>   9<code class="p">,</code> 13<code class="p">]</code>
<code class="p">]</code>
</pre></div>

</div>

<p>And Voila! There is your rotated square matrix.</p>

<p>Both rotation and summing the squares of a tree combine the four steps of a divide and conquer strategy:</p>

<ol>
  <li>Deciding whether the problem is divisible into smaller pieces or can be solved trivially,</li>
  <li>A solution fro the trivial case,</li>
  <li>A way to divide a non-trivial problem up,</li>
  <li>And a way to piece it back together.</li>
</ol>

<p>Here are the two methods re-written to highlight the common strategy. First, <code>#sum_squares_2</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">public</code>

<code class="n">def</code> <code class="n">sum_squares_2</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="k">if</code> <code class="n">sum_squares_divisible</code>?<code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">sum_squares_recombine</code><code class="p">(</code>
      <code class="n">sum_squares_divide</code><code class="p">(</code><code class="n">value</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">sub_value</code><code class="o">|</code> <code class="n">sum_squares_2</code><code class="p">(</code><code class="n">sub_value</code><code class="p">)</code> <code class="o">\</code>
<code class="p">}</code>
    <code class="p">)</code>
  <code class="k">else</code>
    <code class="n">sum_squares_conquer</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">private</code>

<code class="n">def</code> <code class="n">sum_squares_divisible</code>?<code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code>
<code class="k">end</code>

<code class="n">def</code> <code class="n">sum_squares_conquer</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="n">value</code> <code class="o">**</code> 2
<code class="k">end</code>

<code class="n">def</code> <code class="n">sum_squares_divide</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="n">value</code>
<code class="k">end</code>

<code class="n">def</code> <code class="n">sum_squares_recombine</code><code class="p">(</code><code class="n">values</code><code class="p">)</code>
  <code class="n">values</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code>
<code class="k">end</code>
</pre></div>

</div>

<p>And <code>#rotate_2</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">public</code>

<code class="n">def</code> <code class="n">rotate_2</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="k">if</code> <code class="n">rotate_divisible</code>?<code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">rotate_recombine</code><code class="p">(</code>
      <code class="n">rotate_divide</code><code class="p">(</code><code class="n">value</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">sub_value</code><code class="o">|</code> <code class="n">rotate_2</code><code class="p">(</code><code class="n">sub_value</code><code class="p">)</code> <code class="p">}</code>
    <code class="p">)</code>
  <code class="k">else</code>
    <code class="n">rotate_conquer</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">private</code>

<code class="n">def</code> <code class="n">rotate_divisible</code>?<code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="n">value</code><code class="p">.</code><code class="nb">size</code> <code class="o">&gt;</code> 1
<code class="k">end</code>

<code class="n">def</code> <code class="n">rotate_conquer</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="n">value</code>
<code class="k">end</code>

<code class="n">def</code> <code class="n">rotate_divide</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="n">half_sz</code> <code class="p">=</code> <code class="n">value</code><code class="p">.</code><code class="nb">size</code> <code class="o">/</code> 2
  <code class="n">sub_square</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">row</code><code class="p">,</code> <code class="n">col</code><code class="o">|</code>
    <code class="n">value</code><code class="p">.</code><code class="n">slice</code><code class="p">(</code><code class="n">row</code><code class="p">,</code> <code class="n">half_sz</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">a_row</code><code class="o">|</code> <code class="n">a_row</code><code class="p">.</code><code class="n">slice</code><code class="p">(</code><code class="n">col</code><code class="p">,</code> <code class="n">half_sz</code><code class="p">)</code> <code class="p">}</code>
  <code class="k">end</code>
  <code class="n">upper_left</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>0<code class="p">,</code>0<code class="p">)</code>
  <code class="n">lower_left</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">half_sz</code><code class="p">,</code>0<code class="p">)</code>
  <code class="n">upper_right</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>0<code class="p">,</code><code class="n">half_sz</code><code class="p">)</code>
  <code class="n">lower_right</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">half_sz</code><code class="p">,</code><code class="n">half_sz</code><code class="p">)</code>
  <code class="p">[</code><code class="n">upper_left</code><code class="p">,</code> <code class="n">lower_left</code><code class="p">,</code> <code class="n">upper_right</code><code class="p">,</code> <code class="n">lower_right</code><code class="p">]</code>
<code class="k">end</code>

<code class="n">def</code> <code class="n">rotate_recombine</code><code class="p">(</code><code class="n">values</code><code class="p">)</code>
  <code class="n">upper_left</code><code class="p">,</code> <code class="n">lower_left</code><code class="p">,</code> <code class="n">upper_right</code><code class="p">,</code> <code class="n">lower_right</code> <code class="p">=</code> <code class="n">values</code>
  <code class="n">upper_right</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">lower_right</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">l</code><code class="p">,</code><code class="n">r</code><code class="o">|</code> <code class="n">l</code> <code class="o">+</code> <code class="n">r</code> <code class="p">}</code> <code class="o">+</code>
  <code class="n">upper_left</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">lower_left</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">l</code><code class="p">,</code><code class="n">r</code><code class="o">|</code> <code class="n">l</code> <code class="o">+</code> <code class="n">r</code> <code class="p">}</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Now the common code is glaringly obvious. The main challenge in factoring it into a helper is deciding whether you want to represent methods like <code>#rotate_divide</code> as lambdas or want to fool around specifying method names as symbols. Let&rsquo;s go with lambdas for the sake of writing a clear example:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">public</code>

<code class="n">def</code> <code class="n">sum_squares_3</code><code class="p">(</code><code class="n">list</code><code class="p">)</code>
  <code class="n">divide_and_conquer</code><code class="p">(</code>
    <code class="n">list</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="p">},</code>
    <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> 2 <code class="p">},</code>
    <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
    <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code> <code class="p">}</code>
  <code class="p">)</code>
<code class="k">end</code>

<code class="n">def</code> <code class="n">rotate_3</code><code class="p">(</code><code class="n">square</code><code class="p">)</code>
  <code class="n">divide_and_conquer</code><code class="p">(</code>
    <code class="n">square</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="n">value</code><code class="p">.</code><code class="n">siz</code><code class="o">\</code>
<code class="n">e</code> <code class="o">&gt;</code> 1 <code class="p">},</code>
    <code class="p">:</code><code class="n">conquer</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
    <code class="p">:</code><code class="n">divide</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">square</code><code class="o">|</code>
      <code class="n">half_sz</code> <code class="p">=</code> <code class="n">square</code><code class="p">.</code><code class="nb">size</code> <code class="o">/</code> 2
      <code class="n">sub_square</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">row</code><code class="p">,</code> <code class="n">col</code><code class="o">|</code>
        <code class="n">square</code><code class="p">.</code><code class="n">slice</code><code class="p">(</code><code class="n">row</code><code class="p">,</code> <code class="n">half_sz</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">a_row</code><code class="o">|</code> <code class="n">a_row</code><code class="p">.</code><code class="n">slice</code><code class="p">(</code><code class="n">col</code><code class="p">,</code> <code class="n">half_sz</code><code class="p">)</code> <code class="p">}</code>
      <code class="k">end</code>
      <code class="n">upper_left</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>0<code class="p">,</code>0<code class="p">)</code>
      <code class="n">lower_left</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">half_sz</code><code class="p">,</code>0<code class="p">)</code>
      <code class="n">upper_right</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>0<code class="p">,</code><code class="n">half_sz</code><code class="p">)</code>
      <code class="n">lower_right</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">half_sz</code><code class="p">,</code><code class="n">half_sz</code><code class="p">)</code>
      <code class="p">[</code><code class="n">upper_left</code><code class="p">,</code> <code class="n">lower_left</code><code class="p">,</code> <code class="n">upper_right</code><code class="p">,</code> <code class="n">lower_right</code><code class="p">]</code>
    <code class="k">end</code><code class="p">,</code>
    <code class="p">:</code><code class="n">recombine</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code>
      <code class="n">upper_left</code><code class="p">,</code> <code class="n">lower_left</code><code class="p">,</code> <code class="n">upper_right</code><code class="p">,</code> <code class="n">lower_right</code> <code class="p">=</code> <code class="n">list</code>
      <code class="n">upper_right</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">lower_right</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">l</code><code class="p">,</code><code class="n">r</code><code class="o">|</code> <code class="n">l</code> <code class="o">+</code> <code class="n">r</code> <code class="p">}</code> <code class="o">+</code>
      <code class="n">upper_left</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">lower_left</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">l</code><code class="p">,</code><code class="n">r</code><code class="o">|</code> <code class="n">l</code> <code class="o">+</code> <code class="n">r</code> <code class="p">}</code>
    <code class="k">end</code>
  <code class="p">)</code>
<code class="k">end</code>

<code class="n">private</code>

<code class="n">def</code> <code class="n">divide_and_conquer</code><code class="p">(</code><code class="n">value</code><code class="p">,</code> <code class="n">steps</code><code class="p">)</code>
  <code class="k">if</code> <code class="n">steps</code><code class="p">[:</code><code class="n">divisible</code>?<code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">steps</code><code class="p">[:</code><code class="n">recombine</code><code class="p">].</code><code class="n">call</code><code class="p">(</code>
      <code class="n">steps</code><code class="p">[:</code><code class="n">divide</code><code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">sub_value</code><code class="o">|</code> <code class="n">divide_and_conquer</code><code class="p">(</code><code class="n">sub_v</code><code class="o">\</code>
<code class="n">alue</code><code class="p">,</code> <code class="n">steps</code><code class="p">)</code> <code class="p">}</code>
    <code class="p">)</code>
  <code class="k">else</code>
    <code class="n">steps</code><code class="p">[:</code><code class="n">conquer</code><code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Now we have refactored the common algorithm out. Typically, something like divide and conquer is treated as a &ldquo;pattern,&rdquo; a recipe for writing methods. We have changed it into an <em>abstraction</em> by writing a <code>#divide_and_conquer</code> method and passing it our own functions which it combines to form the final algorithm. That ought to sound familiar: <code>#divide_and_conquer</code> is a <em>combinator</em> that creates recursive methods for us.</p>

<p>You can also find recursive combinators in other languages like Joy, Factor, and even Javascript (the recursive combinator presented here as <code>#divide_and_conquer</code> is normally called <code>multirec</code>). Eugene Lazutkin&rsquo;s article on [Using recursion combinators in JavaScript](http://lazutkin.com/blog/2008/jun/30/using-recursion-combinators-javascript/ &ldquo;&rdquo;) shows how to use combinators to build divide and conquer algorithms in Javascript with the Dojo libraries. This example uses <code>binrec</code>, a recursive combinator for algorithms that always divide their problems in two:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">var</code> <code class="n">fib0</code> <code class="p">=</code> <code class="k">function</code><code class="p">(</code><code class="n">n</code><code class="p">){</code>
    <code class="k">return</code> <code class="n">n</code> <code class="o">&lt;</code><code class="p">=</code> 1 ? 1 <code class="p">:</code>
        <code class="n">arguments</code><code class="p">.</code><code class="n">callee</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">n</code> <code class="o">-</code> 1<code class="p">)</code> <code class="o">+</code>
            <code class="n">arguments</code><code class="p">.</code><code class="n">callee</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">n</code> <code class="o">-</code> 2<code class="p">);</code>
<code class="p">};</code>

<code class="n">var</code> <code class="n">fib1</code> <code class="p">=</code> <code class="n">binrec</code><code class="p">(</code>&quot;<code class="o">&lt;</code><code class="p">=</code> 1&quot;<code class="p">,</code> &quot;1&quot;<code class="p">,</code> &quot;<code class="p">[[</code><code class="n">n</code> <code class="o">-</code> 1<code class="p">],</code> <code class="p">[</code><code class="n">n</code> <code class="o">-</code> 2<code class="p">]]</code>&quot;<code class="p">,</code> &quot;<code class="o">+</code>&quot;<code class="p">);</code>
</pre></div>

</div>

<h3 section-num="8.2" id="the-merge-sort">The Merge Sort</h3>

<p>Let&rsquo;s look at another example, implementing a <a href="http://en.wikipedia.org/wiki/Merge_sort" title="Merge sort - Wikipedia, the free encyclopedia">merge sort</a>. This algorithm has a distinguished pedigree: It was invented by John Von Neumann in 1945. </p>

<blockquote>
  <p>Von Neumann was a brilliant and fascinating individual. he is most famous amongst Computer Scientists for formalizing the computer architecture which now bears his name. he also worked on game theory, and it was no game to him: He hoped to use math to advise the United States whether an when to launch a thermonuclear war on the USSR. If you are interested in reading more, <a href="http://www.amazon.com/gp/product/038541580X?ie=UTF8&amp;tag=raganwald001-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=038541580X" title="Amazon.com: Prisoner's Dilemma: William Poundstone: Books">Prisoner&rsquo;s Dilemma</a> is a very fine book about both game theory and one of the great minds of modern times.</p>
</blockquote>

<p>Conceptually, a merge sort works as follows:</p>

<ul>
  <li>If the list is of length 0 or 1, then it is already sorted.</li>
  <li>Otherwise:
    <ol>
      <li>Divide the unsorted list into two sublists of about half the size.</li>
      <li>Sort each sublist recursively by re-applying merge sort.</li>
      <li>Merge the two sublists back into one sorted list.</li>
    </ol>
  </li>
</ul>

<p>The merge sort part will be old hat given our <code>#divide_and_conquer</code> helper:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">merge_sort</code><code class="p">(</code><code class="n">list</code><code class="p">)</code>
  <code class="n">divide_and_conquer</code><code class="p">(</code>
    <code class="n">list</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="nb">length</code> <code class="o">&gt;</code> 1 <code class="p">},</code>
    <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code> <code class="p">},</code>
    <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code>
      <code class="n">half_index</code> <code class="p">=</code> <code class="p">(</code><code class="n">list</code><code class="p">.</code><code class="nb">length</code> <code class="o">/</code> 2<code class="p">)</code> <code class="o">-</code> 1
      <code class="p">[</code> <code class="n">list</code><code class="p">[</code>0<code class="p">..</code><code class="n">half_index</code><code class="p">],</code> <code class="n">list</code><code class="p">[(</code><code class="n">half_index</code> <code class="o">+</code> 1<code class="p">)..</code><code class="o">-</code>1<code class="p">]</code> <code class="p">]</code>
    <code class="k">end</code><code class="p">,</code>
    <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code> <code class="n">merge_two_sorted_lists</code><code class="p">(</code><code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="n">pair</code><code class="o">.\</code>
<code class="n">last</code><code class="p">)</code> <code class="p">}</code>
  <code class="p">)</code>
<code class="k">end</code>
</pre></div>

</div>

<p>The interesting part is our <code>#merge_two_sorted_lists</code> method. Given two sorted lists, our merge algorithm works like this:</p>

<ul>
  <li>If either list is of length zero, return the other list.</li>
  <li>Otherwise:
    <ol>
      <li>Compare the first item of each list using <code>&lt;=&gt;</code>. Let&rsquo;s call the list which has the &ldquo;preceding&rdquo; first item the preceding list and the list which has the &ldquo;following&rdquo; first item the following list.</li>
      <li>Create a pair of lists consisting of the preceding item and an empty list, and another pair of lists consisting of the remainder of the preceding list and the entire following list.</li>
      <li>Merge each pair of lists recursively by applying merge two sorted lists.</li>
      <li>Catenate the results together.</li>
    </ol>
  </li>
</ul>

<p>As you can tell from the description, this is another divide and conquer algorithm:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">merge_two_sorted_lists</code><code class="p">(</code><code class="o">*</code><code class="n">pair</code><code class="p">)</code>
  <code class="n">divide_and_conquer</code><code class="p">(</code>
    <code class="n">pair</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code> !<code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">empty</code>? <code class="o">&amp;&amp;</code> !<code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">.</code><code class="n">empty</code>? <code class="o">\</code>
<code class="p">},</code>
    <code class="p">:</code><code class="n">conquer</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code>
      <code class="k">if</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">empty</code>? <code class="o">&amp;&amp;</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">.</code><code class="n">empty</code>?
        <code class="p">[]</code>
      <code class="n">elsif</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">empty</code>?
        <code class="n">pair</code><code class="p">.</code><code class="n">last</code>
      <code class="k">else</code>
        <code class="n">pair</code><code class="p">.</code><code class="n">first</code>
      <code class="k">end</code>
    <code class="k">end</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divide</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code>
      <code class="n">preceding</code><code class="p">,</code> <code class="n">following</code> <code class="p">=</code> <code class="k">case</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">first</code> <code class="o">&lt;</code><code class="p">=</code><code class="o">&gt;</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">.</code><code class="n">first</code>
        <code class="n">when</code> <code class="o">-</code>1<code class="p">:</code> <code class="p">[</code><code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">]</code>
        <code class="n">when</code> 0<code class="p">:</code>  <code class="p">[</code><code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">]</code>
        <code class="n">when</code> 1<code class="p">:</code>  <code class="p">[</code><code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">,</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">]</code>
      <code class="k">end</code>
      <code class="p">[</code>
        <code class="p">[[</code><code class="n">preceding</code><code class="p">.</code><code class="n">first</code><code class="p">],</code> <code class="p">[]],</code>
        <code class="p">[</code><code class="n">preceding</code><code class="p">[</code>1<code class="p">..</code><code class="o">-</code>1<code class="p">],</code> <code class="n">following</code><code class="p">]</code>
      <code class="p">]</code>
    <code class="k">end</code><code class="p">,</code>
    <code class="p">:</code><code class="n">recombine</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code> <code class="o">+</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code> <code class="p">}</code>
  <code class="p">)</code>
<code class="k">end</code>
</pre></div>

</div>

<p>That&rsquo;s great. Well, that&rsquo;s barely ok, actually. The problem is that when doing our merge sort, when we decide which item is the preceding item (least most, front most, whatever you want to call it), we already know that it is a trivial item and that it doesn&rsquo;t need any further merging. The only reason we bundle it up in <code>[[preceding.first], []]</code> is because our <code>#divide_and_conquer</code> method expects to recursively attempt to solve all of the sub-problems we generate.</p>

<p>In this case, <code>#merge_two_sorted_lists</code> does not really divide a problem into a list of one or more sub-problems, some of which may or may not be trivially solvable. Instead, it divides a problem into a part of the solution and a single sub-problem which may or may not be trivially solvable. This common strategy also has a name, <a href="http://www.csse.monash.edu.au/~lloyd/tildeAlgDS/Recn/Linear/" title="Linear Recursion">linear recursion</a>.</p>

<p>Let&rsquo;s write another version of <code>#merge_two_sorted_lists</code>, but his time instead of using <code>#divide_and_conquer</code>, we&rsquo;ll write a linear recursion combinator:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">merge_two_sorted_lists</code><code class="p">(</code><code class="o">*</code><code class="n">pair</code><code class="p">)</code>
  <code class="n">linear_recursion</code><code class="p">(</code>
    <code class="n">pair</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code> !<code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">empty</code>? <code class="o">&amp;&amp;</code> !<code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">.</code><code class="n">empty</code>? <code class="o">\</code>
<code class="p">},</code>
    <code class="p">:</code><code class="n">conquer</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code>
      <code class="k">if</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">empty</code>? <code class="o">&amp;&amp;</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">.</code><code class="n">empty</code>?
        <code class="p">[]</code>
      <code class="n">elsif</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">empty</code>?
        <code class="n">pair</code><code class="p">.</code><code class="n">last</code>
      <code class="k">else</code>
        <code class="n">pair</code><code class="p">.</code><code class="n">first</code>
      <code class="k">end</code>
    <code class="k">end</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divide</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code>
      <code class="n">preceding</code><code class="p">,</code> <code class="n">following</code> <code class="p">=</code> <code class="k">case</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">first</code> <code class="o">&lt;</code><code class="p">=</code><code class="o">&gt;</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">.</code><code class="n">first</code>
        <code class="n">when</code> <code class="o">-</code>1<code class="p">:</code> <code class="p">[</code><code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">]</code>
        <code class="n">when</code> 0<code class="p">:</code>  <code class="p">[</code><code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">]</code>
        <code class="n">when</code> 1<code class="p">:</code>  <code class="p">[</code><code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">,</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">]</code>
      <code class="k">end</code>
      <code class="p">[</code> <code class="n">preceding</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="p">[</code><code class="n">preceding</code><code class="p">[</code>1<code class="p">..</code><code class="o">-</code>1<code class="p">],</code> <code class="n">following</code><code class="p">]</code> <code class="p">]</code>
    <code class="k">end</code><code class="p">,</code>
    <code class="p">:</code><code class="n">recombine</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">trivial_bit</code><code class="p">,</code> <code class="n">divisible_bit</code><code class="o">|</code> <code class="p">[</code><code class="n">trivial_bit</code><code class="p">]</code> <code class="o">+</code> <code class="n">div</code><code class="o">\</code>
<code class="n">isible_bit</code> <code class="p">}</code>
  <code class="p">)</code>
<code class="k">end</code>

<code class="n">def</code> <code class="n">linear_recursion</code><code class="p">(</code><code class="n">value</code><code class="p">,</code> <code class="n">steps</code><code class="p">)</code>
  <code class="k">if</code> <code class="n">steps</code><code class="p">[:</code><code class="n">divisible</code>?<code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">trivial_part</code><code class="p">,</code> <code class="n">sub_problem</code> <code class="p">=</code> <code class="n">steps</code><code class="p">[:</code><code class="n">divide</code><code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">steps</code><code class="p">[:</code><code class="n">recombine</code><code class="p">].</code><code class="n">call</code><code class="p">(</code>
      <code class="n">trivial_part</code><code class="p">,</code> <code class="n">linear_recursion</code><code class="p">(</code><code class="n">sub_problem</code><code class="p">,</code> <code class="n">steps</code><code class="p">)</code>
    <code class="p">)</code>
  <code class="k">else</code>
    <code class="n">steps</code><code class="p">[:</code><code class="n">conquer</code><code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>You may think this is even better, and it is.</p>

<h3 section-num="8.3" id="separating-declaration-from-implementation">Separating Declaration from Implementation</h3>

<p>Using recursive combinators like <code>#divide_and_conquer</code> and <code>#linear_recursion</code> are abstraction wins. They make recursive code much easier to read, because you know the general form of the algorithm and don&rsquo;t need to pick through it to discover the individual steps. But there&rsquo;s another benefit we should consider: <em>Recursive combinators separate declaration from implementation.</em></p>

<p>Consider <code>#linear_recursion</code> again. This is <em>not</em> the fastest possible implementation. There is a long and tedious argument that arises when one programmer argues it should be implemented with iteration for performance, and the other argues it should be implemented with recursion for clarity, and a third programmer who never uses recursion claims the iterative solution is easier to understand&hellip;</p>

<p>Imagine a huge code base full of <code>#linear_recursion</code> and <code>#divide_and_conquer</code> calls. What happens if you decide that each one of these algorithms should be implemented with iteration? Hmmm&hellip; How about we modify <code>#linear_recursion</code> and <code>#divide_and_conquer</code>, and all of the methods that call them switch from recursion to iteration for free?</p>

<p>Or perhaps we decide that we really should take advantage of multiple threads&hellip; Do you see where this is going? You can write a new implementation and again, all of the existing methods are upgraded.</p>

<p>Even if you do not plan to change the implementation, let&rsquo;s face a simple fact: when writing a brand new recursive or iterative method, you really have two possible sources of bugs: you may not have declared the solution correctly, and you may not implement it correctly.</p>

<p>Using combinators like <code>#divide_and_conquer</code> simplifies things: You only need to get your declaration of the solution correct, the implementation is taken care of for you. This is a tremendous win when writing recursive functions.</p>

<p>For these reasons, I strongly encourage the use of recursion combinators, either those supplied here or ones you write for yourself.</p>

<h3 section-num="8.4" id="practical-recursive-combinators">Practical Recursive Combinators</h3>

<p>We&rsquo;ve seen how recursive combinators like <code>#divide_and_conquer</code> and <code>#linear_recursion</code> are abstraction wins. They make recursive code much easier to read, because you know the general form of the algorithm and don&rsquo;t need to pick through it to discover the individual steps.</p>

<p>We also saw that by separating the recursion implementation from the declaration of how to perform the steps of an algorithm like <code>#rotate</code>, we leave ourselves the opportunity to improve the performance of our implementation without the risk of adding bugs to our declaration. And today we&rsquo;re going to do just that, along with a few tweaks for usability.</p>

<p>In this section, we&rsquo;re going to optimize our combinators&rsquo; performance and make them a little easier to use with goodies like <code>string_to_proc</code>. To do that, we&rsquo;re going to work with closures, defining methods with <code>define_method</code>, and implement functional programming&rsquo;s partial application. We&rsquo;ll wrap up by converting <code>linrec</code> from a recursive to an iterative implementation.</p>

<p>First, a little organization. Here are the original examples. I&rsquo;ve placed them in a module and named the combinators <code>multirec</code> and <code>linrec</code> in conformance with common practice:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">module</code> <code class="n">RecursiveCombinators</code>

  <code class="n">def</code> <code class="n">multirec</code><code class="p">(</code><code class="n">value</code><code class="p">,</code> <code class="n">steps</code><code class="p">)</code>
    <code class="k">if</code> <code class="n">steps</code><code class="p">[:</code><code class="n">divisible</code>?<code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
      <code class="n">steps</code><code class="p">[:</code><code class="n">recombine</code><code class="p">].</code><code class="n">call</code><code class="p">(</code>
        <code class="n">steps</code><code class="p">[:</code><code class="n">divide</code><code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">sub_value</code><code class="o">|</code> <code class="n">multirec</code><code class="p">(</code><code class="n">sub_value</code><code class="p">,</code> <code class="n">st</code><code class="o">\</code>
<code class="nb">eps</code><code class="p">)</code> <code class="p">}</code>
      <code class="p">)</code>
    <code class="k">else</code>
      <code class="n">steps</code><code class="p">[:</code><code class="n">conquer</code><code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="k">end</code>
  <code class="k">end</code>

  <code class="n">def</code> <code class="n">linrec</code><code class="p">(</code><code class="n">value</code><code class="p">,</code> <code class="n">steps</code><code class="p">)</code>
    <code class="k">if</code> <code class="n">steps</code><code class="p">[:</code><code class="n">divisible</code>?<code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
      <code class="n">trivial_part</code><code class="p">,</code> <code class="n">sub_problem</code> <code class="p">=</code> <code class="n">steps</code><code class="p">[:</code><code class="n">divide</code><code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
      <code class="n">steps</code><code class="p">[:</code><code class="n">recombine</code><code class="p">].</code><code class="n">call</code><code class="p">(</code>
        <code class="n">trivial_part</code><code class="p">,</code> <code class="n">linrec</code><code class="p">(</code><code class="n">sub_problem</code><code class="p">,</code> <code class="n">steps</code><code class="p">)</code>
      <code class="p">)</code>
    <code class="k">else</code>
      <code class="n">steps</code><code class="p">[:</code><code class="n">conquer</code><code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="k">end</code>
  <code class="k">end</code>

  <code class="n">module_function</code> <code class="p">:</code><code class="n">multirec</code><code class="p">,</code> <code class="p">:</code><code class="n">linrec</code>

<code class="k">end</code>
</pre></div>

</div>

<p>Since they are also module functions, call them by sending a message to the module:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">merge_sort</code><code class="p">(</code><code class="n">list</code><code class="p">)</code>
  <code class="n">RecursiveCombinators</code><code class="p">.</code><code class="n">multirec</code><code class="p">(</code>
    <code class="n">list</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="nb">length</code> <code class="o">&gt;</code> 1 <code class="p">},</code>
    <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code> <code class="p">},</code>
    <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code>
      <code class="n">half_index</code> <code class="p">=</code> <code class="p">(</code><code class="n">list</code><code class="p">.</code><code class="nb">length</code> <code class="o">/</code> 2<code class="p">)</code> <code class="o">-</code> 1
      <code class="p">[</code> <code class="n">list</code><code class="p">[</code>0<code class="p">..</code><code class="n">half_index</code><code class="p">],</code> <code class="n">list</code><code class="p">[(</code><code class="n">half_index</code> <code class="o">+</code> 1<code class="p">)..</code><code class="o">-</code>1<code class="p">]</code> <code class="p">]</code>
    <code class="k">end</code><code class="p">,</code>
    <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code> <code class="n">merge_two_sorted_lists</code><code class="p">(</code><code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="n">pair</code><code class="o">.\</code>
<code class="n">last</code><code class="p">)</code> <code class="p">}</code>
  <code class="p">)</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Or you can include the <code>RecursiveCombinators</code> module and call either method directly:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">include</code> <code class="n">RecursiveCombinators</code>

<code class="n">def</code> <code class="n">merge_two_sorted_lists</code><code class="p">(</code><code class="o">*</code><code class="n">pair</code><code class="p">)</code>
  <code class="n">linrec</code><code class="p">(</code>
    <code class="n">pair</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code> !<code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">empty</code>? <code class="o">&amp;&amp;</code> !<code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">.</code><code class="n">empty</code>? <code class="o">\</code>
<code class="p">},</code>
    <code class="p">:</code><code class="n">conquer</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code>
      <code class="k">if</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">empty</code>? <code class="o">&amp;&amp;</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">.</code><code class="n">empty</code>?
        <code class="p">[]</code>
      <code class="n">elsif</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">empty</code>?
        <code class="n">pair</code><code class="p">.</code><code class="n">last</code>
      <code class="k">else</code>
        <code class="n">pair</code><code class="p">.</code><code class="n">first</code>
      <code class="k">end</code>
    <code class="k">end</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divide</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">pair</code><code class="o">|</code>
      <code class="n">preceding</code><code class="p">,</code> <code class="n">following</code> <code class="p">=</code> <code class="k">case</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">.</code><code class="n">first</code> <code class="o">&lt;</code><code class="p">=</code><code class="o">&gt;</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">.</code><code class="n">first</code>
        <code class="n">when</code> <code class="o">-</code>1<code class="p">:</code> <code class="p">[</code><code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">]</code>
        <code class="n">when</code> 0<code class="p">:</code>  <code class="p">[</code><code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">]</code>
        <code class="n">when</code> 1<code class="p">:</code>  <code class="p">[</code><code class="n">pair</code><code class="p">.</code><code class="n">last</code><code class="p">,</code> <code class="n">pair</code><code class="p">.</code><code class="n">first</code><code class="p">]</code>
      <code class="k">end</code>
      <code class="p">[</code> <code class="n">preceding</code><code class="p">.</code><code class="n">first</code><code class="p">,</code> <code class="p">[</code><code class="n">preceding</code><code class="p">[</code>1<code class="p">..</code><code class="o">-</code>1<code class="p">],</code> <code class="n">following</code><code class="p">]</code> <code class="p">]</code>
    <code class="k">end</code><code class="p">,</code>
    <code class="p">:</code><code class="n">recombine</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">trivial_bit</code><code class="p">,</code> <code class="n">divisible_bit</code><code class="o">|</code> <code class="p">[</code><code class="n">trivial_bit</code><code class="p">]</code> <code class="o">+</code> <code class="n">div</code><code class="o">\</code>
<code class="n">isible_bit</code> <code class="p">}</code>
  <code class="p">)</code>
<code class="k">end</code>

<code class="n">merge_sort</code><code class="p">([</code>8<code class="p">,</code> 3<code class="p">,</code> 10<code class="p">,</code> 1<code class="p">,</code> 9<code class="p">,</code> 5<code class="p">,</code> 7<code class="p">,</code> 4<code class="p">,</code> 6<code class="p">,</code> 2<code class="p">])</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">[</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">,</code> 4<code class="p">,</code> 5<code class="p">,</code> 6<code class="p">,</code> 7<code class="p">,</code> 8<code class="p">,</code> 9<code class="p">,</code> 10<code class="p">]</code>
</pre></div>

</div>

<p>Ok, we&rsquo;re ready for some slightly more substantial work. These methods were fine for illustration, but I have a few questions for the author(!)</p>

<h3 section-num="8.5" id="spicing-things-up">Spicing things up</h3>

<p>First, note that every single time we call a method like <code>merge_sort</code>, we create four new lambdas from scratch. This seems wasteful, especially since the lambdas never change. Why create some objects just to throw them away?</p>

<p>On the other hand, it&rsquo;s nice to be able to use create algorithms without having to define a method by name. Although I probably wouldn&rsquo;t do a merge sort anonymously, when I need a one-off quickie, I might like to write something like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">RecursiveCombinators</code><code class="p">.</code><code class="n">multirec</code><code class="p">(</code>
  <code class="p">[</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">,</code> <code class="p">[[</code>4<code class="p">,</code>5<code class="p">],</code> 6<code class="p">],</code> <code class="p">[[[</code>7<code class="p">]]]],</code>
  <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="p">},</code>
  <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> 2 <code class="p">},</code>
  <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
  <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> 140
</pre></div>

</div>

<p>But when I want a permanent sum of the squares method, I <strong>don&rsquo;t</strong> want to write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">sum_squares</code><code class="p">(</code><code class="n">list</code><code class="p">)</code>
  <code class="n">RecursiveCombinators</code><code class="p">.</code><code class="n">multirec</code><code class="p">(</code>
    <code class="n">list</code><code class="p">,</code>
    <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="p">},</code>
    <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> 2 <code class="p">},</code>
    <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
    <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code> <code class="p">}</code>
  <code class="p">)</code>
<code class="k">end</code>
</pre></div>

</div>

<p>&hellip;because that would create four lambdas every time I call the function. There are a couple of ways around this problem. First, our &ldquo;recipe&rdquo; for summing squares is a simple hash. We could extract that from the method into a constant:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">SUM_SQUARES_RECIPE</code> <code class="p">=</code> <code class="p">{</code>
   <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="p">},</code>
   <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> 2 <code class="p">},</code>
   <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
   <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">}</code>

<code class="n">def</code> <code class="n">sum_squares</code><code class="p">(</code><code class="n">list</code><code class="p">)</code>
  <code class="n">RecursiveCombinators</code><code class="p">.</code><code class="n">multirec</code><code class="p">(</code><code class="n">list</code><code class="p">,</code> <code class="n">SUM_SQUARES_RECIPE</code><code class="p">)</code>
<code class="k">end</code>
</pre></div>

</div>

<p>That (and the isomorphic solution where the constant <code>SUM_SQUARES_RECIPE</code> is instead a private helper method <code>#sum_squares_recipe</code>) is nice if you have some reason you wish to re-use the recipe elsewhere. But we don&rsquo;t, so this merely clutters our class up and separates the method definition from its logic.</p>

<p>I have something in mind. To see what it is, let&rsquo;s start by transforming our method definition from using the <code>def</code> keyword to using the <code>define_method</code> private class method. This obviously needs a module or class to work:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Practicum</code>

  <code class="n">include</code> <code class="n">RecursiveCombinators</code>

  <code class="n">define_method</code> <code class="p">:</code><code class="n">sum_squares</code> <code class="n">do</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code>
    <code class="n">multirec</code><code class="p">(</code>
      <code class="n">list</code><code class="p">,</code>
     <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="p">},</code>
     <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> 2 <code class="p">},</code>
     <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
     <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code> <code class="p">}</code>
    <code class="p">)</code>
  <code class="k">end</code>

<code class="k">end</code>

<code class="n">Practicum</code><code class="p">.</code><code class="n">new</code><code class="p">.</code><code class="n">sum_squares</code><code class="p">([</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">,</code> <code class="p">[[</code>4<code class="p">,</code>5<code class="p">],</code> 6<code class="p">],</code> <code class="p">[[[</code>7<code class="p">]]]])</code>
</pre></div>

</div>

<p>As you probably know, any method taking a block can take a lambda using the <code>&amp;</code> operator, so:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">define_method</code> <code class="o">:</code><code class="n">sum_squares</code><code class="o">,</code> <code class="o">&amp;(</code><code class="n">lambda</code> <code class="k">do</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code>
  <code class="n">multirec</code><code class="o">(</code>
    <code class="n">list</code><code class="o">,</code>
  <code class="o">:</code><code class="n">divisible</code><code class="o">?</code> <code class="o">=&gt;</code> <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="o">.</code><code class="na">kind_of</code><code class="o">?(</code><code class="n">Enumerable</code><code class="o">)</code> <code class="o">},</code>
  <code class="o">:</code><code class="n">conquer</code>    <code class="o">=&gt;</code> <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> <code class="mi">2</code> <code class="o">},</code>
  <code class="o">:</code><code class="n">divide</code>     <code class="o">=&gt;</code> <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">},</code>
  <code class="o">:</code><code class="n">recombine</code>  <code class="o">=&gt;</code> <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="o">.</code><code class="na">inject</code><code class="o">()</code> <code class="o">{</code> <code class="o">|</code><code class="n">x</code><code class="o">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="o">}</code> <code class="o">}</code>
 <code class="o">)</code>
<code class="n">end</code><code class="o">)</code>
</pre></div>

</div>

<p>This is useful, because now we can express what we want: a lambda taking one argument that in turn calls <code>multirec</code> with the other arguments filled in. Functional programmers call this <a href="http://ejohn.org/blog/partial-functions-in-javascript/" title="Partial Application in JavaScript">Partial Application</a>. The idea is that if you have a function or method taking two arguments, if you only give it one argument you get a function back that takes the other. So:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">multirec</code><code class="p">(</code><code class="n">x</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">y</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">multirec</code><code class="p">(</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="p">)</code>
</pre></div>

</div>

<p>Now the drawback with this &ldquo;standard&rdquo; implementation of partial application is that we would pass a list to <code>multirec</code> and get back a function taking a hash of declarations. That isn&rsquo;t what we want. We could partially apply things <em>backwards</em> so that <code>multirec(x).call(y) =&gt; multirec(y,x)</code> (if Ruby was a concatenative language, we would be concatenating the multirec combinator with a thrush). The trouble with that is it is the reverse of how partial application works in every other <a href="http://www.haskell.org/" title="HaskellWiki">programming language</a> and <a href="https://github.com/osteele/functional-javascript/tree">functional programming library</a>.</p>

<p>Instead, we will switch the arguments to <code>multirec</code> ourselves, so it now works like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">multirec</code><code class="p">(</code>
  <code class="p">{</code>
    <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="p">},</code>
    <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> 2 <code class="p">},</code>
    <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
    <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code> <code class="p">}</code>
  <code class="p">},</code>
  <code class="n">list</code>
<code class="p">)</code>
</pre></div>

</div>

<p>The drawback with this approach is that we lose a little of Ruby&rsquo;s syntactic sugar, the ability to fake named parameters by passing hash arguments without <code>{}</code> if they are the last parameter. And now, let&rsquo;s give it the ability to partially apply itself. You can do some stuff with allowing multiple arguments and counting the number of arguments, but we&rsquo;re going to make the wild assumption that you never attempt a recursive combinator on <code>nil</code>. Here&rsquo;s <code>multirec</code>, you can infer the implementation for <code>linrec</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">multirec</code><code class="p">(</code><code class="n">steps</code><code class="p">,</code> <code class="n">optional_value</code> <code class="p">=</code> <code class="n">nil</code><code class="p">)</code>
  <code class="n">worker_proc</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
    <code class="k">if</code> <code class="n">steps</code><code class="p">[:</code><code class="n">divisible</code>?<code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
      <code class="n">steps</code><code class="p">[:</code><code class="n">recombine</code><code class="p">].</code><code class="n">call</code><code class="p">(</code>
        <code class="n">steps</code><code class="p">[:</code><code class="n">divide</code><code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">sub_value</code><code class="o">|</code> <code class="n">worker_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">sub_v</code><code class="o">\</code>
<code class="n">alue</code><code class="p">)</code> <code class="p">}</code>
      <code class="p">)</code>
    <code class="k">else</code>
      <code class="n">steps</code><code class="p">[:</code><code class="n">conquer</code><code class="p">].</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="k">end</code>
  <code class="k">end</code>
  <code class="k">if</code> <code class="n">optional_value</code><code class="p">.</code><code class="n">nil</code>?
    <code class="n">worker_proc</code>
  <code class="k">else</code>
    <code class="n">worker_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">optional_value</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Notice that you get the same correct result whether you write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">RecursiveCombinators</code><code class="p">.</code><code class="n">multirec</code><code class="p">(</code>
  <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="p">},</code>
  <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> 2 <code class="p">},</code>
  <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
  <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">).</code><code class="n">call</code><code class="p">([</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">,</code> <code class="p">[[</code>4<code class="p">,</code>5<code class="p">],</code> 6<code class="p">],</code> <code class="p">[[[</code>7<code class="p">]]]])</code>
  <code class="p">=</code><code class="o">&gt;</code> 140
</pre></div>

</div>

<p>Or:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">RecursiveCombinators</code><code class="p">.</code><code class="n">multirec</code><code class="p">(</code>
  <code class="p">{</code>
     <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="p">},</code>
     <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> 2 <code class="p">},</code>
     <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
     <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code> <code class="p">}</code>
  <code class="p">},</code>
  <code class="p">[</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">,</code> <code class="p">[[</code>4<code class="p">,</code>5<code class="p">],</code> 6<code class="p">],</code> <code class="p">[[[</code>7<code class="p">]]]]</code>
<code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> 140
</pre></div>

</div>

<p>Let&rsquo;s go back to what we were trying to do with <code>&amp;</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">define_method</code> <code class="o">:</code><code class="n">sum_squares</code><code class="o">,</code> <code class="o">&amp;(</code><code class="n">lambda</code> <code class="k">do</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code>
  <code class="n">multirec</code><code class="o">(</code>
    <code class="n">list</code><code class="o">,</code>
  <code class="o">:</code><code class="n">divisible</code><code class="o">?</code> <code class="o">=&gt;</code> <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="o">.</code><code class="na">kind_of</code><code class="o">?(</code><code class="n">Enumerable</code><code class="o">)</code> <code class="o">},</code>
  <code class="o">:</code><code class="n">conquer</code>    <code class="o">=&gt;</code> <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> <code class="mi">2</code> <code class="o">},</code>
  <code class="o">:</code><code class="n">divide</code>     <code class="o">=&gt;</code> <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">},</code>
  <code class="o">:</code><code class="n">recombine</code>  <code class="o">=&gt;</code> <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="o">.</code><code class="na">inject</code><code class="o">()</code> <code class="o">{</code> <code class="o">|</code><code class="n">x</code><code class="o">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="o">}</code> <code class="o">}</code>
 <code class="o">)</code>
<code class="n">end</code><code class="o">)</code>
</pre></div>

</div>

<p>Now we know how to build our lambda:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">require</code> <code class="s">&#39;partial_application_recursive_combinators&#39;</code>

<code class="n">class</code> <code class="n">Practicum</code>

  <code class="n">extend</code> <code class="n">PartialApplicationRecursiveCombinators</code>   # <code class="n">so</code> <code class="n">we</code> <code class="n">can</code> <code class="n">call</code> <code class="n">multirec</code><code class="o">\</code>
 <code class="n">in</code> <code class="n">class</code> <code class="n">scope</code>

  <code class="n">define_method</code> <code class="p">:</code><code class="n">sum_squares</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">multirec</code><code class="p">(</code>
   <code class="p">:</code><code class="n">divisible</code>? <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="p">},</code>
   <code class="p">:</code><code class="n">conquer</code>    <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> 2 <code class="p">},</code>
   <code class="p">:</code><code class="n">divide</code>     <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
   <code class="p">:</code><code class="n">recombine</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code> <code class="p">}</code>
  <code class="p">)</code>

<code class="k">end</code>

<code class="n">Practicum</code><code class="p">.</code><code class="n">new</code><code class="p">.</code><code class="n">sum_squares</code><code class="p">([</code>1<code class="p">,</code> 2<code class="p">,</code> 3<code class="p">,</code> <code class="p">[[</code>4<code class="p">,</code>5<code class="p">],</code> 6<code class="p">],</code> <code class="p">[[[</code>7<code class="p">]]]])</code>
  <code class="p">=</code><code class="o">&gt;</code> 140
</pre></div>

</div>

<p>You can verify for yourself that no matter how many times you call <code>sum_squares</code>, you do not build those lambdas again. What we have just done is added partial application to <code>multirec</code> and <code>linrec</code>, which in turn allows us to ensure that he cost of constructing lambdas for our methods is only done when the method is defined, not every time it is called.</p>

<h3 section-num="8.6" id="building-on-a-legacy">Building on a legacy</h3>

<p>We have already renamed <code>divide_and_conquer</code> and <code>linear_recursion</code> to bring them into line with standard practice and other programming languages. Now it&rsquo;s time for us to bring the parameters&ndash;the declarative lambdas&ndash;into line with standard practice.</p>

<p>The four arguments to both methods are normally called <code>cond</code>, <code>then</code>, <code>before</code>, and <code>after</code>:</p>

<ul>
  <li><code>cond</code> is the logical inverse of <code>divisible?</code> So if <code>cond(value)</code> evaluates to true, then we do not need to subdivide the problem.</li>
  <li><code>then</code> is exactly the same as <code>conquer</code>, <em>if</em> cond <em>then</em> then. That&rsquo;s the way I think of it.</li>
  <li><code>before</code> is the same as <code>divide</code>.</li>
  <li><code>after</code> is the same as <code>recombine</code>.</li>
</ul>

<p>Things look very similar with the new scheme for now:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">require</code> <code class="s">&#39;legacy_recursive_combinators&#39;</code>

<code class="n">class</code> <code class="n">Practicum</code>

  <code class="n">extend</code> <code class="n">LegacyRecursiveCombinators</code>   # <code class="n">so</code> <code class="n">we</code> <code class="n">can</code> <code class="n">call</code> <code class="n">multirec</code> <code class="n">in</code> <code class="n">class</code> <code class="n">sc</code><code class="o">\</code>
<code class="n">ope</code>

  <code class="n">define_method</code> <code class="p">:</code><code class="n">sum_squares</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">multirec</code><code class="p">(</code>
   <code class="p">:</code><code class="n">cond</code>   <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> <code class="p">},</code> # <code class="n">the</code> <code class="n">only</code> <code class="n">change</code><code class="o">\</code>
 <code class="n">right</code> <code class="n">now</code>
   <code class="p">:</code><code class="n">then</code>   <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> 2 <code class="p">},</code>
   <code class="p">:</code><code class="n">before</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="p">},</code>
   <code class="p">:</code><code class="n">after</code>  <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="p">.</code><code class="n">inject</code><code class="p">()</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code> <code class="p">}</code>
  <code class="p">)</code>

<code class="k">end</code>
</pre></div>

</div>

<p>All right, now our combinators will look familiar to functional programmers, and even better when we look at functional programs using recursive combinators we will understand them at a glance. Okay, let&rsquo;s get serious and work on making our combinators easy to use and our code easy to read.</p>

<h3 section-num="8.7" id="seriously">Seriously</h3>

<p>As long as you&rsquo;re writing these lambdas out, writing <code>:cond =&gt;</code> isn&rsquo;t a hardship. And in an explanatory article like this, it can help at first. However, what if you find a way to abbreviate things? For example, you might <a href="http://github.com/gilesbowkett/archaeopteryx/tree/master" title="gilesbowkett's archaeopteryx">alias <code>lambda</code> to <code>L</code></a>. Or you might want to use <code>string\_to\_proc</code>:</p>

<div class="code-block">
  <p class="codeblock-title">string_to_proc.rb</p>

  <hr />
<div class="highlight"><pre><code class="k">class</code> <code class="nc">String</code>
  <code class="k">unless</code> <code class="s1">&#39;&#39;</code><code class="o">.</code><code class="n">respond_to?</code><code class="p">(</code><code class="ss">:to_proc</code><code class="p">)</code>
    <code class="k">def</code> <code class="nf">to_proc</code> <code class="o">&amp;</code><code class="n">block</code>
      <code class="n">params</code> <code class="o">=</code> <code class="o">[]</code>
      <code class="n">expr</code> <code class="o">=</code> <code class="nb">self</code>
      <code class="n">sections</code> <code class="o">=</code> <code class="n">expr</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="sr">/\s*-&gt;\s*/m</code><code class="p">)</code>
      <code class="k">if</code> <code class="n">sections</code><code class="o">.</code><code class="n">length</code> <code class="o">&gt;</code> <code class="mi">1</code> <code class="k">then</code>
          <code class="nb">eval</code> <code class="n">sections</code><code class="o">.</code><code class="n">reverse!</code><code class="o">.</code><code class="n">inject</code> <code class="p">{</code> <code class="o">|</code><code class="n">e</code><code class="p">,</code> <code class="nb">p</code><code class="o">|</code> <code class="s2">&quot;(Proc.new { |</code><code class="si">#{</code><code class="nb">p</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="sr">/\\</code>
<code class="sr">s/</code><code class="p">)</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="s1">&#39;, &#39;</code><code class="p">)</code><code class="si">}</code><code class="s2">| </code><code class="si">#{</code><code class="n">e</code><code class="si">}</code><code class="s2"> })&quot;</code> <code class="p">},</code> <code class="n">block</code> <code class="o">&amp;&amp;</code> <code class="n">block</code><code class="o">.</code><code class="n">binding</code>
      <code class="k">elsif</code> <code class="n">expr</code><code class="o">.</code><code class="n">match</code><code class="p">(</code><code class="sr">/\b_\b/</code><code class="p">)</code>
          <code class="nb">eval</code> <code class="s2">&quot;Proc.new { |_| </code><code class="si">#{</code><code class="n">expr</code><code class="si">}</code><code class="s2"> }&quot;</code><code class="p">,</code> <code class="n">block</code> <code class="o">&amp;&amp;</code> <code class="n">block</code><code class="o">.</code><code class="n">binding</code>
      <code class="k">else</code>
          <code class="n">leftSection</code> <code class="o">=</code> <code class="n">expr</code><code class="o">.</code><code class="n">match</code><code class="p">(</code><code class="sr">/^\s*(?:[+*\/%&amp;|\^\.=&lt;&gt;\[]|!=)/m</code><code class="p">)</code>
          <code class="n">rightSection</code> <code class="o">=</code> <code class="n">expr</code><code class="o">.</code><code class="n">match</code><code class="p">(</code><code class="sr">/[+\-*\/%&amp;|\^\.=&lt;&gt;!]\s*$/m</code><code class="p">)</code>
          <code class="k">if</code> <code class="n">leftSection</code> <code class="o">||</code> <code class="n">rightSection</code> <code class="k">then</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">leftSection</code><code class="p">)</code> <code class="k">then</code>
                  <code class="n">params</code><code class="o">.</code><code class="n">push</code><code class="p">(</code><code class="s1">&#39;$left&#39;</code><code class="p">)</code>
                  <code class="n">expr</code> <code class="o">=</code> <code class="s1">&#39;$left&#39;</code> <code class="o">+</code> <code class="n">expr</code>
              <code class="k">end</code>
              <code class="k">if</code> <code class="p">(</code><code class="n">rightSection</code><code class="p">)</code> <code class="k">then</code>
                  <code class="n">params</code><code class="o">.</code><code class="n">push</code><code class="p">(</code><code class="s1">&#39;$right&#39;</code><code class="p">)</code>
                  <code class="n">expr</code> <code class="o">=</code> <code class="n">expr</code> <code class="o">+</code> <code class="s1">&#39;$right&#39;</code>
              <code class="k">end</code>
          <code class="k">else</code>
              <code class="nb">self</code><code class="o">.</code><code class="n">gsub</code><code class="p">(</code>
                  <code class="sr">/(?:\b[A-Z]|\.[a-zA-Z_$])[a-zA-Z_$\d]*|[a-zA-Z_$][a-zA-Z_\</code>
<code class="sr">$\d]*:|self|arguments|&#39;(?:[^&#39;\\]|\\.)*&#39;|&quot;(?:[^&quot;\\]|\\.)*&quot;/</code><code class="p">,</code> <code class="s1">&#39;&#39;</code>
              <code class="p">)</code><code class="o">.</code><code class="n">scan</code><code class="p">(</code>
                <code class="sr">/([a-z_$][a-z_$\d]*)/i</code>
              <code class="p">)</code> <code class="k">do</code> <code class="o">|</code><code class="n">v</code><code class="o">|</code>
                <code class="n">params</code><code class="o">.</code><code class="n">push</code><code class="p">(</code><code class="n">v</code><code class="p">)</code> <code class="k">unless</code> <code class="n">params</code><code class="o">.</code><code class="n">include?</code><code class="p">(</code><code class="n">v</code><code class="p">)</code>
              <code class="k">end</code>
          <code class="k">end</code>
          <code class="nb">eval</code> <code class="s2">&quot;Proc.new { |</code><code class="si">#{</code><code class="n">params</code><code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="s1">&#39;, &#39;</code><code class="p">)</code><code class="si">}</code><code class="s2">| </code><code class="si">#{</code><code class="n">expr</code><code class="si">}</code><code class="s2"> }&quot;</code><code class="p">,</code> <code class="n">block</code> <code class="o">&amp;&amp;</code> <code class="n">bloc</code><code class="p">\</code>
<code class="n">k</code><code class="o">.</code><code class="n">binding</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

  <hr />
</div>

<p>So we should support passing the declarative arguments by position as well as by &lsquo;name.&rsquo; And with a final twist, if any of the declarative arguments aren&rsquo;t already lambdas, we&rsquo;ll try to create lambdas by sending them the message <code>to_proc</code>. So our goal is to write what we wrote above or either of the following and have it &ldquo;just work:&rdquo;</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">define_method</code> <code class="o">:</code><code class="n">sum_squares</code><code class="o">,</code> <code class="o">&amp;</code><code class="n">multirec</code><code class="o">(</code>
  <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code><code class="o">.</code><code class="na">kind_of</code><code class="o">?(</code><code class="n">Numeric</code><code class="o">)</code> <code class="o">},</code> <code class="err">#</code> <code class="n">the</code> <code class="n">only</code> <code class="n">change</code> <code class="n">right</code> <code class="n">now</code>
  <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">**</code> <code class="mi">2</code> <code class="o">},</code>
  <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code> <code class="n">value</code> <code class="o">},</code>
  <code class="n">lambda</code> <code class="o">{</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code> <code class="n">list</code><code class="o">.</code><code class="na">inject</code><code class="o">()</code> <code class="o">{</code> <code class="o">|</code><code class="n">x</code><code class="o">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="o">}</code> <code class="o">}</code>
<code class="o">)</code>

<code class="k">include</code> <code class="s1">&#39;string-to_proc&#39;</code>

<code class="n">define_method</code> <code class="o">:</code><code class="n">sum_squares</code><code class="o">,</code> <code class="o">&amp;</code><code class="n">multirec</code><code class="o">(</code><code class="s2">&quot;value.kind_of?(Numeric)&quot;</code><code class="o">,</code> <code class="s2">&quot;value ** \</code>
<code class="s2">2&quot;</code><code class="o">,</code><code class="s2">&quot;value&quot;</code><code class="o">,</code><code class="s2">&quot;value.inject(&amp;&#39;+&#39;)&quot;</code><code class="o">)</code>
</pre></div>

</div>

<p>And here is the code that makes it work:</p>

<div class="code-block">
  <p class="codeblock-title">recursive_combinators.rb</p>

  <hr />
<div class="highlight"><pre><code class="k">module</code> <code class="nn">RecursiveCombinators</code>

  <code class="n">separate_args</code> <code class="o">=</code> <code class="nb">lambda</code> <code class="k">do</code> <code class="o">|</code><code class="n">args</code><code class="o">|</code>
    <code class="k">if</code> <code class="o">![</code><code class="mi">1</code><code class="p">,</code><code class="mi">2</code><code class="p">,</code><code class="mi">4</code><code class="p">,</code><code class="mi">5</code><code class="o">].</code><code class="n">include?</code><code class="p">(</code><code class="n">args</code><code class="o">.</code><code class="n">length</code><code class="p">)</code>
      <code class="k">raise</code> <code class="no">ArgumentError</code>
    <code class="k">elsif</code> <code class="n">args</code><code class="o">.</code><code class="n">length</code> <code class="o">&lt;=</code> <code class="mi">2</code>
      <code class="n">steps</code> <code class="o">=</code> <code class="o">[</code><code class="ss">:cond</code><code class="p">,</code> <code class="ss">:then</code><code class="p">,</code> <code class="ss">:before</code><code class="p">,</code> <code class="ss">:after</code><code class="o">].</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">k</code><code class="o">|</code> <code class="n">args</code><code class="o">.</code><code class="n">first</code><code class="o">[</code><code class="n">k</code><code class="o">].</code><code class="n">to_pr</code><code class="p">\</code>
<code class="n">oc</code> <code class="p">}</code>
      <code class="n">steps</code><code class="o">.</code><code class="n">push</code><code class="p">(</code><code class="n">args</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code><code class="p">)</code> <code class="k">unless</code> <code class="n">args</code><code class="o">[</code><code class="mi">1</code><code class="o">].</code><code class="n">nil?</code>
      <code class="n">steps</code>
    <code class="k">else</code>
      <code class="n">steps</code> <code class="o">=</code> <code class="n">args</code><code class="o">[</code><code class="mi">0</code><code class="o">.</code><code class="n">.</code><code class="mi">3</code><code class="o">].</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">arg</code><code class="o">|</code> <code class="n">arg</code><code class="o">.</code><code class="n">to_proc</code> <code class="p">}</code>
      <code class="n">steps</code><code class="o">.</code><code class="n">push</code><code class="p">(</code><code class="n">args</code><code class="o">[</code><code class="mi">4</code><code class="o">]</code><code class="p">)</code> <code class="k">unless</code> <code class="n">args</code><code class="o">[</code><code class="mi">4</code><code class="o">].</code><code class="n">nil?</code>
      <code class="n">steps</code>
    <code class="k">end</code>
  <code class="k">end</code>

  <code class="n">define_method</code> <code class="ss">:multirec</code> <code class="k">do</code> <code class="o">|*</code><code class="n">args</code><code class="o">|</code>
    <code class="n">cond_proc</code><code class="p">,</code> <code class="n">then_proc</code><code class="p">,</code> <code class="n">before_proc</code><code class="p">,</code> <code class="n">after_proc</code><code class="p">,</code> <code class="n">optional_value</code> <code class="o">=</code> <code class="n">separat</code><code class="p">\</code>
<code class="n">e_args</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">args</code><code class="p">)</code>
    <code class="n">worker_proc</code> <code class="o">=</code> <code class="nb">lambda</code> <code class="k">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
      <code class="k">if</code> <code class="n">cond_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
        <code class="n">then_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
      <code class="k">else</code>
        <code class="n">after_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code>
          <code class="n">before_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code><code class="o">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">sub_value</code><code class="o">|</code> <code class="n">worker_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">sub_va</code><code class="p">\</code>
<code class="n">lue</code><code class="p">)</code> <code class="p">}</code>
        <code class="p">)</code>
      <code class="k">end</code>
    <code class="k">end</code>
    <code class="k">if</code> <code class="n">optional_value</code><code class="o">.</code><code class="n">nil?</code>
      <code class="n">worker_proc</code>
    <code class="k">else</code>
      <code class="n">worker_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">optional_value</code><code class="p">)</code>
    <code class="k">end</code>
  <code class="k">end</code>

  <code class="n">define_method</code> <code class="ss">:linrec</code> <code class="k">do</code> <code class="o">|*</code><code class="n">args</code><code class="o">|</code>
    <code class="n">cond_proc</code><code class="p">,</code> <code class="n">then_proc</code><code class="p">,</code> <code class="n">before_proc</code><code class="p">,</code> <code class="n">after_proc</code><code class="p">,</code> <code class="n">optional_value</code> <code class="o">=</code> <code class="n">separat</code><code class="p">\</code>
<code class="n">e_args</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">args</code><code class="p">)</code>
    <code class="n">worker_proc</code> <code class="o">=</code> <code class="nb">lambda</code> <code class="k">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
      <code class="n">trivial_parts</code><code class="p">,</code> <code class="n">sub_problem</code> <code class="o">=</code> <code class="o">[]</code><code class="p">,</code> <code class="n">value</code>
      <code class="k">while</code> <code class="o">!</code><code class="n">cond_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">sub_problem</code><code class="p">)</code>
        <code class="n">trivial_part</code><code class="p">,</code> <code class="n">sub_problem</code> <code class="o">=</code> <code class="n">before_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">sub_problem</code><code class="p">)</code>
        <code class="n">trivial_parts</code><code class="o">.</code><code class="n">unshift</code><code class="p">(</code><code class="n">trivial_part</code><code class="p">)</code>
      <code class="k">end</code>
      <code class="n">trivial_parts</code><code class="o">.</code><code class="n">unshift</code><code class="p">(</code><code class="n">then_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">sub_problem</code><code class="p">))</code>
      <code class="n">trivial_parts</code><code class="o">.</code><code class="n">inject</code> <code class="k">do</code> <code class="o">|</code><code class="n">recombined</code><code class="p">,</code> <code class="n">trivial_part</code><code class="o">|</code>
        <code class="n">after_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">trivial_part</code><code class="p">,</code> <code class="n">recombined</code><code class="p">)</code>
      <code class="k">end</code>
    <code class="k">end</code>
    <code class="k">if</code> <code class="n">optional_value</code><code class="o">.</code><code class="n">nil?</code>
      <code class="n">worker_proc</code>
    <code class="k">else</code>
      <code class="n">worker_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">optional_value</code><code class="p">)</code>
    <code class="k">end</code>
  <code class="k">end</code>

  <code class="kp">module_function</code> <code class="ss">:multirec</code><code class="p">,</code> <code class="ss">:linrec</code>

<code class="k">end</code>
</pre></div>

  <hr />
</div>

<p>Now when we have trivial lambdas, we can use nice syntactic sugar to express them. <code>string_to_proc</code> is <strong>not</strong> part of our recursive combinators, but making recursive combinators flexible, we make it &ldquo;play well with others,&rdquo; which is a win for our code.  </p>

<h3 section-num="8.8" id="separating-implementation-from-declaration">Separating Implementation from Declaration</h3>

<p>In Refactoring Methods with Recursive Combinators, we read the claim that by separating the recursion implementation from the declaration of how to perform the steps of an algorithm like <code>#rotate</code>, we leave ourselves the opportunity to improve the performance of our implementation without the risk of adding bugs to our declaration.</p>

<p>In other words, we can optimize <code>linrec</code> if we want to. Well, we want to. So what we&rsquo;re going to do is optimize its performance by trading time for space. Let&rsquo;s have a quick look at the <code>worker_proc</code> lambda inside of <code>linrec</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">worker_proc</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
  <code class="k">if</code> <code class="n">cond_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">then_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="k">else</code>
    <code class="n">trivial_part</code><code class="p">,</code> <code class="n">sub_problem</code> <code class="p">=</code> <code class="n">before_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
    <code class="n">after_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>
      <code class="n">trivial_part</code><code class="p">,</code> <code class="n">worker_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">sub_problem</code><code class="p">)</code>
    <code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>As you can see, it is recursive, it calls itself to solve each sub-problem. And here is an iterative replacement:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">worker_proc</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
  <code class="n">trivial_parts</code><code class="p">,</code> <code class="n">sub_problem</code> <code class="p">=</code> <code class="p">[],</code> <code class="n">value</code>
  <code class="k">while</code> !<code class="n">cond_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">sub_problem</code><code class="p">)</code>
    <code class="n">trivial_part</code><code class="p">,</code> <code class="n">sub_problem</code> <code class="p">=</code> <code class="n">before_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">sub_problem</code><code class="p">)</code>
    <code class="n">trivial_parts</code><code class="p">.</code><code class="n">unshift</code><code class="p">(</code><code class="n">trivial_part</code><code class="p">)</code>
  <code class="k">end</code>
  <code class="n">trivial_parts</code><code class="p">.</code><code class="n">unshift</code><code class="p">(</code><code class="n">then_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">sub_problem</code><code class="p">))</code>
  <code class="n">trivial_parts</code><code class="p">.</code><code class="n">inject</code> <code class="n">do</code> <code class="o">|</code><code class="n">recombined</code><code class="p">,</code> <code class="n">trivial_part</code><code class="o">|</code>
    <code class="n">after_proc</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">trivial_part</code><code class="p">,</code> <code class="n">recombined</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>This version doesn&rsquo;t call itself. Instead, it uses an old-fashioned loop, accumulating the results in an array. In a certain sense, this uses more explicit memory than the recursive implementation. However, we both know that the recursive version uses memory for its stack, so that&rsquo;s a bit of a wash. However, the Ruby stack is limited while arrays can be much larger, so this version can handle much larger data sets.</p>

<p>If you drop the new version of <code>worker_proc</code> into the <code>linrec</code> definition, each and every method you define using <code>linrec</code> gets the new implementation, for free. This works because we separated the implementation of recursive divide and conquer algorithms from the declaration of the steps each particular algorithm. Here&rsquo;s our new version of <code>linrec</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">define_method</code> <code class="o">:</code><code class="n">linrec</code> <code class="k">do</code> <code class="o">|*</code><code class="n">args</code><code class="o">|</code>
  <code class="n">cond_proc</code><code class="o">,</code> <code class="n">then_proc</code><code class="o">,</code> <code class="n">before_proc</code><code class="o">,</code> <code class="n">after_proc</code><code class="o">,</code> <code class="n">optional_value</code> <code class="o">=</code> <code class="n">separate_</code><code class="o">\</code>
<code class="n">args</code><code class="o">.</code><code class="na">call</code><code class="o">(</code><code class="n">args</code><code class="o">)</code>
  <code class="n">worker_proc</code> <code class="o">=</code> <code class="n">lambda</code> <code class="k">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
    <code class="n">trivial_parts</code><code class="o">,</code> <code class="n">sub_problem</code> <code class="o">=</code> <code class="o">[],</code> <code class="n">value</code>
    <code class="k">while</code> <code class="o">!</code><code class="n">cond_proc</code><code class="o">.</code><code class="na">call</code><code class="o">(</code><code class="n">sub_problem</code><code class="o">)</code>
      <code class="n">trivial_part</code><code class="o">,</code> <code class="n">sub_problem</code> <code class="o">=</code> <code class="n">before_proc</code><code class="o">.</code><code class="na">call</code><code class="o">(</code><code class="n">sub_problem</code><code class="o">)</code>
      <code class="n">trivial_parts</code><code class="o">.</code><code class="na">unshift</code><code class="o">(</code><code class="n">trivial_part</code><code class="o">)</code>
    <code class="n">end</code>
    <code class="n">trivial_parts</code><code class="o">.</code><code class="na">unshift</code><code class="o">(</code><code class="n">then_proc</code><code class="o">.</code><code class="na">call</code><code class="o">(</code><code class="n">sub_problem</code><code class="o">))</code>
    <code class="n">trivial_parts</code><code class="o">.</code><code class="na">inject</code> <code class="k">do</code> <code class="o">|</code><code class="n">recombined</code><code class="o">,</code> <code class="n">trivial_part</code><code class="o">|</code>
      <code class="n">after_proc</code><code class="o">.</code><code class="na">call</code><code class="o">(</code><code class="n">trivial_part</code><code class="o">,</code> <code class="n">recombined</code><code class="o">)</code>
    <code class="n">end</code>
  <code class="n">end</code>
  <code class="k">if</code> <code class="n">optional_value</code><code class="o">.</code><code class="na">nil</code><code class="o">?</code>
    <code class="n">worker_proc</code>
  <code class="k">else</code>
    <code class="n">worker_proc</code><code class="o">.</code><code class="na">call</code><code class="o">(</code><code class="n">optional_value</code><code class="o">)</code>
  <code class="n">end</code>
<code class="n">end</code>
</pre></div>

</div>

<h3 section-num="8.9" id="a-really-simple-recursive-combinator">A Really Simple Recursive Combinator</h3>

<p>In [Recursive Lambdas in Ruby using Object#tap](http://ciaranm.wordpress.com/2008/11/30/recursive-lambdas-in-ruby-using-objecttap/ &ldquo;&rdquo;), Ciaran McCreesh explained how he used <code>#tap</code> to write a recursive function without cluttering the scope up with an unneeded variable. (If you would like a refresher, <code>Object#tap</code> is explained in <a href="http://github.com/raganwald/homoiconic/tree/master/2008-10-29/kestrel.markdown#readme">Kestrels</a>).</p>

<p>Ciaran&rsquo;s final solution was:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code> <code class="n">recurse</code><code class="p">,</code> <code class="n">spec</code> <code class="o">|</code>
  <code class="k">case</code> <code class="n">spec</code>
    <code class="n">when</code> <code class="n">AllDepSpec</code><code class="p">,</code> <code class="n">ConditionalDepSpec</code>
      <code class="n">spec</code><code class="p">.</code><code class="n">each</code> <code class="p">{</code> <code class="o">|</code> <code class="n">child</code> <code class="o">|</code> <code class="n">recurse</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">recurse</code><code class="p">,</code> <code class="n">child</code><code class="p">)</code> <code class="p">}</code>
    <code class="n">when</code> <code class="n">SimpleURIDepSpec</code>
      <code class="n">puts</code> <code class="n">spec</code>
  <code class="k">end</code>
<code class="k">end</code><code class="p">.</code><code class="n">tap</code> <code class="p">{</code> <code class="o">|</code> <code class="n">r</code> <code class="o">|</code> <code class="n">r</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">r</code><code class="p">,</code> <code class="n">id</code><code class="p">.</code><code class="n">homepage_key</code><code class="p">.</code><code class="n">value</code><code class="p">)</code> <code class="p">}</code> <code class="k">if</code> <code class="n">id</code><code class="p">.</code><code class="n">homepage_key</code>
</pre></div>

</div>

<p>There are two great things about this solution. First, Ciaran doesn&rsquo;t need to calculate a result, he is just performing this computation for its side-effect, <code>puts</code>. Therefore, using a kestrel like <code>#tap</code> signals that he is not interested in the result. Second, he is using an off-the-shelf component and not writing a &ldquo;horrid untyped lambda calculus construct&rdquo; to get the job done. Fewer moving parts is a laudable goal.</p>

<p>That being said, when solving other problems, this solution may not meet our needs:</p>

<ul>
  <li>Since it doesn&rsquo;t return a result, we cannot use it for functions that compute values and not just generate side effects;</li>
  <li>Within the lambda, our <code>recurse</code> function must be called with itself as a parameter. This mixes the mechanics of our recursive implementation up with the semantics of what we&rsquo;re trying to accomplish.</li>
</ul>

<p>If we find ourselves needing to work around these limitations, we&rsquo;ll need to go a bit further. Let&rsquo;s use a brutally trivial example, factorial. (The naive implementation of factorial is a <em>terrible</em> piece of programming, but it&rsquo;s simple enough that we can focus on how we&rsquo;re implementing recursion and not what we are computing).</p>

<p>We could use one of our existing recursive combinators like <code>linrec</code>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">include</code> <code class="s">&#39;string-to_proc&#39;</code>

<code class="n">linrec</code><code class="p">(</code><code class="s">&#39;&lt; 2&#39;</code><code class="p">,</code> <code class="s">&#39;1&#39;</code><code class="p">,</code> <code class="s">&#39;n -&gt; [n, n - 1]&#39;</code><code class="p">,</code> <code class="s">&#39;*&#39;</code><code class="p">).</code><code class="n">call</code><code class="p">(</code>5<code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> 120

# <code class="n">or</code> <code class="n">perhaps</code> <code class="n">you</code> <code class="n">prefer</code><code class="p">...</code>

<code class="n">linrec</code><code class="p">(</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">&lt;</code> 2 <code class="p">},</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> 1 <code class="p">},</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="o">|</code> <code class="p">[</code><code class="n">n</code><code class="p">,</code> <code class="n">n</code> <code class="o">-</code> 1<code class="p">]</code> <code class="p">},</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">n</code><code class="p">,</code> <code class="n">m</code><code class="o">|</code> <code class="n">n</code> <code class="o">*</code> <code class="n">m</code> <code class="p">}</code>
<code class="p">).</code><code class="n">call</code><code class="p">(</code>5<code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> 120
</pre></div>

</div>

<p>That gets us what we want without using a untyped lambda calculus construct, because it uses a combinatorial logic construct instead. But let&rsquo;s work something out that is closer to the spirit of Ciaran&rsquo;s approach. For starters, we can&rsquo;t use <code>#tap</code> because we need the result of the computation, so we&rsquo;ll imagine we have a new method, <code>#rcall</code>. Our first cut will look like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Proc</code>

  <code class="n">def</code> <code class="n">rcall</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">)</code>
    <code class="n">call</code><code class="p">(</code><code class="n">self</code><code class="p">,</code> <code class="o">*</code><code class="n">args</code><code class="p">)</code>
  <code class="k">end</code>

<code class="k">end</code>

<code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">r</code><code class="p">,</code> <code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">&lt;</code> 2 ? 1 <code class="p">:</code> <code class="n">n</code> <code class="o">*</code> <code class="n">r</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">r</code><code class="p">,</code> <code class="n">n</code><code class="o">-</code>1<code class="p">)</code> <code class="p">}.</code><code class="n">rcall</code><code class="p">(</code>5<code class="p">)</code>
</pre></div>

</div>

<p>That solves our first problem very nicely: we can call a lambda with a value and it knows to pass itself to itself. Now what about our second problem? We are still cluttering up the inside of our function with passing itself to itself. Instead of calling <code>r.call(r, n-1)</code>, can we just call <code>r.call(n-1)</code>?</p>

<p>That would make our function look a lot simpler.</p>

<p>Well, we start with <code>lambda { |r, *args| ... }</code>. But if we are to call <code>r.call(n)</code>, we need to pass in a function like <code>lambda { |*args| ... }</code>. What does that function do? Send the message <code>#rcall</code> to our original function, of course. So we can write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Proc</code>

  <code class="n">def</code> <code class="n">rcall</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">)</code>
    <code class="n">call</code><code class="p">(</code><code class="n">lambda</code> <code class="p">{</code> <code class="o">|*</code><code class="n">args</code><code class="o">|</code> <code class="n">self</code><code class="p">.</code><code class="n">rcall</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">)</code> <code class="p">},</code> <code class="o">*</code><code class="n">args</code><code class="p">)</code>
  <code class="k">end</code>

<code class="k">end</code>

<code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">r</code><code class="p">,</code> <code class="n">n</code><code class="o">|</code> <code class="n">n</code> <code class="o">&lt;</code> 2 ? 1 <code class="p">:</code> <code class="n">n</code> <code class="o">*</code> <code class="n">r</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">n</code><code class="o">-</code>1<code class="p">)</code> <code class="p">}.</code><code class="n">rcall</code><code class="p">(</code>5<code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> 120
</pre></div>

</div>

<p>And that&rsquo;s it, we&rsquo;ve accomplished recursion without using any untyped lambda calculus constructs. It may look at first glance like we&rsquo;re using an anonymous recursive combinator like <a href="http://www.ece.uc.edu/~franco/C511/html/Scheme/ycomb.html" title="The Y Combinator">Y</a>, but we aren&rsquo;t. We&rsquo;re actually taking advantage of Ruby&rsquo;s <code>self</code> variable, so <code>#rcall</code> does not really implement anonymous recursion, it just lets us write recursive lambdas without explicitly binding them to a variable.</p>

<p>And our new method, <code>#rcall</code>, returns a value from our recursion and doesn&rsquo;t force us to remember to pass our lambda to itself when making a recursive call.</p>

<p>Cheers!</p>

<div class="code-block">
<div class="highlight"><pre><code class="k">class</code> <code class="nc">Proc</code>

  <code class="k">def</code> <code class="nf">rcall</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">)</code>
    <code class="n">call</code><code class="p">(</code><code class="nb">lambda</code> <code class="p">{</code> <code class="o">|*</code><code class="n">args</code><code class="o">|</code> <code class="nb">self</code><code class="o">.</code><code class="n">rcall</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">)</code> <code class="p">},</code> <code class="o">*</code><code class="n">args</code><code class="p">)</code>
  <code class="k">end</code>

<code class="k">end</code>
</pre></div>

</div>

<h2 section-num="9" id="you-cant-be-serious">You can&rsquo;t be serious!?</h2>

<p>In Practical Recursive Combinators, we enhanced <code>multirec</code> (a/k/a &ldquo;Divide and Conquer&rdquo;) and <code>linrec</code> (&ldquo;Linear Recursion&rdquo;) to accept as arguments any object that supports the <code>#to_proc</code> method. Today we&rsquo;re going demonstrate why: We will look at how removing the ceremony around lambdas makes using combinators like <code>multirec</code> more valuable for code we share with others.</p>

<p>Using <a href="http://github.com/raganwald/homoiconic/tree/master/2008-11-26/recursive_combinators.rb">recursive_combinators.rb</a> to define how to sum the squares of a nested list of numbers, we can write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">require</code> <code class="s">&#39;recursive_combinators&#39;</code>

<code class="n">include</code> <code class="n">RecursiveCombinators</code>

<code class="n">multirec</code><code class="p">(</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code> <code class="p">},</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code> <code class="o">**</code> 2 <code class="p">},</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code> <code class="p">},</code>
  <code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="o">|</code> <code class="n">x</code><code class="p">.</code><code class="n">inject</code> <code class="p">{</code> <code class="o">|</code><code class="n">sum</code><code class="p">,</code> <code class="n">n</code><code class="o">|</code> <code class="n">sum</code> <code class="o">+</code> <code class="n">n</code> <code class="p">}</code> <code class="p">}</code>
<code class="p">)</code>
</pre></div>

</div>

<p>The trouble with this&ndash;to quote <a href="http://www.amazon.com/gp/product/B000HA4WDY?ie=UTF8&amp;tag=raganwald001-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=B000HA4WDY" title="Amazon.com: Dr. Seuss' How the Grinch Stole Christmas! (50th Birthday Deluxe Remastered Edition)">a seasonally appropriate character</a>&ndash;is the noise, noise, Noise, NOISE! All those lambdas and parameter declarations outweigh the actual logic we are declaring, so much so that declaring this function using our abstraction is longer and may seem more obscure than declaring it without the abstraction.</p>

<p>This whole thing reminds me of languages where the keywords must be in UPPER CASE. Reading code in such languages is like listening to a poetry reading where the author shouts the punctuation:</p>

<blockquote>
  <p>Two roads diverged in a yellow wood COMMA!<br />
And sorry I could not travel both<br />
And be one traveler COMMA! long I stood<br />
And looked down one as far as I could<br />
To where it bent in the undergrowth SEMI-COMMA!!</p>
</blockquote>

<p>Finding ways to abbreviate our declaration is more than just a little &ldquo;syntactic sugar:&rdquo; It&rsquo;s a way of emphasizing what is important, our algorithms, and de-emphasizing what is not important, the scaffolding and ceremony of instantiating <code>Proc</code> objects in Ruby. One of those ways is to use <a href="http:string_to_proc.rb"><code>String#to_proc</code></a>.</p>

<h3 section-num="9.1" id="string-to-proc">String to Proc</h3>

<p><code>String#to_proc</code> adds the <code>#to_proc</code> method to the <code>String</code> class in Ruby. This allows you to write certain simple lambdas as strings instead of using the <code>lambda</code> keyword, the <code>proc</code> keyword, or <code>Proc.new</code>. The reason why you&rsquo;d bother is that <code>String#to_proc</code> provides some shortcuts that get rid of the noise.</p>

<p><strong>gives</strong></p>

<p><code>String#to_proc</code> provides several key abbreviations: First, <code>-&gt;</code> syntax for lambdas in Ruby 1.8. So instead of <code>lambda { |x,y| x + y }</code>, you can write <code>'x,y -&gt; x + y'</code>. I read this out loud as &ldquo;<em>x and y gives x plus y</em>.&rdquo; </p>

<p>This syntax gets rid of the noisy <code>lambda</code> keyword and is much closer to Ruby 1.9 syntax. And frankly, reading it out loud makes much more sense than reading lambdas aloud. Our example above could be written:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">require</code> <code class="s">&#39;string_to_proc&#39;</code>

<code class="n">multirec</code><code class="p">(</code>
  <code class="s">&#39;x -&gt; x.kind_of?(Numeric)&#39;</code><code class="p">,</code>
  <code class="s">&#39;x -&gt; x ** 2&#39;</code><code class="p">,</code>
  <code class="s">&#39;x -&gt; x&#39;</code><code class="p">,</code>
  <code class="s">&#39;x -&gt; x.inject { |sum, n| sum + n }&#39;</code>
<code class="p">)</code>
</pre></div>

</div>

<p>This is a lot better than the version with lambdas, and if the <code>-&gt;</code> seems foreign, it is only because <code>-&gt;</code> is in keeping with modern functional languages and mathematical notation, while <code>lambda</code> is in keeping with Lisp and lambda calculus notation without the ability to use a single lambda character unicode.</p>

<p><strong>inferred parameters</strong></p>

<p>Second, <code>String#to_proc</code> adds inferred parameters: If you do not use <code>-&gt;</code>, <code>String#to_proc</code> attempts to infer the parameters. So if you write <code>'x + y'</code>, <code>String#to_proc</code> treats it as <code>x,y -&gt; x + y</code>. There are certain expressions where this doesn&rsquo;t work, and you have to use <code>-&gt;</code>, but for really simple cases it works just fine. And frankly, for really simple cases you don&rsquo;t need the extra scaffolding. Here&rsquo;s our example with the first three lambdas using inferred parameters:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">multirec</code><code class="p">(</code>
  <code class="s">&#39;x.kind_of?(Numeric)&#39;</code><code class="p">,</code>
  <code class="s">&#39;x ** 2&#39;</code><code class="p">,</code>
  <code class="s">&#39;x&#39;</code><code class="p">,</code>
  <code class="s">&#39;z -&gt; z.inject { |sum, n| sum + n }&#39;</code>
<code class="p">)</code>
</pre></div>

</div>

<blockquote>
  <p>I have good news and bad news about inferred parameters and <code>String#to_proc</code> in general. It uses regular expressions to do its thing, which means that complicated things often don&rsquo;t work. For example, nesting <code>-&gt;</code> only works when writing functions that return functions. So <code>'x -&gt; y -&gt; x + y'</code> is a function that takes an <code>x</code> and returns a function that takes a <code>y</code> and returns <code>x + y</code>. That works. But <code>'z -&gt; z.inject(&amp;"sum, n -&gt; sum + n")'</code> does NOT work.</p>
</blockquote>

<blockquote>
  <p>I considered fixing this with more sophisticated parsing, however the simple truth is this: <code>String#to_proc</code> is not a replacement for <code>lambda</code>, it&rsquo;s a tool to be used when what you&rsquo;re doing is so simple that <code>lambda</code> is overkill. If <code>String#to_proc</code> doesn&rsquo;t work for something, it probably isn&rsquo;t ridiculously simple any more.</p>
</blockquote>

<p><strong>it</strong></p>

<p>The third abbreviation is a special case. If there is only one parameter, you can use <code>_</code> (the underscore) without naming it. This is often called the &ldquo;hole&rdquo; or pronounced &ldquo;it.&rdquo; If you use &ldquo;it,&rdquo; then <code>String#to_proc</code> doesn&rsquo;t try to infer any more parameters, so this can help you write things like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">multirec</code><code class="p">(</code>
  <code class="s">&#39;_.kind_of?(Numeric)&#39;</code><code class="p">,</code>
  <code class="s">&#39;_ ** 2&#39;</code><code class="p">,</code>
  <code class="s">&#39;_&#39;</code><code class="p">,</code>
  <code class="s">&#39;_.inject { |sum, n| sum + n }&#39;</code>
<code class="p">)</code>
</pre></div>

</div>

<p>Admittedly, use of &ldquo;it&rdquo;/the hole is very much a matter of taste.</p>

<p><strong>point-free</strong></p>

<p><code>String#to_proc</code> has a fourth and even more extreme abbreviation up its sleeve, <a href="http://blog.plover.com/prog/haskell/" title="The Universe of Discourse : Note on point-free programming style">point-free style</a>: &ldquo;Function points&rdquo; are what functional programmers usually call parameters. Point-free style consists of describing how functions are composed together rather than describing what happens with their arguments. So, let&rsquo;s say that I want a function that combines <code>.inject</code> with <code>+</code>. One way to say that is to say that I want a new function that takes its argument and applies an <code>inject</code> to it, and the inject takes another function with two arguments and applies a <code>+</code> to them:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">lambda</code> <code class="p">{</code> <code class="o">|</code><code class="n">z</code><code class="o">|</code> <code class="n">z</code><code class="p">.</code><code class="n">inject</code> <code class="p">{</code> <code class="o">|</code><code class="n">sum</code><code class="p">,</code> <code class="n">n</code><code class="o">|</code> <code class="n">sum</code> <code class="o">+</code> <code class="n">n</code> <code class="p">}</code> <code class="p">}</code>
</pre></div>

</div>

<p>The other way is to say that I want to compose <code>.inject</code> and <code>+</code> together. Without getting into a <code>compose</code> function like Haskell&rsquo;s <code>.</code> operator, <code>String#to_proc</code> has enough magic to let us write the above as:</p>

<div class="code-block">
<div class="highlight"><pre>&quot;<code class="p">.</code><code class="n">inject</code><code class="p">(</code><code class="o">&amp;</code><code class="s">&#39;+&#39;</code><code class="p">)</code>&quot;
</pre></div>

</div>

<p>Meaning &ldquo;<em>I want a new lambda that does an inject using plus</em>.&rdquo; Point-free style does require a new way of thinking about some things, but it is a clear win for simple cases. Proof positive of this is the fact that Ruby on Rails and Ruby 1.9 have both embraced point-free style with <code>Symbol#to_proc</code>. That&rsquo;s exactly how <a href="http://weblog.raganwald.com/2008/02/1100inject.html" title="(1..100).inject(&amp;:+)"><code>(1..100).inject(&amp;:+)</code></a> works!</p>

<p><code>String#to_proc</code> supports fairly simple cases where you are sending a message or using a binary operator. So if we wanted to go all out, we could write our example as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">multirec</code><code class="p">(</code><code class="s">&#39;.kind_of?(Numeric)&#39;</code><code class="p">,</code> <code class="s">&#39;** 2&#39;</code><code class="p">,</code> <code class="s">&#39;x&#39;</code><code class="p">,</code> &quot;<code class="p">.</code><code class="n">inject</code><code class="p">(</code><code class="o">&amp;</code><code class="s">&#39;+&#39;</code><code class="p">)</code>&quot;<code class="p">)</code>
</pre></div>

</div>

<blockquote>
  <p>There&rsquo;s no point-free magic for the identity function, although this example tempts me to special case the empty string!</p>
</blockquote>

<p><strong>When should we use all these tricks?</strong></p>

<p><code>String#to_proc</code> provides these options so that you as a programmer can choose your level of ceremony around writing functions. But of course, you have to use the tool wisely. My <em>personal</em> rules of thumb are:</p>

<ol>
  <li>Embrace inferred parameters for well-known mathematical or logical operations. For these operations, descriptive parameter names are usually superfluous. Follow the well-known standard and use <code>x</code>, <code>y</code>, <code>z</code>, and <code>w</code>;  or <code>a</code>, <code>b</code> and <code>c</code>; or <code>n</code>, <code>i</code>, <code>j</code>, and <code>k</code> for the parameters. If whatever it is makes no sense using those variable names, don&rsquo;t used inferred parameters.</li>
  <li>Embrace the hole for extremely simple one-parameter lambdas that aren&rsquo;t intrinsically mathematical or logical such as methods that use <code>.method_name</code> and for the identity function.</li>
  <li>Embrace point-free style for methods that look like operators.</li>
  <li>Embrace <code>-&gt;</code> notation for extremely simple cases where I want to give the parameters a descriptive name.</li>
  <li>Use lambdas for everything else.</li>
</ol>

<p>So I would write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">multirec</code><code class="p">(</code> <code class="s">&#39;_.kind_of?(Numeric)&#39;</code><code class="p">,</code> <code class="s">&#39;** 2&#39;</code><code class="p">,</code> <code class="s">&#39;_&#39;</code><code class="p">,</code> &quot;<code class="n">_</code><code class="p">.</code><code class="n">inject</code><code class="p">(</code><code class="o">&amp;</code><code class="s">&#39;+&#39;</code><code class="p">)</code>&quot;<code class="p">)</code>
</pre></div>

</div>

<p>I read the parameters out loud as:</p>

<ul>
  <li><em>it kind_of? Numeric;</em></li>
  <li><em>raise to the power of two;</em></li>
  <li><em>it;</em></li>
  <li><em>it inject plus</em>.</li>
</ul>

<p>And yes, I consider <code>multirec( '_.kind_of?(Numeric)', '** 2', '_', "_.inject(&amp;'+')")</code> more succinct and easier to read than: </p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">sum_squares</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
  <code class="k">if</code> <code class="n">value</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Numeric</code><code class="p">)</code>
    <code class="n">value</code> <code class="o">**</code> 2
  <code class="k">else</code>
    <code class="n">value</code><code class="p">.</code><code class="n">map</code> <code class="n">do</code> <code class="o">|</code><code class="n">sub_value</code><code class="o">|</code>
      <code class="n">sum_squares</code><code class="p">(</code><code class="n">sub_value</code><code class="p">)</code>
    <code class="k">end</code><code class="p">.</code><code class="n">inject</code> <code class="p">{</code> <code class="o">|</code><code class="n">x</code><code class="p">,</code><code class="n">y</code><code class="o">|</code> <code class="n">x</code> <code class="o">+</code> <code class="n">y</code> <code class="p">}</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>If all this is new too you, <code>String#to_proc</code> may seem like gibberish and <code>def sum_squares</code> may seem reassuringly sensible. But try to remember that combinators like <code>multirec</code> are built to disentangle the question of what we are doing from how we are doing it. This is the third straight post about recursive combinators using one of three different examples. So of course we know what <code>sum_squares</code> does and how it does it.</p>

<p>But try to imagine you are looking at a piece of code that isn&rsquo;t so simple, that isn&rsquo;t so obvious. Maybe it was written by someone else, maybe you wrote it a while  ago. If you see:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">def</code> <code class="n">rotate</code><code class="p">(</code><code class="n">square</code><code class="p">)</code>
  <code class="k">return</code> <code class="n">square</code> <code class="n">unless</code> <code class="n">square</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="n">square</code><code class="p">.</code><code class="nb">size</code> <code class="o">&gt;</code> 1
  <code class="n">half_sz</code> <code class="p">=</code> <code class="n">square</code><code class="p">.</code><code class="nb">size</code> <code class="o">/</code> 2
  <code class="n">sub_square</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">row</code><code class="p">,</code> <code class="n">col</code><code class="o">|</code>
    <code class="n">square</code><code class="p">.</code><code class="n">slice</code><code class="p">(</code><code class="n">row</code><code class="p">,</code> <code class="n">half_sz</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">a_row</code><code class="o">|</code> <code class="n">a_row</code><code class="p">.</code><code class="n">slice</code><code class="p">(</code><code class="n">col</code><code class="p">,</code> <code class="n">half_sz</code><code class="p">)</code> <code class="p">}</code>
  <code class="k">end</code>
  <code class="n">upper_left</code> <code class="p">=</code> <code class="n">rotate</code><code class="p">(</code><code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>0<code class="p">,</code>0<code class="p">))</code>
  <code class="n">lower_left</code> <code class="p">=</code> <code class="n">rotate</code><code class="p">(</code><code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">half_sz</code><code class="p">,</code>0<code class="p">))</code>
  <code class="n">upper_right</code> <code class="p">=</code> <code class="n">rotate</code><code class="p">(</code><code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>0<code class="p">,</code><code class="n">half_sz</code><code class="p">))</code>
  <code class="n">lower_right</code> <code class="p">=</code> <code class="n">rotate</code><code class="p">(</code><code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">half_sz</code><code class="p">,</code><code class="n">half_sz</code><code class="p">))</code>
  <code class="n">upper_right</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">lower_right</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">l</code><code class="p">,</code><code class="n">r</code><code class="o">|</code> <code class="n">l</code> <code class="o">+</code> <code class="n">r</code> <code class="p">}</code> <code class="o">+</code>
    <code class="n">upper_left</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">lower_left</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">l</code><code class="p">,</code><code class="n">r</code><code class="o">|</code> <code class="n">l</code> <code class="o">+</code> <code class="n">r</code> <code class="p">}</code>
<code class="k">end</code>
</pre></div>

</div>

<p>Do you see at once how it works? Do you see at a glance whether the recursive strategy was implemented properly? Can you tell whether there&rsquo;s something buggy about it? For example, this code only works rotating square matrices that have sides which are powers of two. What needs to be changed to fix that? Are you sure you can fix it without breaking the divide and conquer strategy?</p>

<p>For a method like this, I would write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">multirec</code><code class="p">(</code>
  <code class="p">:</code><code class="n">cond</code> <code class="p">=</code><code class="o">&gt;</code> &quot;!<code class="p">(</code><code class="n">_</code><code class="p">.</code><code class="n">kind_of</code>?<code class="p">(</code><code class="n">Enumerable</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="n">_</code><code class="p">.</code><code class="nb">size</code> <code class="o">&gt;</code> 1<code class="p">)</code>&quot;<code class="p">,</code>
  <code class="p">:</code><code class="n">then</code> <code class="p">=</code><code class="o">&gt;</code> &quot;<code class="n">_</code>&quot;<code class="p">,</code>
  <code class="p">:</code><code class="n">before</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">square</code><code class="o">|</code>
    <code class="n">half_sz</code> <code class="p">=</code> <code class="n">square</code><code class="p">.</code><code class="nb">size</code> <code class="o">/</code> 2
    <code class="n">sub_square</code> <code class="p">=</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">row</code><code class="p">,</code> <code class="n">col</code><code class="o">|</code>
      <code class="n">square</code><code class="p">.</code><code class="n">slice</code><code class="p">(</code><code class="n">row</code><code class="p">,</code> <code class="n">half_sz</code><code class="p">).</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">a_row</code><code class="o">|</code> <code class="n">a_row</code><code class="p">.</code><code class="n">slice</code><code class="p">(</code><code class="n">col</code><code class="p">,</code> <code class="n">half_sz</code><code class="p">)</code> <code class="p">}</code>
    <code class="k">end</code>
    <code class="n">upper_left</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>0<code class="p">,</code>0<code class="p">)</code>
    <code class="n">lower_left</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">half_sz</code><code class="p">,</code>0<code class="p">)</code>
    <code class="n">upper_right</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code>0<code class="p">,</code><code class="n">half_sz</code><code class="p">)</code>
    <code class="n">lower_right</code> <code class="p">=</code> <code class="n">sub_square</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">half_sz</code><code class="p">,</code><code class="n">half_sz</code><code class="p">)</code>
    <code class="p">[</code><code class="n">upper_left</code><code class="p">,</code> <code class="n">lower_left</code><code class="p">,</code> <code class="n">upper_right</code><code class="p">,</code> <code class="n">lower_right</code><code class="p">]</code>
  <code class="k">end</code><code class="p">,</code>
  <code class="p">:</code><code class="n">after</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">lambda</code> <code class="n">do</code> <code class="o">|</code><code class="n">list</code><code class="o">|</code>
    <code class="n">upper_left</code><code class="p">,</code> <code class="n">lower_left</code><code class="p">,</code> <code class="n">upper_right</code><code class="p">,</code> <code class="n">lower_right</code> <code class="p">=</code> <code class="n">list</code>
    <code class="n">upper_right</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">lower_right</code><code class="p">).</code><code class="n">map</code><code class="p">(</code><code class="o">&amp;</code><code class="s">&#39;+&#39;</code><code class="p">)</code> <code class="o">+</code> <code class="n">upper_left</code><code class="p">.</code><code class="n">zip</code><code class="p">(</code><code class="n">lower_left</code><code class="p">).</code><code class="n">map</code><code class="p">(</code><code class="o">\</code>
<code class="o">&amp;</code><code class="s">&#39;+&#39;</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

</div>

<p>And be assured that months from now if I wanted to support rotating rectangular matrices of arbitrary size, I could modify <code>:cond</code>, <code>:before</code>, and <code>:after</code> with confidence that the basic method was not being broken.</p>

<h3 section-num="9.2" id="the-message">The Message</h3>

<p>The message here is that taken by themselves, tools like recursive combinators or <code>String#to_proc</code> just look strange. But when we use them together, they reinforce each other and the sum becomes much greater than the sum of the parts. In the case of <code>String#to_proc</code>, it looks like frivolity to most Ruby programmers, because they don&rsquo;t use that many lambdas: Why should they when the existing syntax makes writing combinators hard to use? But when we have combinators in our hand, we see how <code>String#to_proc</code> can make them a win. So two things that look weird on their own are a useful tool when used in conjunction.</p>

<p>Our final example ended up being slightly longer than a naive version, however it is longer in ways that matter rather than longer in a mindless ceremonial way like some languages.</p>

<p>And that&rsquo;s the point of languages like Ruby: <strong>You</strong> have the tools to decide which portions of you code matter more than others, and to make the parts that matter stand out and the parts that don&rsquo;t go away. You may disagree with my choice of what matters for a recursive divide and conquer algorithm, but I hope we can agree that it&rsquo;s valuable to be able to make that choice for yourself or your team.</p>

<p>Seriously.</p>

<h2 section-num="10" id="the-hopelessly-egocentric-book-chapter">The Hopelessly Egocentric Book Chapter</h2>

<p>In Raymond Smullyan&rsquo;s delightful book on Combinatory logic, <a href="http://www.amazon.com/gp/product/0192801422?ie=UTF8&amp;tag=raganwald001-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=0192801422">To Mock a Mockingbird</a>, Smullyan explains combinatory logic and derives a number of important results by presenting the various combinators as songbirds in a forest. One of his concepts is the Hopelessly Egocentric Bird:</p>

<blockquote>
  <p>We call a bird B <em>hopelessly egocentric</em> if for <em>every</em> bird <code>x</code>, <code>Bx = B</code>. This means that whatever bird <code>x</code> you call out to <code>B</code> is irrelevant; it only calls <code>B</code> back to you! Imagine that the bird&rsquo;s name is Bertrand. When you call out &ldquo;Arthur,&rdquo; you get the response &ldquo;Bertrand&rdquo;; when you call out &ldquo;Raymond,&rdquo; you get the response &ldquo;Bertrand&rdquo;; when you call out &ldquo;Ann,&rdquo; you get the response &ldquo;Bertrand.&rdquo; All this bird can ever think about is itself!</p>
</blockquote>

<p>Some folks have proposed that by making Ruby&rsquo;s <code>nil</code> hopelessly egocentric, we can avoid the need for monadic idioms like <code>#andand</code>. Let&rsquo;s examine the idea and see what consequences this has.</p>

<h3 section-num="10.1" id="object-oriented-egocentricity">Object-oriented egocentricity</h3>

<p>One of the tenets of OO programming is that programs consist of <em>objects</em> that respond to <em>messages</em> they send each other. A hopelessly egocentric object is easy to imagine: No matter what message you send it, the hopelessly egocentric object responds with itself:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">HopelesslyEgocentric</code> <code class="o">&lt;</code> <code class="n">BlankSlate</code>

  <code class="n">def</code> <code class="n">method_missing</code><code class="p">(</code><code class="o">*</code><code class="n">arguments</code><code class="p">);</code> <code class="n">self</code><code class="p">;</code> <code class="k">end</code>

<code class="k">end</code>
</pre></div>

</div>

<p>Now you can create a hopelessly egocentric object with <code>HopelesslyEgocentric.new</code> and no matter what message you send it, you will get it back in response. And? What good is this? What can it do? Why should we put it in our Zoo? </p>

<p>In Objective C, nil is hopelessly egocentric. As <a href="http://cocoadevcentral.com/d/learn_objectivec/" title="Cocoa Dev Central: Learn Objective-C">Learn Objective-C</a> puts it, <em>You usually don&rsquo;t need to check for nil before calling a method on an object. If you call a method on nil that returns an object, you will get nil as a return value.</em> The idea here is that instead of getting a <code>NoMethodError</code> when we send a message to nil, we get nil back.</p>

<p>Some people like this so much they&rsquo;ve <a href="http://rubyenrails.nl/articles/2008/02/29/our-daily-method-18-nilclass-method_missing" title="NilClass#method_missing">composed the same semantics for Ruby</a>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">NilClass</code>

  <code class="n">def</code> <code class="n">method_missing</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">);</code> <code class="n">nil</code><code class="p">;</code> <code class="k">end</code>

<code class="k">end</code>
</pre></div>

</div>

<p>Now instead of writing <code>person &amp;&amp; person.name &amp;&amp; person.name.upcase</code> or <code>person.andand.name.andand.upcase</code>, you write <code>person.name.upcase</code> and either get the person&rsquo;s name in upper case or nil. Wonderful! Or is it? Let&rsquo;s take a look at what we&rsquo;re trying to accomplish and the limitations of this approach.</p>

<p><strong>queries</strong></p>

<p>Hopelessly egocentric nil works reasonably for querying <em>properties</em>, in other words sub-entities when an entity is constructed by composition, things like <code>.name</code>. I&rsquo;m quite happy if <code>person.name</code> returns nil whether we don&rsquo;t have a person or if the person doesn&rsquo;t have a name. And we can extend this to what I would call <em>purely functional transformations</em> like <code>.upcase</code>. Just as <code>''.upcase</code> is <code>''</code>, it is reasonable to think of <code>nil.upcase</code> as nil. </p>

<p>Now let&rsquo;s look at some things that aren&rsquo;t properties and aren&rsquo;t purely functional transformations. What do we do with methods that are intended to <em>update</em> their receiver? Consider a bank account object. Do we really want to write things like:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">person</code><code class="p">.</code><code class="n">account</code> <code class="p">=</code> <code class="n">nil</code>
<code class="n">person</code><code class="p">.</code><code class="n">account</code><code class="p">.</code><code class="n">increment_balance</code><code class="p">(</code>100<code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>This makes no sense. If we want to give them a hundred dollars, we had better have their actual account on hand! Clearly there is a huge difference between methods that are <em>queries</em> and methods that are <em>updates</em>. (Note that <code>andand</code> doesn&rsquo;t save us either, except by virtue of being explicit rather than magical so we can eschew it for update methods like <code>#increment_balance</code>.)</p>

<p><strong>updates</strong></p>

<p>Now that we are talking about methods with side-effects, let&rsquo;s be more specific. Our hopelessly egocentric nil does return nil to any method. But it has another property, it has no side-effects. This is sometimes what we want! Let&rsquo;s look at our nil account again. What about this code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">person</code><code class="p">.</code><code class="n">account</code><code class="p">.</code><code class="n">update_attribute</code><code class="p">(:</code><code class="n">primary_email</code><code class="p">,</code> <code class="s">&#39;reg@braythwayt.com&#39;</code><code class="p">)</code>
</pre></div>

</div>

<p>To decide what we think of this, we need to be specific about the meaning of nil. Generally, nil means one of two things:</p>

<ol>
  <li>NONE, meaning &ldquo;There isn&rsquo;t one of these,&rdquo; or;</li>
  <li>UNKNOWN, meaning &ldquo;There <em>is</em> one of these, but we don&rsquo;t know what it is.&rdquo;</li>
</ol>

<p><code>person.account.update_attribute(:primary_email, 'reg@braythwayt.com')</code> is an example of why this difference matters. If <code>person.account</code> is an account, we want to update its primary email address, of course. And if <code>person.account</code> is NONE, we might be very happy not updating its primary email address. Perhaps our code looks like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Person</code> <code class="o">&lt;</code> <code class="n">ActiveRecord</code><code class="p">::</code><code class="n">Base</code>
  <code class="n">belongs_to</code> <code class="p">:</code><code class="n">account</code>

  <code class="n">def</code> <code class="n">update_email</code><code class="p">(</code><code class="n">new_email</code><code class="p">)</code>
    <code class="n">self</code><code class="p">.</code><code class="n">class</code><code class="p">.</code><code class="n">transaction</code> <code class="n">do</code>
      <code class="n">update_attribute</code><code class="p">(:</code><code class="n">primary_email</code><code class="p">,</code> <code class="n">new_email</code><code class="p">)</code>
      <code class="n">account</code><code class="p">.</code><code class="n">update_attribute</code><code class="p">(:</code><code class="n">primary_email</code><code class="p">,</code> <code class="n">new_email</code><code class="p">)</code>
    <code class="k">end</code>
  <code class="k">end</code>

  # <code class="p">...</code>

<code class="k">end</code>

<code class="n">Person</code><code class="p">.</code><code class="nb">find</code><code class="p">(:</code><code class="n">first</code><code class="p">,</code> <code class="p">:</code><code class="n">conditions</code> <code class="p">=</code><code class="o">&gt;</code> <code class="p">{...}).</code><code class="n">update_email</code><code class="p">(</code><code class="s">&#39;reg@braythwayt.com&#39;</code><code class="o">\</code>
<code class="p">)</code>
</pre></div>

</div>

<p>Meaning, update our person&rsquo;s primary email address, and if they have an account, update it too. If nil means NONE, this works. But what if nil really means UNKNOWN rather than NONE? <strong>Now it is wrong to silently fail</strong>. Let me give you a very specific way this can happen. When performing a database query, we can specify the exact columns we want returned. In Active Record, we might write something like this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">person</code> <code class="p">=</code> <code class="n">Person</code><code class="p">.</code><code class="nb">find</code><code class="p">(:</code><code class="n">first</code><code class="p">,</code> <code class="p">:</code><code class="n">conditions</code> <code class="p">=</code><code class="o">&gt;</code> <code class="p">{...},</code> <code class="p">:</code><code class="n">select</code> <code class="p">=</code><code class="o">&gt;</code> <code class="s">&#39;id, name&#39;</code><code class="p">)</code>
</pre></div>

</div>

<p>What this means is that there is an <code>account_id</code> column in the <code>people</code> table, however we are deliberately not loading it into <code>person</code>. ActiveRecord will still supply us with a <code>#account</code> method, however it will return nil. This absolutely, positively means that <code>person.account</code> is UNKNOWN, not NONE. There could well be an account in our database for this person, and now if we write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">person</code><code class="p">.</code><code class="n">update_email</code><code class="p">(</code><code class="s">&#39;reg@braythwayt.com&#39;</code><code class="p">)</code>
</pre></div>

</div>

<p>We do not want it to silently ignore the account email update, because we haven&rsquo;t loaded the <code>account</code> associated model. So for UNKNOWN, our two rules are:</p>

<ol>
  <li>Querying UNKNOWN returns UNKNOWN;</li>
  <li>All attempts to update UNKNOWN are errors.</li>
</ol>

<p>What about NONE? We gave two examples of updates, one of which was a really bad idea,<code>#increment_balance</code>, and the other of which was fine <code>update_attribute(:primary_email, new_email)</code>. Thus we have three rules for NONE:</p>

<ol>
  <li>Querying NONE returns NONE;</li>
  <li>Some updates to NONE may return NONE and have no side effects;</li>
  <li>Some updates to NONE may be errors.</li>
</ol>

<p>With a little forethought and design, you may be able to construct one or more classes if your application for which all updates to NONE return NONE and have no side effects. But for all others, methods like <code>#increment_balance</code> represent a semantic problem with using a hopelessly egocentric nil to represent NONE. We also see a problem with writing a hopelessly egocentric nil to handle UNKNOWN: How does it know which methods are queries and which methods are updates?</p>

<p>If we work really hard and eliminate all possibility of an update to NONE being an error, are there any other issues with using a hopelessly egocentric nil? Let&rsquo;s return to our initial case:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">person</code><code class="p">.</code><code class="n">name</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>

<code class="n">person</code><code class="p">.</code><code class="n">name</code><code class="p">.</code><code class="n">upcase</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>Makes sense. And then we write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">person</code><code class="p">.</code><code class="n">name</code> <code class="o">+</code> &quot;<code class="p">,</code> <code class="n">esq</code><code class="p">.</code>&quot;
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">nil</code>
</pre></div>

</div>

<p>Dubious, but let&rsquo;s go with it. If this makes sense, we ought to be able to write this as well:</p>

<div class="code-block">
<div class="highlight"><pre>&quot;<code class="n">Mister</code> &quot; <code class="o">+</code> <code class="n">person</code><code class="p">.</code><code class="n">name</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">TypeError</code><code class="p">:</code> <code class="n">can</code><code class="o">&#39;</code><code class="n">t</code> <code class="n">convert</code> <code class="n">nil</code> <code class="n">into</code> <code class="n">String</code>
</pre></div>

</div>

<p><a href="http://weblog.raganwald.com/2007/10/too-much-of-good-thing-not-all.html" title="Too much of a good thing: not all functions should be object methods">Why is this an error?</a> Things don&rsquo;t get any better using a hopelessly egocentric nil to handle UNKNOWN. Even if we can get past the issue of update methods, we have another problem that is much more difficult to resolve. UNKNOWN introduces tri-value logic:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">UNKNOWN</code> <code class="o">==</code> <code class="n">Object</code><code class="p">.</code><code class="n">new</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">UNKNOWN</code>
<code class="n">UNKNOWN</code> !<code class="p">=</code> <code class="n">Object</code><code class="p">.</code><code class="n">new</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">UNKNOWN</code>
<code class="n">UNKNOWN</code> <code class="o">==</code> <code class="n">UNKNOWN</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">UNKNOWN</code>
<code class="n">UNKNOWN</code> !<code class="p">=</code> <code class="n">UNKNOWN</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">UNKNOWN</code>
<code class="n">Object</code><code class="p">.</code><code class="n">new</code> <code class="o">==</code> <code class="n">UNKNOWN</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">UNKNOWN</code>
<code class="n">Object</code><code class="p">.</code><code class="n">new</code> !<code class="p">=</code> <code class="n">UNKNOWN</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">UNKNOWN</code>
</pre></div>

</div>

<p>When you don&rsquo;t know something&rsquo;s value, it is neither equal to nor not equal to any other value, including another unknown value. And our fifth and sixth examples suffer from the same problem as <code>nil + ", esq."</code> vs. <code>"Mister " + nil</code>. We would need to patch all sorts of other objects to make equality testing many many other methods work. (What is <code>42 &lt; UNKNOWN</code>?) But things get worse:</p>

<p>How does <em>truthiness</em> work? In Ruby, you cannot override the way <code>and</code>, <code>or</code>, <code>if</code>, <code>unless</code>, <code>&amp;&amp;</code>, and <code>||</code> work. What are the semantics of <code>if UNKNOWN</code>? What do <code>true &amp;&amp; UNKNOWN</code> or <code>UNKNOWN or true</code> return? Before implementing a true UNKNOWN in any language, I would want those questions answered.</p>

<p>Finally, there is actually a fifth and sixth rule that we are ignoring because these examples are in Ruby rather than a language with an expressive type system. Consider:</p>

<div class="code-block">
<div class="highlight"><pre><code class="s">&#39;Reg Braithwaite&#39;</code><code class="p">.</code><code class="n">wealthy</code>?
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">NoMethodError</code><code class="p">:</code> <code class="n">undefined</code> <code class="n">method</code> `<code class="n">wealthy</code>?<code class="s">&#39;</code><code class="err"> for &quot;Reg Braithwaite&quot;:Strin\</code>
<code class="n">g</code>
</pre></div>

</div>

<p>And now we write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">person</code><code class="p">.</code><code class="n">name</code><code class="p">.</code><code class="n">wealthy</code>?         # <code class="n">or</code><code class="p">...</code>
<code class="n">person</code><code class="p">.</code><code class="n">name</code><code class="p">.</code><code class="n">andand</code><code class="p">.</code><code class="n">wealthy</code>?
</pre></div>

</div>

<p>What happens if <code>person.name</code> is NONE? What happens if <code>person.name</code> is UNKNOWN? Our problem here is that <code>#wealthy?</code> is never a valid message to send to something returned by <code>person.name</code>. Our behaviour ought to be:</p>

<ul>
  <li>Sending an invalid message to NONE raises a <code>NoMethodError</code>;</li>
  <li>Sending an invalid message to UNKNOWN raises a <code>NoMethodError</code>.</li>
</ul>

<p>There is no easy way to do this in Ruby, of course. Not only do we have trouble disambiguating queries from updates, we have trouble disambiguating valid from invalid messages.</p>

<p>For all of these reasons, I am loathe to implement a hopelessly egocentric nil and prefer to use an explicit idiom like <code>#andand</code> or <code>#try</code>. With explicit idioms, I can deal with the ambiguity between nil meaning NONE and nil meaning UNKNOWN and make sure my code does not violate the rules given here. But what I like about the <em>idea</em> of a hopelessly egocentric nil is that thinking the consequences provokes me to really think about the semantics of my data schemas.</p>

<p>Representing NONE and UNKNOWN values is a subtle problem requiring a deep and pervasive approach to typing similar to C++&rsquo;s <code>const</code> keyword and/or writing custom <a href="http://en.wikipedia.org/wiki/Null_Object_pattern" title="Null Object pattern - Wikipedia, the free encyclopedia">null objects</a> that understand which methods are safe to respond egocentrically and which are errors.</p>

<h2 section-num="11" id="bonus-chapter-separating-concerns-in-coffeescript-using-aspect-oriented-programming">Bonus Chapter: Separating Concerns in Coffeescript using Aspect-Oriented Programming</h2>

<p><em>This chapter isn&rsquo;t strictly about combinatory logic and it especially isn&rsquo;t about Ruby programming. However, once you grasp the underlying fundamental principles, you can apply them in other environments using other programming languages.</em></p>

<p><em>You shouldn&rsquo;t find it too difficult to relate the content to previous chapters, the title alone provides a massive hint.</em></p>

<p>Modern object-oriented software design <a href="https://en.wikipedia.org/wiki/Composition_over_inheritance">favours composition over inheritance</a> and celebrates code that is <a href="http://en.wikipedia.org/wiki/Don't_repeat_yourself">DRY</a>. The idea is to separate each object&rsquo;s concerns and responsibility into separate units of code, each of which have a single responsibility. When two different types of objects share the same functionality, they do not repeat their implementation, instead they share their implementation.</p>

<p>When composing functionality at the method level of granularity, techniques such as mixins and delegation are effective design tools. But at a finer level of granularity, we sometimes wish to share functionality within methods. In a traditional design, we have to extract the shared functionality into a separate method that is called by other methods.</p>

<p><strong>decomposing methods</strong></p>

<p>You might think of extracting smaller methods from bigger methods as <em>decomposing</em> methods. You break them into smaller pieces, and thus you can share functionality or rearrange the pieces so that your code is organized by responsibility.</p>

<p>For example, let&rsquo;s say that we are writing a game for the nostalgia market, and we wish to use partially constructed objects to save resources. When we go to actually use the object, we <em>hydrate</em> it, loading the complete object from persistent storage. This is a coarse kind of <em>lazy evaluation</em>.</p>

<p>Here&rsquo;s some bogus code:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Wumpus</code>
  <code class="n">roar</code><code class="p">:</code> <code class="o">-&gt;</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">hydrates</code> <code class="n">a</code> <code class="n">Wumpus</code>
    # <code class="p">...</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">roars</code>
    # <code class="p">...</code>
  <code class="n">run</code><code class="p">:</code> <code class="o">-&gt;</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">hydrates</code> <code class="n">a</code> <code class="n">Wumpus</code>
    # <code class="p">...</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">runs</code>
    # <code class="p">...</code>

<code class="n">class</code> <code class="n">Hunter</code>
  <code class="n">draw</code><code class="p">:</code> <code class="p">(</code><code class="n">bow</code><code class="p">)</code> <code class="o">-&gt;</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">hydrates</code> <code class="n">a</code> <code class="n">Hunter</code>
    # <code class="p">...</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">draws</code> <code class="n">a</code> <code class="n">bow</code>
    # <code class="p">...</code>
  <code class="n">run</code><code class="p">:</code> <code class="o">-&gt;</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">hydrates</code> <code class="n">a</code> <code class="n">Hunter</code>
    # <code class="p">...</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">runs</code>
    # <code class="p">...</code>
</pre></div>

</div>

<p>We can decompose it into this:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">Wumpus</code>
  <code class="n">roar</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">hydrate</code><code class="p">(</code><code class="n">this</code><code class="p">)</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">roars</code>
    # <code class="p">...</code>
  <code class="n">run</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">hydrate</code><code class="p">(</code><code class="n">this</code><code class="p">)</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">runs</code>
    # <code class="p">...</code>

<code class="n">class</code> <code class="n">Hunter</code>
  <code class="n">draw</code><code class="p">:</code> <code class="p">(</code><code class="n">bow</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">hydrate</code><code class="p">(</code><code class="n">this</code><code class="p">)</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">draws</code> <code class="n">a</code> <code class="n">bow</code>
    # <code class="p">...</code>
  <code class="n">run</code><code class="p">:</code> <code class="o">-&gt;</code>
    <code class="n">hydrate</code><code class="p">(</code><code class="n">this</code><code class="p">)</code>
    # <code class="n">code</code> <code class="n">that</code> <code class="n">runs</code>
    # <code class="p">...</code>

<code class="n">hydrate</code> <code class="p">=</code> <code class="p">(</code><code class="n">object</code><code class="p">)</code> <code class="o">-&gt;</code>
  # <code class="n">code</code> <code class="n">that</code> <code class="n">hydrates</code> <code class="n">the</code> <code class="n">object</code> <code class="n">from</code> <code class="n">storage</code>
</pre></div>

</div>

<p><strong>composing methods</strong></p>

<p>On an ad hoc basis, decomposing methods is fine. But there is a subtle problem. Implementation tricks like hydrating objects, memoizing return values, or other performance tweaks are orthogonal to the mechanics of what methods like <code>roar</code> or <code>run</code> are supposed to do. So why is <code>hydrate(this)</code> in every method?</p>

<p>Now the obvious answer is, &ldquo;Ok, it might be orthogonal to the main business of each method, but it&rsquo;s just one line.&rdquo; The trouble with this answer is that method decomposition doesn&rsquo;t scale. We need a line for hydration, a line or two for logging, a few lines for error handling, another for wrapping certain things in a transaction&hellip;</p>

<p>Even when each orthogonal concern is boiled down to just one line, you can end up having the orthogonal concerns take up more space than the main business. And that makes the code hard to read in practice. You don&rsquo;t believe me? take a look at just about every programming tutorial ever written. They almost always say &ldquo;Hand waving over error handling and this and that&rdquo; in their code examples, because they want to make the main business of the code clearer and easier to read.</p>

<p>We ought to do the same thing, move hydration, error handling, logging, transactions, and anything else orthogonal to the main business of a method out of the method. And we can.</p>

<p><strong>method combinations</strong></p>

<p>Here&rsquo;s our code again, this time using the  <a href="https://github.com/raganwald/YouAreDaChef">YouAreDaChef</a> library to provide <em>before combinations</em>:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">YouAreDaChef</code> <code class="p">=</code> <code class="n">require</code><code class="p">(</code><code class="s">&#39;YouAreDaChef.coffee&#39;</code><code class="p">).</code><code class="n">YouAreDaChef</code>

<code class="n">class</code> <code class="n">Wumpus</code>
  <code class="n">roar</code><code class="p">:</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
  <code class="n">run</code><code class="p">:</code> <code class="o">-&gt;</code>
    #<code class="p">...</code>

<code class="n">class</code> <code class="n">Hunter</code>
  <code class="n">draw</code><code class="p">:</code> <code class="p">(</code><code class="n">bow</code><code class="p">)</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
  <code class="n">run</code><code class="p">:</code> <code class="o">-&gt;</code>
    #<code class="p">...</code>

<code class="n">hydrate</code> <code class="p">=</code> <code class="p">(</code><code class="n">object</code><code class="p">)</code> <code class="o">-&gt;</code>
  # <code class="n">code</code> <code class="n">that</code> <code class="n">hydrates</code> <code class="n">the</code> <code class="n">object</code> <code class="n">from</code> <code class="n">storage</code>

<code class="n">YouAreDaChef</code><code class="p">(</code><code class="n">Wumpus</code><code class="p">,</code> <code class="n">Hunter</code><code class="p">)</code>
  <code class="p">.</code><code class="n">before</code> <code class="s">&#39;roar&#39;</code><code class="p">,</code> <code class="s">&#39;draw&#39;</code><code class="p">,</code> <code class="s">&#39;run&#39;</code><code class="p">,</code> <code class="p">()</code> <code class="o">-&gt;</code>
    <code class="n">hydrate</code><code class="p">(</code><code class="n">this</code><code class="p">)</code>
</pre></div>

</div>

<p>Whenever the <code>roar</code>, <code>draw</code>, or <code>run</code> methods are called, YouAreDaChef calls <code>hydrate(this)</code> first.  And  the two concerns&ndash;How a Wumpus works and when it ought to be hydrated&ndash;are totally separated. This isn&rsquo;t a new idea, it&rsquo;s called <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming">aspect-oriented programming</a>, and practitioners will describe what we&rsquo;re doing in terms of method advice and point cuts.</p>

<p>Ruby on Rails programmers are familiar with this idea. If you have ever written any of the following, you were using Rails&rsquo; built-in aspect-oriented programming support:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">after_save</code>
<code class="n">validates_each</code>
<code class="n">alias_method_chain</code>
<code class="n">before_filter</code>
</pre></div>

</div>

<p>These and other features of Rails implement method advice, albeit in a very specific way tuned to portions of the Rails framework. </p>

<p><strong>the unwritten rule</strong></p>

<blockquote>
  <p>There is an unwritten rule that says every Ruby programmer must, at some point, write his or her own AOP implementation &ndash;Avdi Grimm</p>
</blockquote>

<p>Let&rsquo;s look at how YouAreTheChef works. Here&rsquo;s a simplified version of the code for the <code>before</code> combination:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">YouAreDaChef</code><code class="p">:</code> <code class="p">(</code><code class="n">clazzes</code><code class="p">...)</code> <code class="o">-&gt;</code>
    <code class="n">before</code><code class="p">:</code> <code class="p">(</code><code class="n">method_names</code><code class="p">...,</code> <code class="n">advice</code><code class="p">)</code> <code class="o">-&gt;</code>
      <code class="n">_</code><code class="p">.</code><code class="n">each</code> <code class="n">method_names</code><code class="p">,</code> <code class="p">(</code><code class="n">name</code><code class="p">)</code> <code class="o">-&gt;</code>
        <code class="n">_</code><code class="p">.</code><code class="n">each</code> <code class="n">clazzes</code><code class="p">,</code> <code class="p">(</code><code class="n">clazz</code><code class="p">)</code> <code class="o">-&gt;</code>
          <code class="k">if</code> <code class="n">_</code><code class="p">.</code><code class="n">isFunction</code><code class="p">(</code><code class="n">clazz</code><code class="p">.</code><code class="n">prototype</code><code class="p">[</code><code class="n">name</code><code class="p">])</code>
            <code class="n">pointcut</code> <code class="p">=</code> <code class="n">clazz</code><code class="p">.</code><code class="n">prototype</code><code class="p">[</code><code class="n">name</code><code class="p">]</code>
            <code class="n">clazz</code><code class="p">.</code><code class="n">prototype</code><code class="p">[</code><code class="n">name</code><code class="p">]</code> <code class="p">=</code> <code class="p">(</code><code class="n">args</code><code class="p">...)</code> <code class="o">-&gt;</code>
              <code class="n">advice</code><code class="p">.</code><code class="n">apply</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">args</code><code class="p">)</code>
              <code class="n">pointcut</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">this</code><code class="p">,</code> <code class="n">args</code><code class="p">)</code>
</pre></div>

</div>

<p>This is really simple, we are composing a method with a function. The method already defined in the class is called the <em>pointcut</em>, and the function we are supplying is called the <em>advice</em>. Unlike a purely functional combinator, we are only executing the advice for side-effects, not for its result. But in object-oriented imperative programming, that&rsquo;s usually what we want.</p>

<p><strong>other method combinations</strong></p>

<p>That looks handy. But we also want an <em>after method</em>, a way to compose methods in the other order. Good news, the after combination is exactly what we want. After combinations are very handy for things like logging method calls or cleaning things up.</p>

<p>But there&rsquo;s another great use for after combinators, triggering events. Event triggering code is often very decoupled from method logic: The whole point of events is to invert control so that an object like a <code>Wumpus</code> doesn&rsquo;t need to know which objects want to do something after it moves. For example,  a Backbone.js view might be observing the Wumpus and wish to update itself when the Wumpus moves:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">YouAreDaChef</code><code class="p">(</code><code class="n">Wumpus</code><code class="p">,</code> <code class="n">Hunter</code><code class="p">)</code>
  <code class="p">.</code><code class="n">after</code> <code class="s">&#39;run&#39;</code><code class="p">,</code> <code class="p">()</code> <code class="o">-&gt;</code>
    <code class="n">this</code><code class="p">.</code><code class="n">trigger</code> <code class="s">&#39;move&#39;</code><code class="p">,</code> <code class="n">this</code>

<code class="n">CaveView</code> <code class="p">=</code> <code class="n">Backbone</code><code class="p">.</code><code class="n">View</code><code class="p">.</code><code class="n">extend</code>
  <code class="n">initialize</code><code class="p">:</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
    <code class="p">@</code><code class="n">model</code><code class="p">.</code><code class="n">bind</code> <code class="s">&#39;move&#39;</code><code class="p">,</code> <code class="p">@</code><code class="n">wumpusMoved</code>
  <code class="n">wumpusMoved</code><code class="p">:</code> <code class="p">(</code><code class="n">wumpus</code><code class="p">)</code> <code class="o">-&gt;</code>
    # <code class="p">...</code>
</pre></div>

</div>

<p>The code coupling the view to the model has now been separated from the code defining the model itself.</p>

<p>YouAreDaChef also provides other mechanisms for separating concerns. <em>Around combinations</em> (also called around advice) are a very general-purpose combinator. With an around combination, the original method (the pointcut) is passed to the advice function as a parameter, allowing it to be called at any time.</p>

<p>Around advice is useful for wrapping methods. Using an around combinator, you could bake error handling and transactions into methods without encumbering their code with implementation details. In this example, we define the methods to be matched using a regular expression, and YouAreDaChef passes the result of the match to the advice function, which wraps them in a transaction and adds some logging:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">class</code> <code class="n">EnterpriseyLegume</code>
  <code class="n">setId</code><code class="p">:</code>         <code class="p">(@</code><code class="n">id</code><code class="p">)</code>         <code class="o">-&gt;</code>
  <code class="n">setName</code><code class="p">:</code>       <code class="p">(@</code><code class="n">name</code><code class="p">)</code>       <code class="o">-&gt;</code>
  <code class="n">setDepartment</code><code class="p">:</code> <code class="p">(@</code><code class="n">department</code><code class="p">)</code> <code class="o">-&gt;</code>
  <code class="n">setCostCentre</code><code class="p">:</code> <code class="p">(@</code><code class="n">costCentre</code><code class="p">)</code> <code class="o">-&gt;</code>

<code class="n">YouAreDaChef</code><code class="p">(</code><code class="n">EnterpriseyLegume</code><code class="p">)</code>
  <code class="p">.</code><code class="n">around</code> <code class="o">/</code><code class="n">set</code><code class="p">(</code><code class="o">.*</code><code class="p">)</code><code class="o">/</code><code class="p">,</code> <code class="p">(</code><code class="n">pointcut</code><code class="p">,</code> <code class="n">match</code><code class="p">,</code> <code class="n">value</code><code class="p">)</code> <code class="o">-&gt;</code>
    <code class="n">performTransaction</code> <code class="p">()</code> <code class="o">-&gt;</code>
      <code class="n">writeToLog</code> &quot;#<code class="p">{</code><code class="n">match</code><code class="p">[</code>1<code class="p">]}:</code> #<code class="p">{</code><code class="n">value</code><code class="p">}</code>&quot;
      <code class="n">pointcut</code><code class="p">(</code><code class="n">value</code><code class="p">)</code>
</pre></div>

</div>

<p><strong>summary</strong></p>

<p>Method combinations are a technique for separating concerns when the level of granularity is smaller than a method. This makes the code DRY and removes the clutter of orthogonal responsibilities.</p>

<h2 section-num="12" id="appendix-finding-joy-in-combinators">Appendix: Finding Joy in Combinators</h2>

<p>In this book, we have looked at a few interesting combinators and some Ruby code inspired by them. Today we&rsquo;ll review the definition of a combinator, and from there we&rsquo;ll learn something intriguing about an entire family of programming languages, the <a href="http://en.wikipedia.org/wiki/Concatenative_programming_language" title="Concatenative programming language - Wikipedia, the free encyclopedia">Concatenative Languages</a>.</p>

<p>Let&rsquo;s start at the beginning: What is a combinator? </p>

<p>One definition of a combinator is <em>a function with no free variables</em>. Another way to put it is that a combinator is a function that takes one or more arguments and produces a result without introducing anything new. In Ruby terms, we are talking about blocks, lambdas or methods that do not call anything except what has been passed in.</p>

<p>So if I tell you that:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">finch</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">a</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">b</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">c</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">c</code><code class="p">.</code><code class="n">call</code><code class="p">(</code><code class="n">b</code><code class="p">).</code><code class="n">call</code><code class="p">(</code><code class="n">a</code><code class="p">)</code>
</pre></div>

</div>

<p>Then you know that <code>finch</code> is a combinator because the effect it produces is made up solely of combining the effects of the things it takes as parameters. That&rsquo;s easy, but yet&hellip; Where is our vaunted simplicity? Working with Ruby&rsquo;s lambdas and braces and calls gets in our way. We can learn a lot from combinatorial logic to help our Ruby programming, but Ruby is a terrible language for actually learning about combinatorial logic.</p>

<h3 section-num="12.1" id="languages-for-combinatorial-logic">Languages for combinatorial logic</h3>

<p>Combinatorial logicians use a much simpler, direct syntax for writing expressions:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Fabc</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">cba</code>
</pre></div>

</div>

<p>Whenever a logician writes <code>abc</code>, he means the same thing as when a Rubyist writes <code>a.call(b).call(c)</code>. Note that like Ruby, the precedence in combinatorial logic is to the left, so <code>abc</code> is equivalent to <code>(ab)c</code> just as in Ruby <code>a.call(b).call(c)</code> is equivalent to <code>(a.call(b)).call(c)</code>.</p>

<p>I think you&rsquo;ll agree that <code>abc</code> is much simpler than <code>a.call(b).call(c)</code>. Here&rsquo;s another look at the combinators we&rsquo;ve met in this series, using the simpler syntax:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Kxy</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">x</code>
<code class="n">Txy</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">yx</code>
<code class="n">Cxyz</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">xzy</code>
<code class="n">Q3xyz</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">z</code><code class="p">(</code><code class="n">xy</code><code class="p">)</code> # <code class="n">Q3</code> <code class="n">is</code> <code class="n">shorthand</code> <code class="k">for</code> <code class="n">the</code> <code class="n">Quirky</code> <code class="n">bird</code>
<code class="n">Bxyz</code> <code class="p">=</code> <code class="n">x</code><code class="p">(</code><code class="n">yz</code><code class="p">)</code>
<code class="n">Qxyz</code> <code class="p">=</code> <code class="n">y</code><code class="p">(</code><code class="n">xz</code><code class="p">)</code> # <code class="n">Q</code> <code class="n">is</code> <code class="n">shorthand</code> <code class="k">for</code> <code class="n">the</code> <code class="n">Queer</code> <code class="n">bird</code>
</pre></div>

</div>

<p>There are many, many more combinators, of course. Infinitely more, in fact. We only have names for some of the most useful. For example, the Warbler Twice Removed, or <code>W**</code> is written:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">W</code><code class="o">**</code><code class="n">xyzw</code> <code class="p">=</code><code class="o">&gt;</code> <code class="n">xyzww</code>
</pre></div>

</div>

<p>(Warblers are actually in a whole &lsquo;nother family of birds that introduce <em>duplication</em>. Other members of that family include the Mockingbird and Starling. They&rsquo;re incredibly useful for introducing ideas like iteration and recursion.)</p>

<p>You could say that combinators take a string of symbols (like x, y, z, w, and so forth), then they introduce some erasing, some duplication, some permutation, and add some parentheses. That they work to rearrange our string of symbols.</p>

<p>We have seen that parentheses are allowed, and that some combinators introduce parentheses. Before you say that the combinators introduce new symbols, remember that parentheses are <em>punctuation</em>. If you think of the symbols as words and the parentheses as punctuation, you see that the combinators simply rearrange the words and change the punctuation without introducing new words.</p>

<p>Now I said that combinators work with strings of symbols. This was a terrible analogy, because it made us talk about punctuation and why parentheses are not symbols. Another thing you could say is that combinator work with <em>lists</em> of symbols, then they re-arrange the symbols, including removing symbols, introducing sub-lists, and duplicating symbols.</p>

<p>This is more interesting! Now we can see that in our notation, adding parentheses is a way of introducing a sub list. Let&rsquo;s revisit the bluebird:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">Bxyz</code> <code class="p">=</code> <code class="n">x</code><code class="p">(</code><code class="n">yz</code><code class="p">)</code>
</pre></div>

</div>

<p>Now what we can say is this: The bluebird takes a list of three symbols and answers a list of one symbol and a sublist of two symbols. In Ruby:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">bluebird</code> <code class="p">=</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|*</code><code class="n">args</code><code class="o">|</code>
  <code class="n">x</code><code class="p">,</code> <code class="n">y</code><code class="p">,</code> <code class="n">z</code> <code class="p">=</code> <code class="n">args</code>
  <code class="p">[</code><code class="n">x</code><code class="p">,</code> <code class="p">[</code><code class="n">y</code><code class="p">,</code> <code class="n">z</code><code class="p">]]</code>
<code class="p">}</code>

<code class="n">bluebird</code><code class="p">.</code><code class="n">call</code><code class="p">(:</code><code class="n">x</code><code class="p">,</code> <code class="p">:</code><code class="n">y</code><code class="p">,</code> <code class="p">:</code><code class="n">z</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">[:</code><code class="n">x</code><code class="p">,</code> <code class="p">[:</code><code class="n">y</code><code class="p">,</code> <code class="p">:</code><code class="n">z</code><code class="p">]]</code>
</pre></div>

</div>

<p>This is easy. What about the Thrush?</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">thrush</code> <code class="p">=</code> <code class="n">lambda</code> <code class="p">{</code> <code class="o">|*</code><code class="n">args</code><code class="o">|</code>
  <code class="n">x</code><code class="p">,</code> <code class="n">y</code> <code class="p">=</code> <code class="n">args</code>
  <code class="p">[</code><code class="n">y</code><code class="p">,</code> <code class="n">x</code><code class="p">]</code>
<code class="p">}</code>

<code class="n">thrush</code><code class="p">.</code><code class="n">call</code><code class="p">(:</code><code class="n">x</code><code class="p">,</code> <code class="p">:</code><code class="n">y</code><code class="p">)</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">[:</code><code class="n">y</code><code class="p">,</code> <code class="p">:</code><code class="n">x</code><code class="p">]</code>
</pre></div>

</div>

<p>Now let&rsquo;s pause for a moment. Imagine we had an entire programming language devoted to this style of programming. The primary thing it does is define combinators that take a list of symbols and recombine them. Since it works with lists and we are thinking about combinatory logic, we will represent our expressions as lists:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">idiot</code> <code class="o">:</code><code class="n">x</code>
  <code class="o">=&gt;</code> <code class="o">:</code><code class="n">x</code>

<code class="n">mockingbird</code> <code class="o">:</code><code class="n">x</code>
  <code class="o">=&gt;</code> <code class="o">:</code><code class="n">x</code> <code class="o">:</code><code class="n">x</code>

<code class="n">bluebird</code> <code class="o">:</code><code class="n">x</code> <code class="o">:</code><code class="n">y</code> <code class="o">:</code><code class="n">z</code>
  <code class="o">=&gt;</code> <code class="o">:</code><code class="n">x</code> <code class="o">[:</code><code class="n">y</code> <code class="o">:</code><code class="n">z</code><code class="o">]</code>

<code class="n">thrush</code> <code class="o">:</code><code class="n">x</code> <code class="o">:</code><code class="n">y</code>
  <code class="o">=&gt;</code> <code class="o">:</code><code class="n">y</code> <code class="o">:</code><code class="n">x</code>
</pre></div>

</div>

<p>Wait! Do not shout Lisp! Just because we have lists of things does not mean we are programming in Lisp!! Let&rsquo;s keep going, and you will see in the next example that I do not mean Lisp:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">bluebird</code> <code class="n">thrush</code> <code class="p">:</code><code class="n">x</code> <code class="p">:</code><code class="n">y</code> <code class="p">:</code><code class="n">z</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="n">thrush</code> <code class="p">[:</code><code class="n">x</code> <code class="p">:</code><code class="n">y</code><code class="p">]</code> <code class="p">:</code><code class="n">z</code>
  <code class="p">=</code><code class="o">&gt;</code> <code class="p">:</code><code class="n">z</code> <code class="p">[:</code><code class="n">x</code> <code class="p">:</code><code class="n">y</code><code class="p">]</code>
</pre></div>

</div>

<p>And therefore in our fictitious language we can write:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">quirky</code> <code class="p">=</code> <code class="n">bluebird</code> <code class="n">thrush</code>
</pre></div>

</div>

<p>And thus:</p>

<div class="code-block">
<div class="highlight"><pre><code class="n">quirky</code> <code class="o">:</code><code class="n">x</code> <code class="o">:</code><code class="n">y</code> <code class="o">:</code><code class="n">z</code>
  <code class="o">=&gt;</code> <code class="o">:</code><code class="n">z</code> <code class="o">[:</code><code class="n">x</code> <code class="o">:</code><code class="n">y</code><code class="o">]</code>
</pre></div>

</div>

<p>This looks familiar. Have you ever written a program in <a href="http://en.wikipedia.org/wiki/PostScript" title="PostScript - Wikipedia, the free encyclopedia">Postscript</a>? Or [Forth](http://en.wikipedia.org/wiki/Forth_(programming_language)? What if instead of using a thrush we used a word called <code>swap</code>? Or instead of a mockingbird we used a word called <code>dup</code>?</p>

<h3 section-num="12.2" id="concatenative-languages">Concatenative languages</h3>

<p>Concatenative (or stack-based) programming languages&ndash;like Postscript, Forth, <a href="http://www.factorcode.org/" title="Factor programming language">Factor</a>, and <a href="http://www.latrobe.edu.au/philosophy/phimvt/joy/j00ovr.htmll">Joy</a>&ndash;are almost direct representations of combinatorial logic. There is a list of things, words or combinators permute the list of things, and the things can be anything: data, other combinators, or even programs. These languages are called concatenative languages because the primary way to compose programs and combinators with each other is to concatenate them together, like we did with the bluebird and thrush above.</p>

<blockquote>
  <p>For me the purpose of life is partly to have joy. Programmers often feel joy when they can concentrate on the creative side of programming, So Ruby is designed to make programmers happy.
&ndash;Yukihiro Matsumoto</p>
</blockquote>

<p>You have probably heard that it is a good idea to learn a new programming language every year. Is a concatenative language on your list of languages to learn? No? Well, here is the reason to learn a concatenative language: <em>You will learn to think using combinatorial logic</em>. For example, the Y Combinator is expressed in Joy as:</p>

<div class="code-block">
<div class="highlight"><pre><code class="p">[</code><code class="n">dup</code> <code class="n">cons</code><code class="p">]</code> <code class="n">swap</code> <code class="n">concat</code> <code class="n">dup</code> <code class="n">cons</code> <code class="nb">i</code>
</pre></div>

</div>

<p>Where <code>dup</code> is a mockingbird, <code>swap</code> is a thrush, <code>i</code> is an idiot bird, and <code>cons</code> and <code>concat</code> are likewise two other combinators. Writing in Joy is writing directly in combinators.</p>

<p>In other programming languages, combinatorial logic is an underpinning. It helps us explain and prove certain things, It inspires us to invent certain things. It is behind everything we do. That&rsquo;s good. But in a concatenative language, it is not an underpinning or behind a curtain. It is right out there in front of you. And learning to program in a concatenative language means learning to think in combinators.</p>

<p>The combinators we&rsquo;ve discussed in depth so far are all fascinating, however as a basis for writing programs they are incomplete. You cannot represent every possible program using kestrels, thrushes, cardinals, quirky birds, bluebirds, and queer birds. To represent all possible programs, we need to have at least one combinator that duplicates symbols, like a mockingbird or another from its family.</p>

<h2 section-num="13" id="appendix-source-code">Appendix: Source Code</h2>

<p>All source code is published under the following license:</p>

<div class="code-block">
<div class="highlight"><pre><code class="c"># The MIT License</code>
<code class="c"># </code>
<code class="c"># All contents Copyright (c) 2004-2008 Reginald Braithwaite</code>
<code class="c"># &lt;http://braythwayt.com&gt;  except as otherwise noted.</code>
<code class="c"># </code>
<code class="c"># Permission is hereby granted, free of charge, to any person obtaining a c\</code>
<code class="n">opy</code>
<code class="c"># of this software and associated documentation files (the &quot;Software&quot;), to \</code>
<code class="nb">deal</code>
<code class="c"># in the Software without restriction, including without limitation the rig\</code>
<code class="n">hts</code>
<code class="c"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</code>
<code class="c"># copies of the Software, and to permit persons to whom the Software is</code>
<code class="c"># furnished to do so, subject to the following conditions:</code>
<code class="c"># </code>
<code class="c"># The above copyright notice and this permission notice shall be included i\</code>
<code class="n">n</code>
<code class="c"># all copies or substantial portions of the Software.</code>
<code class="c"># </code>
<code class="c"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS O\</code>
<code class="n">R</code>
<code class="c"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</code>
<code class="c"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL T\</code>
<code class="n">HE</code>
<code class="c"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</code>
<code class="c"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING F\</code>
<code class="n">ROM</code><code class="p">,</code>
<code class="c"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</code>
<code class="c"># THE SOFTWARE.</code>
<code class="c"># </code>
<code class="c"># http://www.opensource.org/licenses/mit-license.php</code>
</pre></div>

</div>

<h3 section-num="13.1" id="kestrels-1">kestrels</h3>

<div class="code-block">
  <p class="codeblock-title">returning.rb</p>

  <hr />
<div class="highlight"><pre><code class="c1"># The MIT License</code>
<code class="c1"># </code>
<code class="c1"># All contents Copyright (c) 2004-2008 Reginald Braithwaite</code>
<code class="c1"># &lt;http://braythwayt.com&gt;  except as otherwise noted.</code>
<code class="c1"># </code>
<code class="c1"># Permission is hereby granted, free of charge, to any person obtaining a c\</code>
<code class="n">opy</code>
<code class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to \</code>
<code class="n">deal</code>
<code class="c1"># in the Software without restriction, including without limitation the rig\</code>
<code class="n">hts</code>
<code class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</code>
<code class="c1"># copies of the Software, and to permit persons to whom the Software is</code>
<code class="c1"># furnished to do so, subject to the following conditions:</code>
<code class="c1"># </code>
<code class="c1"># The above copyright notice and this permission notice shall be included i\</code>
<code class="n">n</code>
<code class="c1"># all copies or substantial portions of the Software.</code>
<code class="c1"># </code>
<code class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS O\</code>
<code class="n">R</code>
<code class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</code>
<code class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL T\</code>
<code class="no">HE</code>
<code class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</code>
<code class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING F\</code>
<code class="no">ROM</code><code class="p">,</code>
<code class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</code>
<code class="c1"># THE SOFTWARE.</code>
<code class="c1"># </code>
<code class="c1"># http://www.opensource.org/licenses/mit-license.php</code>

<code class="k">unless</code> <code class="nb">respond_to?</code><code class="p">(</code><code class="ss">:returning</code><code class="p">)</code>
  <code class="k">def</code> <code class="nf">returning</code><code class="p">(</code><code class="n">it</code><code class="p">)</code>
    <code class="k">yield</code> <code class="n">it</code>
    <code class="n">it</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

  <hr />
</div>

<h3 section-num="13.2" id="thrushes">thrushes</h3>

<div class="code-block">
  <p class="codeblock-title">into.rb</p>

  <hr />
<div class="highlight"><pre><code class="k">class</code> <code class="nc">Object</code>
  <code class="k">def</code> <code class="nf">into</code> <code class="n">expr</code> <code class="o">=</code> <code class="kp">nil</code>
    <code class="n">expr</code><code class="o">.</code><code class="n">nil?</code> <code class="p">?</code> <code class="k">yield</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code> <code class="p">:</code> <code class="n">expr</code><code class="o">.</code><code class="n">to_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

  <hr />
</div>
<div class="code-block">
  <p class="codeblock-title">let.rb</p>

  <hr />
<div class="highlight"><pre><code class="k">class</code> <code class="nc">Kernel</code>
  <code class="k">def</code> <code class="nf">let</code> <code class="n">it</code>
    <code class="k">yield</code> <code class="n">it</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

  <hr />
</div>

<h3 section-num="13.3" id="the-cardinal">the cardinal</h3>

<div class="code-block">
  <p class="codeblock-title">cardinal.rb</p>

  <hr />
<div class="highlight"><pre><code class="k">def</code> <code class="nf">cardinal_define</code><code class="p">(</code><code class="nb">name</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">proc_over_proc</code><code class="p">)</code>
  <code class="n">define_method_taking_block</code><code class="p">(</code><code class="nb">name</code><code class="p">)</code> <code class="k">do</code> <code class="o">|</code><code class="n">a_value</code><code class="p">,</code> <code class="n">a_proc</code><code class="o">|</code>
    <code class="n">proc_over_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_proc</code><code class="p">)</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="c1"># method_body_proc should expect (a_value, a_proc)</code>
<code class="c1"># see http://coderrr.wordpress.com/2008/10/29/using-define_method-with-bloc\</code>
<code class="n">ks</code><code class="o">-</code><code class="k">in</code><code class="o">-</code><code class="n">ruby</code><code class="o">-</code><code class="mi">18</code><code class="o">/</code>
<code class="k">def</code> <code class="nf">define_method_taking_block</code><code class="p">(</code><code class="nb">name</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">method_body_proc</code><code class="p">)</code>
  <code class="nb">self</code><code class="o">.</code><code class="n">class</code><code class="o">.</code><code class="n">send</code> <code class="ss">:define_method</code><code class="p">,</code> <code class="s2">&quot;__cardinal_helper_</code><code class="si">#{</code><code class="nb">name</code><code class="si">}</code><code class="s2">__&quot;</code><code class="p">,</code> <code class="n">method_bod</code><code class="p">\</code>
<code class="n">y_proc</code>
  <code class="nb">eval</code> <code class="o">&lt;&lt;-</code><code class="no">EOM</code>
<code class="sh">    def #{name}(a_value, &amp;a_proc)</code>
<code class="sh">      __cardinal_helper_#{name}__(a_value, a_proc)</code>
<code class="sh">    end</code>
<code class="no">  EOM</code>
<code class="k">end</code>
</pre></div>

  <hr />
</div>

<h3 section-num="13.4" id="quirky-birds">quirky birds</h3>

<div class="code-block">
  <p class="codeblock-title">andand.rb</p>

  <hr />
<div class="highlight"><pre><code class="k">module</code> <code class="nn">AndAnd</code>

  <code class="c1"># This module is included in Object, so each of these methods are added</code>
  <code class="c1"># to Object when you require &#39;andand&#39;. Each method is an *adverb*: they a\</code>
<code class="n">re</code>
  <code class="c1"># intended to be enchained with another method, such as receiver.adverb.m\</code>
<code class="n">ethod</code>
  <code class="c1">#</code>
  <code class="c1"># The purpose of an adverb is to modify what the primary method returns.</code>
  <code class="c1">#</code>
  <code class="c1"># Adverbs also take blocks or procs, passing the receiver as an argument \</code>
<code class="n">to</code> <code class="n">the</code>
  <code class="c1"># block or proc. They retain the same semantics with a block or proc as t\</code>
<code class="n">hey</code>
  <code class="c1"># do with a method. This behaviour weakly resembles a monad.</code>
  <code class="k">module</code> <code class="nn">ObjectGoodies</code>

    <code class="c1"># Returns nil if its receiver is nil, regardless of whether nil actuall\</code>
<code class="n">y</code> <code class="n">handles</code> <code class="n">the</code>
    <code class="c1"># actual method ot what it might return.</code>
    <code class="c1">#</code>
    <code class="c1">#    &#39;foo&#39;.andand.size =&gt; 3</code>
    <code class="c1">#    nil.andand.size =&gt; nil</code>
    <code class="c1">#    &#39;foo&#39;.andand { |s| s &lt;&lt; &#39;bar&#39; } =&gt; &#39;foobar&#39;</code>
    <code class="c1">#    nil.andand { |s| s &lt;&lt; &#39;bar&#39; } =&gt; nil</code>
    <code class="k">def</code> <code class="nf">andand</code> <code class="p">(</code><code class="nb">p</code> <code class="o">=</code> <code class="kp">nil</code><code class="p">)</code>
      <code class="k">if</code> <code class="nb">self</code>
        <code class="k">if</code> <code class="nb">block_given?</code>
          <code class="k">yield</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code>
        <code class="k">elsif</code> <code class="nb">p</code>
          <code class="nb">p</code><code class="o">.</code><code class="n">to_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code>
        <code class="k">else</code>
          <code class="nb">self</code>
        <code class="k">end</code>
      <code class="k">else</code>
        <code class="k">if</code> <code class="nb">block_given?</code> <code class="ow">or</code> <code class="nb">p</code>
          <code class="nb">self</code>
        <code class="k">else</code>
          <code class="no">MockReturningMe</code><code class="o">.</code><code class="n">new</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code>
        <code class="k">end</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="c1"># Invokes the method and returns the receiver if nothing is raised. The\</code>
<code class="n">refore</code><code class="p">,</code>
    <code class="c1"># the purpose of calling the method is strictly for side effects. In th\</code>
<code class="n">e</code> <code class="n">block</code>
    <code class="c1"># form, it resembles #tap from Ruby 1.9, and is useful for debugging. I\</code>
<code class="n">t</code> <code class="n">also</code>
    <code class="c1"># resembles #returning from Rails, with slightly different syntax.</code>
    <code class="c1">#</code>
    <code class="c1">#    Object.new.me do |o|</code>
    <code class="c1">#      def o.foo</code>
    <code class="c1">#        &#39;foo&#39;</code>
    <code class="c1">#      end</code>
    <code class="c1">#    end</code>
    <code class="c1">#      =&gt; your new object</code>
    <code class="c1">#</code>
    <code class="c1"># In the method form, it is handy for chaining methods that don&#39;t ordin\</code>
<code class="n">arily</code>
    <code class="c1"># return the receiver:</code>
    <code class="c1">#</code>
    <code class="c1">#    [1, 2, 3, 4, 5].me.pop.reverse</code>
    <code class="c1">#      =&gt; [4, 3, 2, 1]</code>
    <code class="k">def</code> <code class="nf">me</code> <code class="p">(</code><code class="nb">p</code> <code class="o">=</code> <code class="kp">nil</code><code class="p">)</code>
      <code class="k">if</code> <code class="nb">block_given?</code>
        <code class="k">yield</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code>
        <code class="nb">self</code>
      <code class="k">elsif</code> <code class="nb">p</code>
        <code class="nb">p</code><code class="o">.</code><code class="n">to_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code>
        <code class="nb">self</code>
      <code class="k">else</code>
        <code class="no">ProxyReturningMe</code><code class="o">.</code><code class="n">new</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="k">unless</code> <code class="no">Object</code><code class="o">.</code><code class="n">instance_methods</code><code class="o">.</code><code class="n">include?</code><code class="p">(</code><code class="s1">&#39;tap&#39;</code><code class="p">)</code>
      <code class="k">alias</code> <code class="ss">:tap</code> <code class="ss">:me</code>
    <code class="k">end</code>

    <code class="c1"># Does not invoke the method or block and returns the receiver.</code>
    <code class="c1"># Useful for comemnting stuff out, especially if you are using #me for</code>
    <code class="c1"># debugging purposes: change the .me to .dont and the semantics of your</code>
    <code class="c1"># program are unchanged.</code>
    <code class="c1">#</code>
    <code class="c1">#    [1, 2, 3, 4, 5].me { |x| p x }</code>
    <code class="c1">#      =&gt; prints and returns the array</code>
    <code class="c1">#    [1, 2, 3, 4, 5].dont { |x| p x }</code>
    <code class="c1">#      =&gt; returns the array without printing it</code>
    <code class="k">def</code> <code class="nf">dont</code> <code class="p">(</code><code class="nb">p</code> <code class="o">=</code> <code class="kp">nil</code><code class="p">)</code>
      <code class="k">if</code> <code class="nb">block_given?</code>
        <code class="nb">self</code>
      <code class="k">elsif</code> <code class="nb">p</code>
        <code class="nb">self</code>
      <code class="k">else</code>
        <code class="no">MockReturningMe</code><code class="o">.</code><code class="n">new</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code>
      <code class="k">end</code>
    <code class="k">end</code>

  <code class="k">end</code>

<code class="k">end</code>

<code class="k">class</code> <code class="nc">Object</code>
  <code class="kp">include</code> <code class="no">AndAnd</code><code class="o">::</code><code class="no">ObjectGoodies</code>
<code class="k">end</code>

<code class="k">unless</code> <code class="no">Module</code><code class="o">.</code><code class="n">constants</code><code class="o">.</code><code class="n">include?</code><code class="p">(</code><code class="s1">&#39;BlankSlate&#39;</code><code class="p">)</code>
  <code class="k">if</code> <code class="no">Module</code><code class="o">.</code><code class="n">constants</code><code class="o">.</code><code class="n">include?</code><code class="p">(</code><code class="s1">&#39;BasicObject&#39;</code><code class="p">)</code>
    <code class="k">module</code> <code class="nn">AndAnd</code>
      <code class="k">class</code> <code class="nc">BlankSlate</code> <code class="o">&lt;</code> <code class="no">BasicObject</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="k">else</code>
    <code class="k">module</code> <code class="nn">AndAnd</code>
      <code class="k">class</code> <code class="nc">BlankSlate</code>
        <code class="k">def</code> <code class="nc">self</code><code class="o">.</code><code class="nf">wipe</code>
          <code class="nb">instance_methods</code><code class="o">.</code><code class="n">reject</code> <code class="p">{</code> <code class="o">|</code><code class="n">m</code><code class="o">|</code> <code class="n">m</code> <code class="o">=~</code> <code class="sr">/^__/</code> <code class="p">}</code><code class="o">.</code><code class="n">each</code> <code class="p">{</code> <code class="o">|</code><code class="n">m</code><code class="o">|</code> <code class="n">undef_metho</code><code class="p">\</code>
<code class="n">d</code> <code class="n">m</code> <code class="p">}</code>
        <code class="k">end</code>
        <code class="k">def</code> <code class="nf">initialize</code>
          <code class="no">BlankSlate</code><code class="o">.</code><code class="n">wipe</code>
        <code class="k">end</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="k">module</code> <code class="nn">AndAnd</code>

  <code class="c1"># A proxy that returns its target without invoking the method you</code>
  <code class="c1"># invoke. Useful for nil.andand and #dont</code>
  <code class="k">class</code> <code class="nc">MockReturningMe</code> <code class="o">&lt;</code> <code class="no">BlankSlate</code>
    <code class="k">def</code> <code class="nf">initialize</code><code class="p">(</code><code class="n">me</code><code class="p">)</code>
      <code class="k">super</code><code class="p">()</code>
      <code class="vi">@me</code> <code class="o">=</code> <code class="n">me</code>
    <code class="k">end</code>
    <code class="k">def</code> <code class="nf">method_missing</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">)</code>
      <code class="vi">@me</code>
    <code class="k">end</code>
  <code class="k">end</code>

  <code class="c1"># A proxy that returns its target after invoking the method you</code>
  <code class="c1"># invoke. Useful for #me</code>
  <code class="k">class</code> <code class="nc">ProxyReturningMe</code> <code class="o">&lt;</code> <code class="no">BlankSlate</code>
    <code class="k">def</code> <code class="nf">initialize</code><code class="p">(</code><code class="n">me</code><code class="p">)</code>
      <code class="k">super</code><code class="p">()</code>
      <code class="vi">@me</code> <code class="o">=</code> <code class="n">me</code>
    <code class="k">end</code>
    <code class="k">def</code> <code class="nf">method_missing</code><code class="p">(</code><code class="n">sym</code><code class="p">,</code> <code class="o">*</code><code class="n">args</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">block</code><code class="p">)</code>
      <code class="vi">@me</code><code class="o">.</code><code class="n">__send__</code><code class="p">(</code><code class="n">sym</code><code class="p">,</code> <code class="o">*</code><code class="n">args</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">block</code><code class="p">)</code>
      <code class="vi">@me</code>
    <code class="k">end</code>
  <code class="k">end</code>

<code class="k">end</code>
</pre></div>

  <hr />
</div>
<div class="code-block">
  <p class="codeblock-title">blank_slate.rb</p>

  <hr />
<div class="highlight"><pre><code class="c1"># The MIT License</code>
<code class="c1"># </code>
<code class="c1"># All contents Copyright (c) 2004-2008 Reginald Braithwaite</code>
<code class="c1"># &lt;http://braythwayt.com&gt;  except as otherwise noted.</code>
<code class="c1"># </code>
<code class="c1"># Permission is hereby granted, free of charge, to any person obtaining a c\</code>
<code class="n">opy</code>
<code class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to \</code>
<code class="n">deal</code>
<code class="c1"># in the Software without restriction, including without limitation the rig\</code>
<code class="n">hts</code>
<code class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</code>
<code class="c1"># copies of the Software, and to permit persons to whom the Software is</code>
<code class="c1"># furnished to do so, subject to the following conditions:</code>
<code class="c1"># </code>
<code class="c1"># The above copyright notice and this permission notice shall be included i\</code>
<code class="n">n</code>
<code class="c1"># all copies or substantial portions of the Software.</code>
<code class="c1"># </code>
<code class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS O\</code>
<code class="n">R</code>
<code class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</code>
<code class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL T\</code>
<code class="no">HE</code>
<code class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</code>
<code class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING F\</code>
<code class="no">ROM</code><code class="p">,</code>
<code class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</code>
<code class="c1"># THE SOFTWARE.</code>
<code class="c1"># </code>
<code class="c1"># http://www.opensource.org/licenses/mit-license.php</code>

<code class="k">unless</code> <code class="no">Module</code><code class="o">.</code><code class="n">constants</code><code class="o">.</code><code class="n">include?</code><code class="p">(</code><code class="s1">&#39;BlankSlate&#39;</code><code class="p">)</code>
  <code class="k">if</code> <code class="no">Module</code><code class="o">.</code><code class="n">constants</code><code class="o">.</code><code class="n">include?</code><code class="p">(</code><code class="s1">&#39;BasicObject&#39;</code><code class="p">)</code>
    <code class="k">class</code> <code class="nc">BlankSlate</code> <code class="o">&lt;</code> <code class="no">BasicObject</code>
    <code class="k">end</code>
  <code class="k">else</code>
    <code class="k">class</code> <code class="nc">BlankSlate</code>
      <code class="k">def</code> <code class="nc">self</code><code class="o">.</code><code class="nf">wipe</code>
        <code class="nb">instance_methods</code><code class="o">.</code><code class="n">reject</code> <code class="p">{</code> <code class="o">|</code><code class="n">m</code><code class="o">|</code> <code class="n">m</code> <code class="o">=~</code> <code class="sr">/^__/</code> <code class="p">}</code><code class="o">.</code><code class="n">each</code> <code class="p">{</code> <code class="o">|</code><code class="n">m</code><code class="o">|</code> <code class="n">undef_method</code> <code class="p">\</code>
<code class="n">m</code> <code class="p">}</code>
      <code class="k">end</code>
      <code class="k">def</code> <code class="nf">initialize</code>
        <code class="no">BlankSlate</code><code class="o">.</code><code class="n">wipe</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

  <hr />
</div>
<div class="code-block">
  <p class="codeblock-title">quirky_bird.rb</p>

  <hr />
<div class="highlight"><pre><code class="c1"># The MIT License</code>
<code class="c1"># </code>
<code class="c1"># All contents Copyright (c) 2004-2008 Reginald Braithwaite</code>
<code class="c1"># &lt;http://braythwayt.com&gt;  except as otherwise noted.</code>
<code class="c1"># </code>
<code class="c1"># Permission is hereby granted, free of charge, to any person obtaining a c\</code>
<code class="n">opy</code>
<code class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to \</code>
<code class="n">deal</code>
<code class="c1"># in the Software without restriction, including without limitation the rig\</code>
<code class="n">hts</code>
<code class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</code>
<code class="c1"># copies of the Software, and to permit persons to whom the Software is</code>
<code class="c1"># furnished to do so, subject to the following conditions:</code>
<code class="c1"># </code>
<code class="c1"># The above copyright notice and this permission notice shall be included i\</code>
<code class="n">n</code>
<code class="c1"># all copies or substantial portions of the Software.</code>
<code class="c1"># </code>
<code class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS O\</code>
<code class="n">R</code>
<code class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</code>
<code class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL T\</code>
<code class="no">HE</code>
<code class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</code>
<code class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING F\</code>
<code class="no">ROM</code><code class="p">,</code>
<code class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</code>
<code class="c1"># THE SOFTWARE.</code>
<code class="c1"># </code>
<code class="c1"># http://www.opensource.org/licenses/mit-license.php</code>

<code class="k">def</code> <code class="nf">quirky_bird_define</code><code class="p">(</code><code class="nb">name</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">value_proc</code><code class="p">)</code>
  <code class="n">define_method_taking_block</code><code class="p">(</code><code class="nb">name</code><code class="p">)</code> <code class="k">do</code> <code class="o">|</code><code class="n">a_value</code><code class="p">,</code> <code class="n">a_proc</code><code class="o">|</code>
    <code class="n">a_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">value_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">a_value</code><code class="p">))</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="c1"># method_body_proc should expect (a_value, a_proc)</code>
<code class="c1"># see http://coderrr.wordpress.com/2008/10/29/using-define_method-with-bloc\</code>
<code class="n">ks</code><code class="o">-</code><code class="k">in</code><code class="o">-</code><code class="n">ruby</code><code class="o">-</code><code class="mi">18</code><code class="o">/</code>
<code class="k">def</code> <code class="nf">define_method_taking_block</code><code class="p">(</code><code class="nb">name</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">method_body_proc</code><code class="p">)</code>
  <code class="nb">self</code><code class="o">.</code><code class="n">class</code><code class="o">.</code><code class="n">send</code> <code class="ss">:define_method</code><code class="p">,</code> <code class="s2">&quot;__quirky_bird_helper_</code><code class="si">#{</code><code class="nb">name</code><code class="si">}</code><code class="s2">__&quot;</code><code class="p">,</code> <code class="n">method_</code><code class="p">\</code>
<code class="n">body_proc</code>
  <code class="nb">eval</code> <code class="o">&lt;&lt;-</code><code class="no">EOM</code>
<code class="sh">    def #{name}(a_value, &amp;a_proc)</code>
<code class="sh">      __quirky_bird_helper_#{name}__(a_value, a_proc)</code>
<code class="sh">    end</code>
<code class="no">  EOM</code>
<code class="k">end</code>

<code class="k">def</code> <code class="nf">quirky_bird_extend</code><code class="p">(</code><code class="nb">name</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">value_proc</code><code class="p">)</code>
  <code class="no">Object</code><code class="o">.</code><code class="n">send</code><code class="p">(</code><code class="ss">:define_method</code><code class="p">,</code> <code class="nb">name</code><code class="p">)</code> <code class="k">do</code>
    <code class="n">value_proc</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

  <hr />
</div>
<div class="code-block">
  <p class="codeblock-title">quirky_songs.rb</p>

  <hr />
<div class="highlight"><pre><code class="c1"># The MIT License</code>
<code class="c1"># </code>
<code class="c1"># All contents Copyright (c) 2004-2008 Reginald Braithwaite</code>
<code class="c1"># &lt;http://braythwayt.com&gt;  except as otherwise noted.</code>
<code class="c1"># </code>
<code class="c1"># Permission is hereby granted, free of charge, to any person obtaining a c\</code>
<code class="n">opy</code>
<code class="c1"># of this software and associated documentation files (the &quot;Software&quot;), to \</code>
<code class="n">deal</code>
<code class="c1"># in the Software without restriction, including without limitation the rig\</code>
<code class="n">hts</code>
<code class="c1"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</code>
<code class="c1"># copies of the Software, and to permit persons to whom the Software is</code>
<code class="c1"># furnished to do so, subject to the following conditions:</code>
<code class="c1"># </code>
<code class="c1"># The above copyright notice and this permission notice shall be included i\</code>
<code class="n">n</code>
<code class="c1"># all copies or substantial portions of the Software.</code>
<code class="c1"># </code>
<code class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS O\</code>
<code class="n">R</code>
<code class="c1"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</code>
<code class="c1"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL T\</code>
<code class="no">HE</code>
<code class="c1"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</code>
<code class="c1"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING F\</code>
<code class="no">ROM</code><code class="p">,</code>
<code class="c1"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</code>
<code class="c1"># THE SOFTWARE.</code>
<code class="c1"># </code>
<code class="c1"># http://www.opensource.org/licenses/mit-license.php</code>

<code class="nb">require</code> <code class="s1">&#39;quirky_bird&#39;</code>
<code class="nb">require</code> <code class="s1">&#39;blank_slate&#39;</code>
<code class="nb">require</code> <code class="s1">&#39;returning&#39;</code>

<code class="n">quirky_bird_extend</code><code class="p">(</code><code class="ss">:maybe</code><code class="p">)</code> <code class="k">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
  <code class="k">if</code> <code class="n">value</code><code class="o">.</code><code class="n">nil?</code>
    <code class="n">returning</code><code class="p">(</code><code class="no">BlankSlate</code><code class="o">.</code><code class="n">new</code><code class="p">)</code> <code class="k">do</code> <code class="o">|</code><code class="n">it</code><code class="o">|</code>
      <code class="k">def</code> <code class="nc">it</code><code class="o">.</code><code class="nf">method_missing</code><code class="p">(</code><code class="o">*</code><code class="n">args</code><code class="p">)</code>
        <code class="kp">nil</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="k">else</code>
    <code class="n">value</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">quirky_bird_extend</code><code class="p">(</code><code class="ss">:try</code><code class="p">)</code> <code class="k">do</code> <code class="o">|</code><code class="n">value</code><code class="o">|</code>
  <code class="n">returning</code><code class="p">(</code><code class="no">BlankSlate</code><code class="o">.</code><code class="n">new</code><code class="p">)</code> <code class="k">do</code> <code class="o">|</code><code class="n">it</code><code class="o">|</code>
    <code class="k">def</code> <code class="nc">it</code><code class="o">.</code><code class="nf">__value__</code><code class="o">=</code><code class="p">(</code><code class="n">arg</code><code class="p">)</code>
       <code class="vi">@value</code> <code class="o">=</code> <code class="n">arg</code>
    <code class="k">end</code>
    <code class="k">def</code> <code class="nc">it</code><code class="o">.</code><code class="nf">method_missing</code><code class="p">(</code><code class="nb">name</code><code class="p">,</code> <code class="o">*</code><code class="n">args</code><code class="p">)</code>
      <code class="k">if</code> <code class="vi">@value</code><code class="o">.</code><code class="n">respond_to?</code><code class="p">(</code><code class="nb">name</code><code class="p">)</code>
        <code class="vi">@value</code><code class="o">.</code><code class="n">send</code><code class="p">(</code><code class="nb">name</code><code class="p">,</code> <code class="o">*</code><code class="n">args</code><code class="p">)</code>
      <code class="k">end</code>
    <code class="k">end</code>
    <code class="n">it</code><code class="o">.</code><code class="n">__value__</code> <code class="o">=</code> <code class="n">value</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre></div>

  <hr />
</div>

<h3 section-num="13.5" id="bluebirds">bluebirds</h3>

<div class="code-block">
  <p class="codeblock-title">before_and_after_advice.rb</p>

  <hr />
<div class="highlight"><pre><code class="c1"># This code contains ideas snarfed from:</code>
<code class="c1">#</code>
<code class="c1">#   http://github.com/up_the_irons/immutable/tree/master</code>
<code class="c1">#   http://blog.jayfields.com/2006/12/ruby-alias-method-alternative.html</code>
<code class="c1">#   http://eigenclass.org/hiki.rb?bounded+space+instance_exec</code>
<code class="c1">#</code>
<code class="c1"># And a heaping side of http://blog.grayproductions.net/articles/all_about_\</code>
<code class="n">struct</code>

<code class="k">module</code> <code class="nn">BeforeAndAfterAdvice</code>

  <code class="c1"># Random ID changed at each interpreter load</code>
  <code class="no">UNIQ</code> <code class="o">=</code> <code class="s2">&quot;_</code><code class="si">#{</code><code class="nb">object_id</code><code class="si">}</code><code class="s2">&quot;</code>

  <code class="no">Compositions</code> <code class="o">=</code> <code class="no">Struct</code><code class="o">.</code><code class="n">new</code><code class="p">(</code><code class="ss">:before</code><code class="p">,</code> <code class="ss">:between</code><code class="p">,</code> <code class="ss">:after</code><code class="p">)</code>

  <code class="k">module</code> <code class="nn">MethodAdvice</code><code class="p">;</code> <code class="k">end</code>

  <code class="k">module</code> <code class="nn">ClassMethods</code>

    <code class="c1"># Example:</code>
    <code class="c1">#</code>
    <code class="c1">#   before :foo, :bar do</code>
    <code class="c1">#     # ...</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1"># This executes the body of the block before the #foo and #bar instance\</code>
 <code class="nb">methods</code>
    <code class="c1"># for side effects without modifying the parameters (if any) passed to \</code>
<code class="c1">#foo</code>
    <code class="c1"># and #bar</code>
    <code class="c1">#</code>
    <code class="c1">#   before :fizz, :buzz do |p1, p2|</code>
    <code class="c1">#     # ...</code>
    <code class="c1">#     [p1, p2]</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1"># This executes the body of the block before the #foo and #bar instance\</code>
 <code class="nb">methods</code>
    <code class="c1"># for side efects, AND determines what is passed along as parameters. I\</code>
<code class="n">f</code> <code class="n">the</code> <code class="n">block</code>
    <code class="c1"># takes parameters, it acts as a filter, transforming the parameters.</code>
    <code class="c1">#</code>
    <code class="c1"># It is possible to chain #before advice, and you can add more advice i\</code>
<code class="n">n</code> <code class="n">subclasses</code><code class="p">:</code>
    <code class="c1">#</code>
    <code class="c1">#   class Foo</code>
    <code class="c1">#     def foo(bar); end</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1">#   class Bar &lt; Foo</code>
    <code class="c1">#     include MethodAdvice</code>
    <code class="c1">#</code>
    <code class="c1">#     before :foo do</code>
    <code class="c1">#       # ...</code>
    <code class="c1">#     end</code>
    <code class="c1">#</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1">#   class Blitz &lt; Bar</code>
    <code class="c1">#     include MethodAdvice</code>
    <code class="c1">#</code>
    <code class="c1">#     before :foo do |bar|</code>
    <code class="c1">#       # ...</code>
    <code class="c1">#       bar</code>
    <code class="c1">#     end</code>
    <code class="c1">#</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="k">def</code> <code class="nf">before</code><code class="p">(</code><code class="o">*</code><code class="n">method_symbols</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">block</code><code class="p">)</code>
      <code class="n">options</code> <code class="o">=</code> <code class="n">method_symbols</code><code class="o">[-</code><code class="mi">1</code><code class="o">].</code><code class="n">kind_of?</code><code class="p">(</code><code class="no">Hash</code><code class="p">)</code> <code class="p">?</code> <code class="n">method_symbols</code><code class="o">.</code><code class="n">pop</code> <code class="p">:</code> <code class="p">{}</code>
      <code class="n">method_symbols</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">method_sym</code><code class="o">|</code>
        <code class="n">__composed_methods__</code><code class="o">[</code><code class="n">method_sym</code><code class="o">].</code><code class="n">before</code><code class="o">.</code><code class="n">unshift</code><code class="p">(</code><code class="n">__unbound_method__</code><code class="p">(\</code>
<code class="n">block</code><code class="p">,</code> <code class="n">options</code><code class="o">[</code><code class="ss">:name</code><code class="o">]</code><code class="p">))</code>
        <code class="n">__rebuild_method__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="c1"># Example:</code>
    <code class="c1">#</code>
    <code class="c1">#   after :foo, :bar do</code>
    <code class="c1">#     # ...</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1"># This executes the body of the block after the #foo and #bar instance \</code>
<code class="nb">methods</code>
    <code class="c1"># for side effects without modifying the return values of the #foo and \</code>
<code class="c1">#bar methods</code>
    <code class="c1">#</code>
    <code class="c1">#   after :fizz, :buzz do |r|</code>
    <code class="c1">#     # ...</code>
    <code class="c1">#     r</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1"># This executes the body of the block after the #foo and #bar instance \</code>
<code class="nb">methods</code>
    <code class="c1"># for side efects, AND determines what is returned from the call. If th\</code>
<code class="n">e</code> <code class="n">block</code>
    <code class="c1"># takes parameters, it acts as a filter, transforming the return value.</code>
    <code class="c1">#</code>
    <code class="c1"># It is possible to chain #after advice, and you can add more advice in\</code>
 <code class="n">subclasses</code><code class="p">:</code>
    <code class="c1">#</code>
    <code class="c1">#   class Foo</code>
    <code class="c1">#     def foo(bar); end</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1">#   class Bar &lt; Foo</code>
    <code class="c1">#     include MethodAdvice</code>
    <code class="c1">#</code>
    <code class="c1">#     after :foo do</code>
    <code class="c1">#       # ...</code>
    <code class="c1">#     end</code>
    <code class="c1">#</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1">#   class Blitz &lt; Bar</code>
    <code class="c1">#     include MethodAdvice</code>
    <code class="c1">#</code>
    <code class="c1">#     after :foo do |r|</code>
    <code class="c1">#       # ...</code>
    <code class="c1">#       r</code>
    <code class="c1">#     end</code>
    <code class="c1">#</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="k">def</code> <code class="nf">after</code><code class="p">(</code><code class="o">*</code><code class="n">method_symbols</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">block</code><code class="p">)</code>
      <code class="n">options</code> <code class="o">=</code> <code class="n">method_symbols</code><code class="o">[-</code><code class="mi">1</code><code class="o">].</code><code class="n">kind_of?</code><code class="p">(</code><code class="no">Hash</code><code class="p">)</code> <code class="p">?</code> <code class="n">method_symbols</code><code class="o">.</code><code class="n">pop</code> <code class="p">:</code> <code class="p">{}</code>
      <code class="n">method_symbols</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">method_sym</code><code class="o">|</code>
        <code class="n">__composed_methods__</code><code class="o">[</code><code class="n">method_sym</code><code class="o">].</code><code class="n">after</code><code class="o">.</code><code class="n">push</code><code class="p">(</code><code class="n">__unbound_method__</code><code class="p">(</code><code class="n">bloc</code><code class="p">\</code>
<code class="n">k</code><code class="p">,</code> <code class="n">options</code><code class="o">[</code><code class="ss">:name</code><code class="o">]</code><code class="p">))</code>
        <code class="n">__rebuild_method__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="c1"># Removes all advice from the named methods. Intended for testing.</code>
    <code class="c1">#</code>
    <code class="k">def</code> <code class="nf">reset_befores_and_afters</code><code class="p">(</code><code class="o">*</code><code class="n">method_symbols</code><code class="p">)</code>
      <code class="n">method_symbols</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">method_sym</code><code class="o">|</code>
        <code class="n">__composed_methods__</code><code class="o">[</code><code class="n">method_sym</code><code class="o">].</code><code class="n">before</code> <code class="o">=</code> <code class="o">[]</code>
        <code class="n">__composed_methods__</code><code class="o">[</code><code class="n">method_sym</code><code class="o">].</code><code class="n">after</code> <code class="o">=</code> <code class="o">[]</code>
        <code class="n">__rebuild_method__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="c1"># Modified to re-apply advice when a method is overridden. So:</code>
    <code class="c1">#</code>
    <code class="c1">#   class Foo</code>
    <code class="c1">#     def foo(bar); end</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1">#   class Bar &lt; Foo</code>
    <code class="c1">#     include MethodAdvice</code>
    <code class="c1">#</code>
    <code class="c1">#     after :foo do</code>
    <code class="c1">#       # ...</code>
    <code class="c1">#     end</code>
    <code class="c1">#</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1">#   class Blitz &lt; Bar</code>
    <code class="c1">#     include MethodAdvice</code>
    <code class="c1">#</code>
    <code class="c1">#     def foo(bar)</code>
    <code class="c1">#       # ...</code>
    <code class="c1">#     end</code>
    <code class="c1">#</code>
    <code class="c1">#   end</code>
    <code class="c1">#</code>
    <code class="c1"># In this case the class Blitz overrides the method #foo, but the advic\</code>
<code class="n">e</code> <code class="k">in</code>
    <code class="c1"># class Bar is still applied, the override happens ONLY on the inner me\</code>
<code class="n">thod</code><code class="p">,</code>
    <code class="c1"># not the advice.</code>
    <code class="c1">#</code>
    <code class="c1"># Note well that super has undefined behaviour in this situation.</code>
    <code class="c1">#</code>
    <code class="k">def</code> <code class="nf">method_added</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code>
      <code class="k">unless</code> <code class="nb">instance_variable_get</code><code class="p">(</code><code class="s2">&quot;@</code><code class="si">#{</code><code class="no">UNIQ</code><code class="si">}</code><code class="s2">_in_method_added&quot;</code><code class="p">)</code>
        <code class="n">__safely__</code> <code class="k">do</code>
          <code class="n">__composed_methods__</code><code class="o">[</code><code class="n">method_sym</code><code class="o">].</code><code class="n">between</code> <code class="o">=</code> <code class="nb">self</code><code class="o">.</code><code class="n">instance_method</code><code class="p">(</code><code class="n">m</code><code class="p">\</code>
<code class="n">ethod_sym</code><code class="p">)</code>
          <code class="vi">@old_method_added</code> <code class="ow">and</code> <code class="vi">@old_method_added</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code>
          <code class="n">__rebuild_method__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code>
        <code class="k">end</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="k">def</code> <code class="nf">__composed_methods__</code>
      <code class="n">ancestral_composer</code> <code class="o">=</code> <code class="nb">ancestors</code><code class="o">.</code><code class="n">detect</code> <code class="p">{</code> <code class="o">|</code><code class="n">ancestor</code><code class="o">|</code> <code class="n">ancestor</code><code class="o">.</code><code class="n">instance_</code><code class="p">\</code>
<code class="n">variable_defined?</code><code class="p">(</code><code class="ss">:@__composed_methods__</code><code class="p">)</code> <code class="p">}</code>
      <code class="k">if</code> <code class="n">ancestral_composer</code>
        <code class="n">ancestral_composer</code><code class="o">.</code><code class="n">instance_variable_get</code><code class="p">(</code><code class="ss">:@__composed_methods__</code><code class="p">)</code>
      <code class="k">else</code>
        <code class="vi">@__composed_methods__</code> <code class="o">||=</code> <code class="no">Hash</code><code class="o">.</code><code class="n">new</code> <code class="p">{</code> <code class="o">|</code><code class="nb">hash</code><code class="p">,</code> <code class="n">method_sym</code><code class="o">|</code> <code class="nb">hash</code><code class="o">[</code><code class="nb">method</code><code class="p">\</code>
<code class="n">_sym</code><code class="o">]</code> <code class="o">=</code> <code class="no">BeforeAndAfterAdvice</code><code class="o">::</code><code class="no">Compositions</code><code class="o">.</code><code class="n">new</code><code class="p">(</code><code class="o">[]</code><code class="p">,</code> <code class="nb">self</code><code class="o">.</code><code class="n">instance_method</code><code class="p">(</code><code class="n">met</code><code class="p">\</code>
<code class="n">hod_sym</code><code class="p">),</code> <code class="o">[]</code><code class="p">)</code> <code class="p">}</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="k">def</code> <code class="nf">__rebuild_without_advice__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">,</code> <code class="n">old_method</code><code class="p">)</code>
      <code class="k">if</code> <code class="n">old_method</code><code class="o">.</code><code class="n">arity</code> <code class="o">==</code> <code class="mi">0</code>
        <code class="n">define_method</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code> <code class="p">{</code> <code class="n">old_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code> <code class="p">}</code>
      <code class="k">else</code>
        <code class="n">define_method</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code> <code class="p">{</code> <code class="o">|*</code><code class="n">params</code><code class="o">|</code> <code class="n">old_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="o">*</code><code class="nb">p</code><code class="p">\</code>
<code class="n">arams</code><code class="p">)</code> <code class="p">}</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="k">def</code> <code class="nf">__rebuild_advising_no_parameters__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">,</code> <code class="n">old_method</code><code class="p">,</code> <code class="n">befores</code><code class="p">,\</code>
 <code class="n">afters</code><code class="p">)</code>
      <code class="n">define_method</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code> <code class="k">do</code>
        <code class="n">befores</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">before_advice_method</code><code class="o">|</code>
          <code class="n">before_advice_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code>
        <code class="k">end</code>
        <code class="n">afters</code><code class="o">.</code><code class="n">inject</code><code class="p">(</code><code class="n">old_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code><code class="p">)</code> <code class="k">do</code> <code class="o">|</code><code class="n">ret_val</code><code class="p">,</code> <code class="n">after_advice</code><code class="p">\</code>
<code class="n">_method</code><code class="o">|</code>
          <code class="n">after_advice_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code>
        <code class="k">end</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="k">def</code> <code class="nf">__rebuild_advising_with_parameters__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">,</code> <code class="n">old_method</code><code class="p">,</code> <code class="n">before</code><code class="p">\</code>
<code class="n">s</code><code class="p">,</code> <code class="n">afters</code><code class="p">)</code>
      <code class="n">define_method</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code> <code class="k">do</code> <code class="o">|*</code><code class="n">params</code><code class="o">|</code>
        <code class="n">afters</code><code class="o">.</code><code class="n">inject</code><code class="p">(</code>
          <code class="n">old_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code><code class="p">(</code>
            <code class="o">*</code><code class="n">befores</code><code class="o">.</code><code class="n">inject</code><code class="p">(</code><code class="n">params</code><code class="p">)</code> <code class="k">do</code> <code class="o">|</code><code class="n">acc_params</code><code class="p">,</code> <code class="n">before_advice_method</code><code class="o">|</code>
              <code class="k">if</code> <code class="n">before_advice_method</code><code class="o">.</code><code class="n">arity</code> <code class="o">==</code> <code class="mi">0</code>
                <code class="n">before_advice_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code>
                <code class="n">acc_params</code>
              <code class="k">else</code>
                <code class="n">before_advice_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="o">*</code><code class="n">acc_params</code><code class="p">)</code>
              <code class="k">end</code>
            <code class="k">end</code>
          <code class="p">)</code>
        <code class="p">)</code> <code class="k">do</code> <code class="o">|</code><code class="n">ret_val</code><code class="p">,</code> <code class="n">after_advice_method</code><code class="o">|</code>
          <code class="k">if</code> <code class="n">after_advice_method</code><code class="o">.</code><code class="n">arity</code> <code class="o">==</code> <code class="mi">0</code>
            <code class="n">after_advice_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code>
            <code class="n">ret_val</code>
          <code class="k">else</code>
            <code class="n">after_advice_method</code><code class="o">.</code><code class="n">bind</code><code class="p">(</code><code class="nb">self</code><code class="p">)</code><code class="o">.</code><code class="n">call</code><code class="p">(</code><code class="n">ret_val</code><code class="p">)</code>
          <code class="k">end</code>
        <code class="k">end</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="k">def</code> <code class="nf">__rebuild_method__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">)</code>
      <code class="n">__safely__</code> <code class="k">do</code>
        <code class="n">composition</code> <code class="o">=</code> <code class="n">__composed_methods__</code><code class="o">[</code><code class="n">method_sym</code><code class="o">]</code>
        <code class="n">old_method</code> <code class="o">=</code> <code class="n">composition</code><code class="o">.</code><code class="n">between</code>
        <code class="k">if</code> <code class="n">composition</code><code class="o">.</code><code class="n">before</code><code class="o">.</code><code class="n">empty?</code> <code class="ow">and</code> <code class="n">composition</code><code class="o">.</code><code class="n">after</code><code class="o">.</code><code class="n">empty?</code>
          <code class="n">__rebuild_without_advice__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">,</code> <code class="n">old_method</code><code class="p">)</code>
        <code class="k">else</code>
          <code class="n">arity</code> <code class="o">=</code> <code class="n">old_method</code><code class="o">.</code><code class="n">arity</code>
          <code class="k">if</code> <code class="n">old_method</code><code class="o">.</code><code class="n">arity</code> <code class="o">==</code> <code class="mi">0</code>
            <code class="n">__rebuild_advising_no_parameters__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">,</code> <code class="n">old_method</code><code class="p">,</code> <code class="n">comp</code><code class="p">\</code>
<code class="n">osition</code><code class="o">.</code><code class="n">before</code><code class="p">,</code> <code class="n">composition</code><code class="o">.</code><code class="n">after</code><code class="p">)</code>
          <code class="k">else</code>
            <code class="n">__rebuild_advising_with_parameters__</code><code class="p">(</code><code class="n">method_sym</code><code class="p">,</code> <code class="n">old_method</code><code class="p">,</code> <code class="n">co</code><code class="p">\</code>
<code class="n">mposition</code><code class="o">.</code><code class="n">before</code><code class="p">,</code> <code class="n">composition</code><code class="o">.</code><code class="n">after</code><code class="p">)</code>
          <code class="k">end</code>
        <code class="k">end</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="k">def</code> <code class="nf">__safely__</code>
      <code class="n">was</code> <code class="o">=</code> <code class="nb">instance_variable_get</code><code class="p">(</code><code class="s2">&quot;@</code><code class="si">#{</code><code class="no">UNIQ</code><code class="si">}</code><code class="s2">_in_method_added&quot;</code><code class="p">)</code>
      <code class="k">begin</code>
        <code class="nb">instance_variable_set</code><code class="p">(</code><code class="s2">&quot;@</code><code class="si">#{</code><code class="no">UNIQ</code><code class="si">}</code><code class="s2">_in_method_added&quot;</code><code class="p">,</code> <code class="kp">true</code><code class="p">)</code>
        <code class="k">yield</code>
      <code class="k">ensure</code>
        <code class="nb">instance_variable_set</code><code class="p">(</code><code class="s2">&quot;@</code><code class="si">#{</code><code class="no">UNIQ</code><code class="si">}</code><code class="s2">_in_method_added&quot;</code><code class="p">,</code> <code class="n">was</code><code class="p">)</code>
      <code class="k">end</code>
    <code class="k">end</code>

    <code class="k">def</code> <code class="nf">__unbound_method__</code><code class="p">(</code><code class="n">a_proc</code><code class="p">,</code> <code class="n">name_prefx</code> <code class="o">=</code> <code class="kp">nil</code><code class="p">)</code>
      <code class="k">begin</code>
        <code class="n">old_critical</code><code class="p">,</code> <code class="no">Thread</code><code class="o">.</code><code class="n">critical</code> <code class="o">=</code> <code class="no">Thread</code><code class="o">.</code><code class="n">critical</code><code class="p">,</code> <code class="kp">true</code>
        <code class="n">n</code> <code class="o">=</code> <code class="mi">0</code>
        <code class="n">n</code> <code class="o">+=</code> <code class="mi">1</code> <code class="k">while</code> <code class="nb">respond_to?</code><code class="p">(</code><code class="n">mname</code><code class="o">=</code><code class="s2">&quot;</code><code class="si">#{</code><code class="n">name_prefx</code> <code class="o">||</code> <code class="s1">&#39;__method_advice&#39;</code><code class="si">}</code><code class="s2">_\</code>
<code class="si">#{</code><code class="n">n</code><code class="si">}</code><code class="s2">&quot;</code><code class="p">)</code>
        <code class="no">MethodAdvice</code><code class="o">.</code><code class="n">module_eval</code><code class="p">{</code> <code class="n">define_method</code><code class="p">(</code><code class="n">mname</code><code class="p">,</code> <code class="o">&amp;</code><code class="n">a_proc</code><code class="p">)</code> <code class="p">}</code>
      <code class="k">ensure</code>
        <code class="no">Thread</code><code class="o">.</code><code class="n">critical</code> <code class="o">=</code> <code class="n">old_critical</code>
      <code class="k">end</code>
      <code class="k">begin</code>
        <code class="no">MethodAdvice</code><code class="o">.</code><code class="n">instance_method</code><code class="p">(</code><code class="n">mname</code><code class="p">)</code>
      <code class="k">ensure</code>
        <code class="no">MethodAdvice</code><code class="o">.</code><code class="n">module_eval</code><code class="p">{</code> <code class="n">remove_method</code><code class="p">(</code><code class="n">mname</code><code class="p">)</code> <code class="p">}</code> <code class="k">unless</code> <code class="n">name_prefx</code> <code class="p">\</code>
<code class="k">rescue</code> <code class="kp">nil</code>
      <code class="k">end</code>
    <code class="k">end</code>

  <code class="k">end</code>

  <code class="k">def</code> <code class="nc">self</code><code class="o">.</code><code class="nf">included</code><code class="p">(</code><code class="n">receiver</code><code class="p">)</code>
    <code class="n">receiver</code><code class="o">.</code><code class="n">extend</code>         <code class="no">ClassMethods</code>
    <code class="n">receiver</code><code class="o">.</code><code class="n">send</code> <code class="ss">:include</code><code class="p">,</code> <code class="no">MethodAdvice</code>
    <code class="n">receiver</code><code class="o">.</code><code class="n">instance_variable_set</code><code class="p">(</code><code class="s2">&quot;@</code><code class="si">#{</code><code class="no">UNIQ</code><code class="si">}</code><code class="s2">_in_method_added&quot;</code><code class="p">,</code> <code class="kp">false</code><code class="p">)</code>
    <code class="n">receiver</code><code class="o">.</code><code class="n">instance_variable_set</code><code class="p">(</code><code class="ss">:@old_method_added</code><code class="p">,</code> <code class="n">receiver</code><code class="o">.</code><code class="n">public_meth</code><code class="p">\</code>
<code class="n">od_defined?</code><code class="p">(</code><code class="ss">:method_added</code><code class="p">)</code> <code class="o">&amp;&amp;</code> <code class="n">receiver</code><code class="o">.</code><code class="n">instance_method</code><code class="p">(</code><code class="ss">:method_added</code><code class="p">))</code>
  <code class="k">end</code>

<code class="k">end</code>
</pre></div>

  <hr />
</div>


      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Copyright 2011-2012 <a href="http://braythwayt.com">Reginald Braithwaite</a></p>
      </footer>
    </div>



  </body>
</html>
